<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generador Informe - Página</title>
  <style>
    :root{
      --accent:#00bcd4;
      --muted:#666;
      --bg:#fafafa;
    }
    body{font-family: Inter, Roboto, Arial, sans-serif; background:var(--bg); margin:0;padding:0;color:#111}
    .container{max-width:1100px;margin:24px auto;padding:20px;background:#fff;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    h1{margin:0 0 12px 0}
    .steps{display:block}
    .step{display:none;margin-top:18px}
    .step.active{display:block}
    label{display:block;margin-bottom:6px;font-weight:600}
    input[type=text], input[type=date], textarea, select{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;box-sizing:border-box}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.05);text-align:left}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.primary{background:var(--accent);color:#042}
    .btn.ghost{background:#eee}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:#666}
    #photoPreviewModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center}
    #photoPreviewModal .modal{background:#fff;padding:12px;border-radius:8px;max-width:900px;width:92%}
    .photo-action-btn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
    .photo-action-btn.upload{background:linear-gradient(90deg,var(--accent),#6efcff);font-weight:700}
    .photo-action-btn.view{background:#fff;border:1px solid rgba(0,0,0,0.06)}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .flex{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Informe - Página</h1>
      <div class="muted">Conexión: <code>/generar</code></div>
    </div>

    <div class="steps">
      <!-- STEP 1: info general -->
      <section id="step-1" class="step active">
        <h3>1 · Información general</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label>Cliente</label>
            <input id="cliente" type="text" placeholder="Nombre cliente" />
          </div>
          <div>
            <label>Fecha</label>
            <input id="fecha" type="date" />
          </div>
          <div>
            <label>RUC</label>
            <input id="ruc" type="text" />
          </div>
          <div>
            <label>Dirección</label>
            <input id="direccion" type="text" />
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn ghost" onclick="prevStep()">← Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente →</button>
        </div>
      </section>

      <!-- STEP 2: tanques -->
      <section id="step-2" class="step">
        <h3>2 · Tanques</h3>
        <div style="margin-bottom:8px">
          <label>Añadir tanque</label>
          <div style="display:flex;gap:8px">
            <input id="tanque_cap" placeholder="Capacidad (gal)" />
            <input id="tanque_serie" placeholder="N° de serie" />
            <button class="btn" onclick="addTanque()">Agregar</button>
          </div>
        </div>
        <div>
          <table id="tanques_table"><thead><tr><th>#</th><th>Capacidad</th><th>Serie</th><th>Acciones</th></tr></thead><tbody></tbody></table>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn ghost" onclick="prevStep()">← Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente →</button>
        </div>
      </section>

      <!-- STEP 3: equipos -->
      <section id="step-3" class="step">
        <h3>3 · Equipos</h3>
        <div style="display:flex;gap:8px">
          <input id="eq_tipo" placeholder="Tipo de equipo" />
          <input id="eq_serie" placeholder="Serie" />
          <button class="btn" onclick="addEquipo()">Agregar</button>
        </div>
        <table id="equipos_table" style="margin-top:8px;"><thead><tr><th>#</th><th>Tipo</th><th>Serie</th><th>Acciones</th></tr></thead><tbody></tbody></table>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn ghost" onclick="prevStep()">← Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente →</button>
        </div>
      </section>

      <!-- STEP 4: observaciones -->
      <section id="step-4" class="step">
        <h3>4 · Observaciones</h3>
        <textarea id="observaciones" rows="4" placeholder="Observaciones generales..." style="width:100%"></textarea>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn ghost" onclick="prevStep()">← Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente →</button>
        </div>
      </section>

      <!-- STEP 5: resumen y generar (irá a step 7) -->
      <section id="step-5" class="step">
        <h3>5 · Resumen</h3>
        <div id="resumen" class="small muted" style="white-space:pre-wrap"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn ghost" onclick="prevStep()">← Anterior</button>
          <div style="flex:1"></div>
          <button id="finalGenerate" class="btn primary" onclick="onFinalGenerate()">Generar Word →</button>
        </div>
      </section>

      <!-- STEP 7: carga fotos -->
      <section id="step-7" class="step">
        <h3>7 · Carga de fotos por subtítulo</h3>
        <div style="margin-top:12px; background:linear-gradient(180deg,#fff,#fbfbfb); padding:12px; border-radius:8px;">
          <table id="photoTable" style="width:100%;border-collapse:collapse;">
            <thead>
              <tr><th style="text-align:left;padding:8px">Subtítulo</th><th style="padding:8px">Cantidad requerida</th><th style="padding:8px">Estatus</th><th style="padding:8px">Acciones</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn ghost" onclick="showStep(5)">← Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" id="step7_generate">Generar Word →</button>
        </div>
      </section>

    </div>
  </div>

  <!-- Modal preview -->
  <div id="photoPreviewModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;">
    <div class="modal" style="background:#fff;padding:12px;border-radius:8px;max-width:900px;width:92%;margin:auto;">
      <h4 id="previewTitle">Previsualizar fotos</h4>
      <div id="previewGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-top:8px;"></div>
      <div style="text-align:right;margin-top:8px;"><button onclick="closePhotoPreview()">Cerrar</button></div>
    </div>
  </div>

<script>
/* step navigation */
let currentStep = 1;
function showStep(n){
  document.querySelectorAll('.step').forEach((el)=> el.classList.remove('active'));
  const el = document.getElementById('step-'+n);
  if(el) el.classList.add('active');
  currentStep = n;
  if(n===5) renderResumen();
}
function nextStep(){ showStep(currentStep+1) }
function prevStep(){ if(currentStep>1) showStep(currentStep-1) }
showStep(1);

/* Data containers */
window.generalInfo = {};
window.tanks = [];
window.equipos = [];

/* Tanques */
function addTanque(){
  const cap = document.getElementById('tanque_cap').value || '-';
  const serie = document.getElementById('tanque_serie').value || '-';
  tanks.push({ "Capacidad (gal)": cap, "N° de serie": serie });
  renderTanques();
}
function removeTanque(i){ tanks.splice(i,1); renderTanques(); }
function renderTanques(){
  const tbody = document.querySelector('#tanques_table tbody');
  tbody.innerHTML = '';
  tanks.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${t["Capacidad (gal)"]}</td><td>${t["N° de serie"]}</td><td><button onclick="removeTanque(${i})">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
}

/* Equipos */
function addEquipo(){
  const tipo = document.getElementById('eq_tipo').value || '-';
  const serie = document.getElementById('eq_serie').value || '-';
  equipos.push({ "Tipo de equipo": tipo, "Serie": serie });
  renderEquipos();
}
function removeEquipo(i){ equipos.splice(i,1); renderEquipos(); }
function renderEquipos(){
  const tbody = document.querySelector('#equipos_table tbody');
  tbody.innerHTML = '';
  equipos.forEach((e,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${e["Tipo de equipo"]}</td><td>${e["Serie"]}</td><td><button onclick="removeEquipo(${i})">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
}

/* Resumen */
function renderResumen(){
  const r = document.getElementById('resumen');
  const cliente = document.getElementById('cliente').value;
  const fecha = document.getElementById('fecha').value;
  const ruc = document.getElementById('ruc').value;
  const direccion = document.getElementById('direccion').value;
  let text = `Cliente: ${cliente}\nFecha: ${fecha}\nRUC: ${ruc}\nDirección: ${direccion}\n\nTanques:\n`;
  tanks.forEach((t,i)=> text += `${i+1}. Serie: ${t["N° de serie"]} - Cap: ${t["Capacidad (gal)"]}\n`);
  text += `\nEquipos:\n`;
  equipos.forEach((e,i)=> text += `${i+1}. ${e["Tipo de equipo"]} - Serie: ${e["Serie"]}\n`);
  r.innerText = text;
}

/* Build payload JSON */
function buildPayload(){
  const general = {
    cliente: document.getElementById('cliente').value || '-',
    fecha: document.getElementById('fecha').value || '-',
    ruc: document.getElementById('ruc').value || '-',
    direccion: document.getElementById('direccion').value || '-'
  };
  const observaciones = { "7.1": document.getElementById('observaciones').value || '-' };
  return {
    general,
    tanques: tanks,
    accesoriosTanque: [],
    accesoriosRed: [],
    equipos: equipos,
    observaciones: observaciones
  };
}

/* When final clicked, show step 7 */
function onFinalGenerate(e){
  buildPhotoSubtitlesFromPage();
  showStep(7);
}

/* STEP 7 - photo management */
window.photoSubtitles = [];
window.photosBySubtitle = {}; // { subId: [File,...] }

function buildPhotoSubtitlesFromPage(){
  photoSubtitles = [];
  photosBySubtitle = {};
  photoSubtitles.push({id:'panoramica', title:'9.1 FOTO PANORÁMICA DE LA ZONA', required:1});
  tanks.forEach((t,i)=>{
    const serie = t["N° de serie"] || '-';
    const id = `tanque_${i+1}`;
    photoSubtitles.push({id, title:`PLACA DE TANQUE ${i+1} - SERIE: ${serie}`, required:1});
    photoSubtitles.push({id: id + '_panoramica', title:`FOTO PANORÁMICA ALREDEDORES TANQUE ${i+1}`, required:4});
  });
  equipos.forEach((eq,i)=>{
    const id = `equipo_${i+1}`;
    photoSubtitles.push({id, title:`FOTO PLACA EQUIPO ${i+1}`, required:1});
  });
  photoSubtitles.forEach(s=> { if(!photosBySubtitle[s.id]) photosBySubtitle[s.id]=[]; });
  renderPhotoTable();
}

function renderPhotoTable(){
  const tbody = document.querySelector('#photoTable tbody');
  tbody.innerHTML = '';
  photoSubtitles.forEach(s=>{
    const uploaded = (photosBySubtitle[s.id] || []).length;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:8px">${s.title}</td><td style="padding:8px">${s.required}</td><td style="padding:8px">${uploaded}/${s.required}</td><td style="padding:8px"><button class="photo-action-btn upload" onclick="openFileDialog('${s.id}')">Subir</button> <button class="photo-action-btn view" onclick="openPhotoPreview('${s.id}')">Ver</button></td>`;
    tbody.appendChild(tr);
  });
}

function openFileDialog(subId){
  const input = document.createElement('input');
  input.type='file';
  input.accept='image/*';
  input.multiple=true;
  input.onchange = (e) => handleFilesSelected(subId, e.target.files);
  input.click();
}

function handleFilesSelected(subId, fileList){
  if(!photosBySubtitle[subId]) photosBySubtitle[subId]=[];
  for(let i=0;i<fileList.length;i++){
    photosBySubtitle[subId].push(fileList[i]);
  }
  renderPhotoTable();
}

function openPhotoPreview(subId){
  const modal = document.getElementById('photoPreviewModal');
  const grid = document.getElementById('previewGrid');
  const title = document.getElementById('previewTitle');
  grid.innerHTML = '';
  const arr = photosBySubtitle[subId] || [];
  title.innerText = `Previsualizar — ${subId} (${arr.length})`;
  if(arr.length===0) grid.innerHTML = '<div style="padding:12px">No hay imágenes</div>';
  arr.forEach((f,idx)=>{
    const url = URL.createObjectURL(f);
    const card = document.createElement('div');
    card.innerHTML = `<img src="${url}" style="width:100%;height:120px;object-fit:cover;border-radius:6px"/><div style="text-align:center;margin-top:6px"><button onclick="removePhoto('${subId}',${idx})">Eliminar</button></div>`;
    grid.appendChild(card);
  });
  modal.style.display = 'flex';
}

function closePhotoPreview(){ document.getElementById('photoPreviewModal').style.display='none'; }

function removePhoto(subId, idx){
  photosBySubtitle[subId].splice(idx,1);
  renderPhotoTable();
  openPhotoPreview(subId);
}

/* Build FormData and POST to /generar */
async function handleGenerateWithPhotos(){
  const payload = buildPayload();
  const fd = new FormData();
  fd.append('json', JSON.stringify(payload));
  Object.keys(photosBySubtitle).forEach(subId=>{
    const arr = photosBySubtitle[subId] || [];
    arr.forEach((file, idx)=>{
      const filename = `${subId}__${idx}__${file.name}`;
      fd.append('files', file, filename);
    });
  });
  try{
    const resp = await fetch('/generar', { method: 'POST', body: fd });
    if(!resp.ok){
      const err = await resp.json().catch(()=>({error:'error'}));
      alert('Error generando documento: ' + (err.error || JSON.stringify(err)));
      return;
    }
    const blob = await resp.blob();
    const cd = resp.headers.get('content-disposition') || '';
    let filename = 'Informe_Mantenimiento.docx';
    if(cd && cd.indexOf('filename=')!==-1) filename = cd.split('filename=')[1].replace(/"/g,'').trim();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    alert('Documento generado y descargado');
  }catch(e){
    console.error(e);
    alert('Error de red: ' + e.message);
  }
}

document.addEventListener('DOMContentLoaded', function(){
  const step7_generate = document.getElementById('step7_generate');
  if(step7_generate) step7_generate.addEventListener('click', (e)=>{ e.preventDefault(); handleGenerateWithPhotos(); });
  setTimeout(()=>{ try{ buildPhotoSubtitlesFromPage(); }catch(e){} }, 200);
});
</script>
</body>
</html>
