<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solgas ¬∑ Inspecci√≥n GLP</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg-1:#030419;
  --bg-2:#042133;
  --accent:#00d2ff;
  --gold:#f6b73c;
  --card:#071827;
  --input-bg:#ffffff;
  --muted:#9fdcff;
  --label:#2b2b2b;
  --input-text-dark:#041018;
  --danger:#ff6b6b;
  --radius:12px;
  --glass: rgba(255,255,255,0.03);
  --panel:#071827;
  --light-card-bg:#f7fbff;
}
*{box-sizing:border-box;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#e6f7ff}
html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:24px auto;padding:18px;border-radius:14px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:800;box-shadow:0 10px 30px rgba(0,194,255,0.07)}
.title{font-size:20px;margin:0}
.lead{color:var(--muted);font-size:13px;margin:0}

/* PROGRESS BAR (fixed top) */
#topProgressWrap{position:fixed;left:0;right:0;top:0;height:8px;background:rgba(255,255,255,0.06);z-index:120;border-bottom:1px solid rgba(255,255,255,0.02)}
#topProgress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--gold));transition:width .3s ease}

/* layout */
.app{display:grid;grid-template-columns:320px 1fr;gap:18px;padding-top:12px}
/* sidebar */
.sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03)}
.userbox{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.user-company{font-weight:700;color:#eafcff}
.navlist{margin-top:8px}
.nav-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .12s}
.nav-item.disabled{opacity:.45;cursor:not-allowed}
.nav-item.active{background:linear-gradient(90deg, rgba(0,194,255,0.06), rgba(246,183,60,0.03)); border:1px solid rgba(0,194,255,0.08)}
.status{font-size:13px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted)}

/* main */
.main{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.02)}
.step{display:none}
.step.active{display:block; animation:fadeIn .26s ease both}
@keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.card-title{font-weight:700; color:var(--accent)}
.hint{font-size:13px;color:var(--muted);opacity:.95}

/* fields */
.row{display:grid;gap:10px}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:1fr 1fr 1fr}
.field{background:var(--input-bg); border-radius:10px; padding:8px; display:flex; align-items:center; gap:8px; border:1px solid rgba(0,0,0,0.06)}
.field input, .field textarea, .field select{border:none;background:transparent;width:100%;outline:none;color:var(--input-text-dark);font-size:14px}
.label{font-size:12px;color:var(--accent);margin-bottom:6px;font-weight:700}
.small{font-size:12px;color:var(--muted)}

/* buttons */
.controls{display:flex;gap:10px;margin-top:12px;align-items:center}
.btn{padding:10px 14px;border-radius:999px;border:none;font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent), #6efcff); color:#041018; box-shadow:0 14px 40px rgba(0,194,255,0.08)}
.btn.ghost{background:#ffffff;border:1px solid rgba(0,0,0,0.06); color:#041018}
.btn.warn{background:linear-gradient(90deg,var(--gold), #ffd36b); color:#081017}
.btn.danger{background:var(--danger); color:#041018}
.btn.small{padding:6px 10px;border-radius:8px;font-weight:600}

/* lists */
.list{margin-top:8px}
.tank-card{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.18)); border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,0.02); margin-bottom:10px; display:flex;justify-content:space-between;align-items:center}
.tank-info{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;width:85%}
.tank-actions{display:flex;gap:8px;align-items:center}

/* modal (accessories edit) */
.modal-back{position:fixed;inset:0;background:rgba(2,6,10,0);display:none;align-items:center;justify-content:center;z-index:60;padding:20px}
.modal-back.active{display:flex ; color: #041018 }
.modal{background:#ffffff;border-radius:12px;width:980px;max-width:98%;padding:16px;color:#041018;box-shadow:0 18px 50px rgba(2,6,20,0)}
.modal h3{margin:0 0 8px 0 ; color : var(--accent) }
.modal .field input{color:#041018}

/* modal table */
.acc-table{width:100%;border-collapse:collapse;margin-top:8px}
.acc-table th,.acc-table td{border:1px solid #ddd;padding:6px;text-align:center}
.acc-table th{background:#f3f3f3;color:#041018;font-weight:700}

/* invalid */
.invalid{border-color:#ff5b6b !important; box-shadow:0 6px 24px rgba(255,91,107,0.07)}
.errlist{color:#ff9aa2; margin-top:8px; font-weight:700}

/* accessory badges */
.badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:700;color:var(--muted);font-size:12px}

/* inline actions */
.inline-actions{display:flex;gap:8px;align-items:center}

/* select styling for good contrast */
select.custom-select{background:#ffffff;color:#041018;padding:8px;border-radius:8px;border:1px solid #cfeef8;outline:none}
select.custom-select option{color:#041018;background:#ffffff}

/* contrast input text on dark mini cards */
.card-dark{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.18));padding:10px;border-radius:8px;color:#ffffff}

/* accessory header dark */
.acc-header{font-weight:800;color:#041018;background:#f3f3f3;padding:8px;border-radius:8px;display:inline-block;margin-bottom:8px}

/* responsive */
@media (max-width:980px){ .app{grid-template-columns:1fr} .tank-info{grid-template-columns:repeat(2,1fr);width:60%} }

/* LOGIN overlay */
#loginOverlay{position:fixed;inset:0;background:linear-gradient(160deg,var(--bg-1),var(--bg-2));display:flex;align-items:center;justify-content:center;z-index:200}
#loginCard{width:520px;max-width:95%;background:#ffffff;border-radius:12px;padding:20px;color:#041018;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.login-title{font-weight:800;font-size:20px;margin-bottom:6px ; color:#6b7280 }
.login-sub{color:#6b7280;margin-bottom:12px}
.login-field .field{background:#f3f7fb}
.login-err{color:var(--danger);margin-top:10px;font-weight:700}

/* ensure modal inputs and table texts are dark on white background */
.modal input, .modal select, .modal textarea { color: #041018; background: #fff; border:1px solid #e6eef3; padding:6px; border-radius:6px }

/* ensure acc-list table contrast */
#acc-list table th, #acc-list table td {color:var(--accent) }
#acc-list input { color:#041018; background:#fff; border:1px solid #e6eef3; padding:6px; border-radius:6px; width:100% }

td.accesorio {
	color : #041018 !important;
}

/* photo grid & table base (we'll build the dynamic table later) */
.photo-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; margin-top:12px }
.photo-card { background:#ffffff; color:#041018; border-radius:10px; padding:8px; border:1px solid #e6eef3; display:flex; flex-direction:column; gap:8px; align-items:flex-start }
.photo-preview { width:100%; height:140px; object-fit:cover; border-radius:6px; border:1px solid #cfeef8; background:#f6fbff }
.small-muted { font-size:12px; color:#6b7280 }

/* PHOTO TABLE STYLES (used in step 7) */
.photo-table { width:100%; border-collapse:collapse; margin-top:8px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border-radius:8px; overflow:hidden; }
.photo-table th, .photo-table td { padding:10px 12px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.03); font-size:13px; color: #e6f7ff; }
.photo-table thead th { background: linear-gradient(90deg,var(--accent),var(--gold)); color:#041018; font-weight:700; }
.photo-table tbody tr.disabled { opacity:0.45; }
.badge-state { padding:6px 10px; border-radius:999px; font-weight:700; display:inline-block; min-width:64px; text-align:center; }
.badge-red { background: var(--danger); color:#041018; }
.badge-yellow { background: var(--gold); color:#041018; }
.badge-green { background: linear-gradient(90deg,var(--accent), #6efcff); color:#041018; }
.photo-action { display:flex; gap:8px; align-items:center; }
.photo-count { font-weight:700; color:var(--muted); }
.file-input-hidden { display:none; }
.photo-row-title { font-weight:700; color:#ffffff; }
.photo-row-sub { font-size:12px; color:var(--muted); }
@media (max-width:980px){ .photo-table th, .photo-table td { font-size:12px; padding:8px } }

</style>
</head>
<body>
  <!-- Top progress bar -->
  <div id="topProgressWrap"><div id="topProgress"></div></div>

  <!-- Login overlay -->
  <div id="loginOverlay" role="dialog" aria-modal="true">
    <div id="loginCard">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:800">SG</div>
        <div>
          <div class="login-title">Acceso - SOLGAS</div>
          <div class="login-sub">Ingresa con tu correo corporativo y el nombre de empresa.</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="label">Correo corporativo</div>
        <div class="login-field field"><input id="loginEmail" type="email" placeholder="usuario@solgas.com.pe"></div>

        <div class="label" style="margin-top:8px">Empresa</div>
        <div class="login-field field"><input id="loginCompany" type="text" placeholder="Solgas"></div>

        <div class="login-err" id="loginErr" style="display:none"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn ghost" onclick="loginCancel()">Salir</button>
          <button class="btn primary" id="loginBtn" onclick="doLogin()">Ingresar</button>
        </div>
      </div>
    </div>
  </div>

<div class="container" id="mainContainer" style="display:block;margin-top:18px">
  <div class="header">
    <div class="logo">SOLGAS</div>
    <div>
      <div class="title">Solgas ¬∑ Inspecci√≥n GLP</div>
      <div class="lead">Formulario interactivo ‚Äî completa paso a paso y genera el informe Word</div>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
      <button class="btn ghost" id="downloadTemplateBtn">Plantilla</button>
      <button class="btn primary" id="btnGenerate" onclick="showStep(7)">Generar Word</button>
    </div>
  </div>

  <div id="app" class="app" style="display:block; margin-top:10px">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="userbox">
        <div style="width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:700" id="userInitials">SG</div>
        <div>
          <div id="sidebarCompany" class="user-company">Empresa</div>
          <div id="sidebarEmail" class="small">correo@dominio.com</div>
        </div>
      </div>

      <div style="font-weight:700;color:var(--muted);margin-bottom:8px">Secciones</div>
      <div id="navlist" class="navlist">
        <div class="nav-item active" data-step="1" onclick="navTo(1)">
          <div>1 ¬∑ Informaci√≥n general</div>
          <div class="status" id="status-1">Obligatorio</div>
        </div>
        <div class="nav-item" data-step="2" onclick="navTo(2)">
          <div>2 ¬∑ Tanques</div>
          <div class="status" id="status-2">0 tanques</div>
        </div>
        <div class="nav-item" data-step="3" onclick="navTo(3)">
          <div>3 ¬∑ Accesorios por tanque</div>
          <div class="status" id="status-3">‚Äî</div>
        </div>
        <div class="nav-item" data-step="4" onclick="navTo(4)">
          <div>4 ¬∑ Accesorios en redes</div>
          <div class="status" id="status-4">‚Äî</div>
        </div>
        <div class="nav-item" data-step="5" onclick="navTo(5)">
          <div>5 ¬∑ Equipos</div>
          <div class="status" id="status-5">‚Äî</div>
        </div>
        <div class="nav-item" data-step="6" onclick="navTo(6)">
          <div>6 ¬∑ Observaciones & Final</div>
          <div class="status" id="status-6">‚Äî</div>
        </div>
        <div class="nav-item" data-step="7" onclick="navTo(7)">
          <div>7 ¬∑ Carga de fotos</div>
          <div class="status" id="status-7">‚Äî</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn primary" onclick="showStep(7)">üì§ Ir a Fotos</button>
        <button class="btn ghost" onclick="resetApp()">Reiniciar</button>
      </div>

      <div style="margin-top:12px;font-size:13px;color:var(--muted)">Progreso: <span id="progressLabel">0 / 7</span></div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- STEP 1 -->
      <section id="step-1" class="step active">
        <div class="card-header">
          <div>
            <div class="card-title">1 ¬∑ Informaci√≥n general por instalaci√≥n</div>
            <div class="hint">Completa los 11 campos obligatorios para continuar.</div>
          </div>
          <div><span class="hint">Paso 1 / 7</span></div>
        </div>

        <div class="row cols-3">
          <div>
            <div class="label">Nombre o raz√≥n social del cliente *</div>
            <div class="field"><input id="g_nombre" type="text" placeholder=""></div>
          </div>
          <div>
            <div class="label">Fecha de inspecci√≥n *</div>
            <div class="field"><input id="g_fecha" type="date" placeholder=""></div>
          </div>
          <div>
            <div class="label">Direcci√≥n *</div>
            <div class="field"><input id="g_direccion" type="text"></div>
          </div>

          <div>
            <div class="label">RUC o DNI *</div>
            <div class="field"><input id="g_ruc" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">N√∫mero de instalaci√≥n *</div>
            <div class="field"><input id="g_numinst" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">Distrito *</div>
            <div class="field"><input id="g_distrito" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">Departamento *</div>
            <div class="field"><input id="g_departamento" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">Coordenadas *</div>
            <div class="field"><input id="g_coordenadas" type="text" placeholder="lat, lon"></div>
          </div>

          <div>
            <div class="label">Nombre del contacto *</div>
            <div class="field"><input id="g_contacto" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">N√∫mero del contacto *</div>
            <div class="field"><input id="g_telefono" type="text" placeholder=""></div>
          </div>

          <div style="grid-column:1/-1">
            <div class="label">Correo de contacto *</div>
            <div class="field"><input id="g_correo" type="email" placeholder=""></div>
          </div>
        </div>

        <div id="err-step-1" class="errlist"></div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="saveGeneral(true)">Guardar</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

      <!-- STEP 2: Tanques -->
      <section id="step-2" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">2 ¬∑ Tanques inspeccionados</div>
            <div class="hint">Agrega los tanques en el formulario ‚Äî el n√∫mero se asigna autom√°ticamente.</div>
          </div>
          <div><span class="hint">Paso 2 / 7</span></div>
        </div>

        <!-- Inline form para a√±adir/editar tanque -->
        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div style="min-width:160px;">
              <div class="label">N¬∞ de serie *</div>
              <div class="field"><input id="tank_serie" type="text" placeholder="Serie del tanque"></div>
            </div>

            <div style="min-width:120px;">
              <div class="label">Capacidad (gal)</div>
              <div class="field"><input id="tank_capacidad" type="text" placeholder="p. ej. 120"></div>
            </div>

            <div style="min-width:120px;">
              <div class="label">A√±o de fabricaci√≥n</div>
              <div class="field"><input id="tank_anio" type="number" min="1900" max="2099" placeholder=""></div>
            </div>

            <div style="min-width:160px;">
              <div class="label">Tipo (A√©reo / Soterrado / M√≥vil) *</div>
              <div class="field">
                <select id="tank_tipo" class="custom-select">
                  <option value="">-- seleccionar --</option>
                  <option value="A√©reo">A√©reo</option>
                  <option value="Soterrado">Soterrado</option>
                  <option value="M√≥vil">M√≥vil</option>
                </select>
              </div>
            </div>

            <div style="min-width:160px;">
              <div class="label">Fabricante</div>
              <div class="field"><input id="tank_fabricante" type="text" placeholder=""></div>
            </div>

            <div style="min-width:120px;">
              <div class="label">% Actual</div>
              <div class="field"><input id="tank_porcentaje" type="text" placeholder=""></div>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px">
              <button id="saveTankBtn" class="btn primary" onclick="saveTank()">Agregar / Guardar</button>
              <button class="btn ghost" onclick="clearTankForm()">Limpiar</button>
            </div>
          </div>
          <div id="err-tank" class="errlist" style="margin-top:8px"></div>
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px">
          <button class="btn ghost" onclick="clearTanks()">Limpiar todos los tanques</button>
          <div class="small" style="margin-left:auto">Despu√©s de guardar un tanque puedes editar sus accesorios.</div>
        </div>

        <div id="tanksList" class="list"></div>

        <div id="err-step-2" class="errlist"></div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

      <!-- STEP 3: Accesorios por tanque -->
      <section id="step-3" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">3 ¬∑ Accesorios por tanque</div>
            <div class="hint">Selecciona un tanque y llena sus accesorios. Las v√°lvulas opcionales aparecen solo si activas su checkbox.</div>
          </div>
          <div><span class="hint">Paso 3 / 7</span></div>
        </div>

        <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px">
          <div style="min-width:260px">
            <div class="label">Seleccionar tanque *</div>
            <div class="field">
              <select id="select_tanque" class="custom-select">
                <option value="">-- seleccionar tanque --</option>
              </select>
            </div>
          </div>

          <div style="margin-left:auto; display:flex;gap:8px">
            <button class="btn small ghost" onclick="openAccModalFromStep3()">Editar accesorios</button>
          </div>
        </div>

        <div id="accTankArea">
          <div class="acc-header" id="acc-titulo">Accesorio del tanque ‚Äî</div>
          <div class="small" style="margin-bottom:10px">Rellena Marca / C√≥digo / Serie / Mes/A√±o de fabricaci√≥n. Si no se completan aparecer√° un gui√≥n en el informe.</div>

          <div id="acc-list"></div>

          <div style="margin-top:10px">
            <label style="font-weight:700;color:var(--muted)">Opcionales (activa para a√±adir)</label>
            <div style="display:flex;gap:12px;margin-top:6px">
              <label><input type="checkbox" id="opt_exceso_retorno"> V√°lvula exceso de flujo (Retorno)</label>
              <label><input type="checkbox" id="opt_exceso_bypass"> V√°lvula exceso de flujo (Bypass)</label>
              <label><input type="checkbox" id="opt_val3"> Val 3</label>
            </div>
          </div>
        </div>

        <div id="err-step-3" class="errlist"></div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

<!-- NOTE: Parte 1 termina aqu√≠. En la PARTE 2/3 incluir√© STEP 4 (redes), STEP 5 (equipos) y la estructura de actividades din√°micas en el frontend (gesti√≥n UI para agregar actividades por tanque y redes). 
En PARTE 3/3 incluir√© STEP 6 (observaciones), STEP 7 (tabla din√°mica de fotos integrada con previews y subida ANTES/DESPU√âS por actividad), todo el JS de env√≠o final (generate Word) ajustado al servidor.py que me diste, y la integraci√≥n para redimensionar / recortar im√°genes a 15x10 cm antes de enviar (cliente) y las llamadas al backend (/bloques_fotos, /generate_docx).
-->
    <!-- STEP 4: Accesorios en redes -->
      <section id="step-4" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">4 ¬∑ Accesorios en redes</div>
            <div class="hint">Agrega accesorios en redes. Selecciona el tipo (amigable) ‚Äî se enviar√° el tipo interno esperado por el servidor.</div>
          </div>
          <div><span class="hint">Paso 4 / 7</span></div>
        </div>

        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div style="min-width:260px;">
              <div class="label">Tipo de accesorio *</div>
              <div class="field">
                <select id="red_tipo" class="custom-select">
                  <option value="">-- seleccionar --</option>
                  <option value="llenado_toma_desplazada">V√°lvula de llenado de toma desplazada</option>
                  <option value="retorno_toma_desplazada">V√°lvula de retorno de toma desplazada</option>
                  <option value="alivio_hidrostatico">V√°lvula de alivio hidrost√°tico</option>
                  <option value="regulador_primera_etapa">Regulador de primera etapa</option>
                  <option value="alivio">V√°lvula de alivio</option>
                  <option value="regulador_2da">Regulador de segunda etapa</option>
                  <option value="pull_away">V√°lvula Pull Away</option>
                  <option value="zona_medidores">Zona de medidores (Tiene / No)</option>
                </select>
              </div>
            </div>

            <div style="min-width:160px;">
              <div class="label">Marca</div>
              <div class="field"><input id="red_marca" type="text"></div>
            </div>

            <div style="min-width:160px;">
              <div class="label">Serie</div>
              <div class="field"><input id="red_serie" type="text"></div>
            </div>

            <div style="min-width:160px;">
              <div class="label">C√≥digo</div>
              <div class="field"><input id="red_codigo" type="text"></div>
            </div>

            <div style="min-width:200px;">
              <div class="label">Mes/A√±o de fabricaci√≥n</div>
              <div class="field"><input id="red_mesano" type="text" placeholder="MM/YYYY"></div>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px">
              <button class="btn primary" onclick="addRed()">Agregar</button>
              <button class="btn ghost" onclick="clearRedForm()">Limpiar</button>
            </div>
          </div>

          <div id="zonaMedidoresControls" style="display:none;margin-top:8px">
            <div class="label">Zona de medidores</div>
            <div style="display:flex;gap:12px;align-items:center">
              <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="zona_med" value="true"> Tiene</label>
              <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="zona_med" value="false"> No tiene</label>
            </div>
          </div>
        </div>

        <div>
          <div class="label" style="margin-bottom:6px">Lista de accesorios en redes</div>
          <div id="redList"></div>
        </div>

        <div style="margin-top:12px">
          <div class="card-header" style="margin-top:6px">
            <div>
              <div class="card-title">Actividades en redes (10.X)</div>
              <div class="hint">Agrega actividades realizadas en las redes (llenado/retorno o consumo). Cada actividad tendr√° fotos ANTES y DESPU√âS.</div>
            </div>
            <div><span class="hint">Din√°mico</span></div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <div style="min-width:240px">
              <div class="label">Seleccionar red</div>
              <div class="field">
                <select id="select_red_for_activity" class="custom-select">
                  <option value="">-- seleccionar --</option>
                  <option value="red_llenado_retorno">Red de llenado/retorno</option>
                  <option value="red_consumo">Red de consumo</option>
                </select>
              </div>
            </div>
            <div style="flex:1">
              <div class="label">Descripci√≥n actividad</div>
              <div class="field"><input id="activity_red_desc" type="text" placeholder="Descripci√≥n (p.ej. Reparaci√≥n sello)"></div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn primary" onclick="addActivityToRed()">Agregar Actividad</button>
            </div>
          </div>

          <div id="activitiesRedList" class="list"></div>
        </div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

      <!-- STEP 5: Equipos de la instalaci√≥n -->
      <section id="step-5" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">5 ¬∑ Equipos de la instalaci√≥n</div>
            <div class="hint">Agrega equipos ‚Äî el nombre "Equipo" se genera autom√°ticamente (Vaporizador1, Quemador1...).</div>
          </div>
          <div><span class="hint">Paso 5 / 7</span></div>
        </div>

        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="min-width:220px">
              <div class="label">Tipo de equipo *</div>
              <div class="field">
                <select id="eq_tipo" class="custom-select">
                  <option value="">-- seleccionar --</option>
                  <option value="vaporizador">Vaporizador</option>
                  <option value="quemador">Quemador</option>
                  <option value="decantador">Decantador</option>
                  <option value="dispensador_de_gas">Dispensador de gas</option>
                  <option value="bomba">Bomba</option>
                  <option value="tablero">Tablero</option>
                  <option value="estabilizador">Estabilizador</option>
                  <option value="detector">Detector</option>
                  <option value="extintor">Extintor</option>
                </select>
              </div>
            </div>

            <div style="min-width:220px">
              <div class="label">Equipo (generado) </div>
              <div class="field"><input id="eq_name" type="text" disabled></div>
            </div>

            <div id="dynamicFields" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div>

            <div style="margin-left:auto;display:flex;gap:8px">
              <button class="btn primary" onclick="addEquipo()">Agregar Equipo</button>
              <button class="btn ghost" onclick="clearEquipoForm()">Limpiar</button>
            </div>
          </div>
        </div>

        <div>
          <div class="label">Lista de equipos</div>
          <div id="equiposList"></div>
        </div>

        <div style="margin-top:12px">
          <div class="card-header" style="margin-top:6px">
            <div>
              <div class="card-title">Actividades por equipo (opcional)</div>
              <div class="hint">Si realizas trabajos sobre un equipo espec√≠fico, a√±ade la actividad aqu√≠.</div>
            </div>
            <div><span class="hint">Din√°mico</span></div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <div style="min-width:240px">
              <div class="label">Seleccionar equipo</div>
              <div class="field">
                <select id="select_eq_for_activity" class="custom-select">
                  <option value="">-- seleccionar equipo --</option>
                </select>
              </div>
            </div>
            <div style="flex:1">
              <div class="label">Descripci√≥n actividad</div>
              <div class="field"><input id="activity_eq_desc" type="text" placeholder="Descripci√≥n actividad"></div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn primary" onclick="addActivityToEquipo()">Agregar Actividad</button>
            </div>
          </div>

          <div id="activitiesEquipoList" class="list"></div>
        </div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

<!-- Modal para actividades (edici√≥n detallada) -->
<div id="modalActivity" class="modal-back" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalActivityTitle">Editar actividad</h3>
    <div id="modalActivityContent">
      <div class="label">Descripci√≥n</div>
      <div class="field"><input id="modal_activity_desc" type="text"></div>
      <div style="margin-top:10px">
        <div class="label">Fotos ANTES</div>
        <input id="modal_activity_files_before" type="file" accept="image/*" multiple>
        <div style="margin-top:8px" id="modal_before_preview"></div>
      </div>
      <div style="margin-top:10px">
        <div class="label">Fotos DESPU√âS</div>
        <input id="modal_activity_files_after" type="file" accept="image/*" multiple>
        <div style="margin-top:8px" id="modal_after_preview"></div>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" onclick="closeActivityModal()">Cancelar</button>
      <button class="btn primary" onclick="saveActivityModal()">Guardar</button>
    </div>
  </div>
</div>

<!-- Scripts: redes, equipos y actividades (parte 2) -->
<script>
/* -------------------------
   STATE (continuaci√≥n de PARTE 1)
   ------------------------- */
let actividades = {
  // estructura: { "tank1": [ {descripcion, antesFiles:[], despuesFiles:[]}, ... ], "red_llenado_retorno": [...], "equipo_1": [...] }
};

/* -------------------------
   REDES: funciones (se integran con la parte 1)
   ------------------------- */
function clearRedForm(){
  document.getElementById('red_tipo').value = '';
  document.getElementById('red_marca').value = '';
  document.getElementById('red_serie').value = '';
  document.getElementById('red_codigo').value = '';
  document.getElementById('red_mesano').value = '';
  document.querySelectorAll('input[name="zona_med"]').forEach(r => r.checked = false);
  document.getElementById('zonaMedidoresControls').style.display = 'none';
}

document.getElementById('red_tipo').addEventListener('change', function(){
  const v = this.value;
  if(v === 'zona_medidores'){
    document.getElementById('zonaMedidoresControls').style.display = 'block';
  } else {
    document.getElementById('zonaMedidoresControls').style.display = 'none';
  }
});

function addRed(){
  const tipo = document.getElementById('red_tipo').value;
  if(!tipo){ alert('Selecciona tipo de accesorio'); return; }
  if(tipo === 'zona_medidores'){
    const sel = document.querySelector('input[name="zona_med"]:checked');
    if(!sel){ alert('Selecciona Tiene / No tiene para zona de medidores'); return; }
    zona_medidores_val = sel.value === 'true';
    redes = redes.filter(r => r.Tipo !== 'zona_medidores');
    redes.push({"Tipo": "zona_medidores", "Marca":"", "Serie":"", "C√≥digo": zona_medidores_val ? "True" : "False", "Mes/A√±o de fabricaci√≥n": ""});
    renderRedList();
    clearRedForm();
    return;
  }
  const obj = {
    "Tipo": tipo,
    "Marca": document.getElementById('red_marca').value.trim() || '',
    "Serie": document.getElementById('red_serie').value.trim() || '',
    "C√≥digo": document.getElementById('red_codigo').value.trim() || '',
    "Mes/A√±o de fabricaci√≥n": document.getElementById('red_mesano').value.trim() || ''
  };
  redes.push(obj);
  renderRedList();
  clearRedForm();
}

function renderRedList(){
  const c = document.getElementById('redList');
  c.innerHTML = '';
  if(redes.length === 0){ c.innerHTML = '<div class="small">No hay accesorios en redes agregados.</div>'; return; }
  redes.forEach((r,i) => {
    const div = document.createElement('div');
    div.className = 'tank-card';
    div.style.display = 'flex'; div.style.justifyContent='space-between';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700;color:#fff">${i+1}. ${humanReadableTipo(r.Tipo)}</div>
                      <div style="color:#dff9ff;margin-top:6px">${(r.Marca||'-')} ‚Äî ${(r.Serie||'-')} ‚Äî ${(r.C√≥digo||'-')}</div>`;
    const right = document.createElement('div');
    right.innerHTML = `<div style="display:flex;gap:8px">
      <button class="btn small ghost" onclick="editRed(${i})">Editar</button>
      <button class="btn small danger" onclick="deleteRed(${i})">Borrar</button>
    </div>`;
    div.appendChild(left); div.appendChild(right);
    c.appendChild(div);
  });
}
function editRed(i){
  const r = redes[i];
  if(!r) return;
  document.getElementById('red_tipo').value = r.Tipo;
  document.getElementById('red_marca').value = r.Marca || '';
  document.getElementById('red_serie').value = r.Serie || '';
  document.getElementById('red_codigo').value = r.C√≥digo || '';
  document.getElementById('red_mesano').value = r["Mes/A√±o de fabricaci√≥n"] || '';
  redes.splice(i,1);
  renderRedList();
}
function deleteRed(i){
  if(!confirm('Eliminar accesorio en red?')) return;
  redes.splice(i,1);
  renderRedList();
}

/* -------------------------
   ACTIVIDADES: UI & l√≥gica
   ------------------------- */
function addActivityToRed(){
  const redKey = document.getElementById('select_red_for_activity').value;
  const desc = (document.getElementById('activity_red_desc').value || '').trim();
  if(!redKey || !desc){ alert('Selecciona red e ingresa descripci√≥n.'); return; }
  actividades[redKey] = actividades[redKey] || [];
  actividades[redKey].push({descripcion: desc, antesFiles: [], despuesFiles: []});
  document.getElementById('activity_red_desc').value = '';
  renderActivitiesRed();
}

function renderActivitiesRed(){
  const c = document.getElementById('activitiesRedList');
  c.innerHTML = '';
  const keyOrder = ['red_llenado_retorno','red_consumo'];
  keyOrder.forEach(k=>{
    const arr = actividades[k] || [];
    arr.forEach((act, idx) => {
      const div = document.createElement('div');
      div.className = 'tank-card';
      div.style.display='flex'; div.style.justifyContent='space-between';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700;color:#fff">${humanReadableTipo(k)} ‚Äî Actividad ${idx+1}</div>
                        <div style="color:#dff9ff;margin-top:6px">${act.descripcion}</div>`;
      const right = document.createElement('div');
      right.innerHTML = `<div style="display:flex;gap:6px">
        <button class="btn small ghost" onclick="openActivityModal('${k}', ${idx})">Editar</button>
        <button class="btn small danger" onclick="deleteActivity('${k}', ${idx})">Borrar</button>
      </div>`;
      div.appendChild(left); div.appendChild(right);
      c.appendChild(div);
    });
  });
}

function addActivityToEquipo(){
  const sel = document.getElementById('select_eq_for_activity');
  const eqKey = sel.value;
  const desc = (document.getElementById('activity_eq_desc').value || '').trim();
  if(!eqKey || !desc){ alert('Selecciona equipo e ingresa descripci√≥n.'); return; }
  actividades[eqKey] = actividades[eqKey] || [];
  actividades[eqKey].push({descripcion: desc, antesFiles: [], despuesFiles: []});
  document.getElementById('activity_eq_desc').value = '';
  renderActivitiesEquipo();
}

function renderActivitiesEquipo(){
  const c = document.getElementById('activitiesEquipoList');
  c.innerHTML = '';
  Object.keys(actividades).filter(k=>k.startsWith('equipo_')).forEach(k=>{
    const arr = actividades[k];
    arr.forEach((act, idx) => {
      const div = document.createElement('div');
      div.className = 'tank-card';
      div.style.display='flex'; div.style.justifyContent='space-between';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700;color:#fff">${k} ‚Äî Actividad ${idx+1}</div>
                        <div style="color:#dff9ff;margin-top:6px">${act.descripcion}</div>`;
      const right = document.createElement('div');
      right.innerHTML = `<div style="display:flex;gap:6px">
        <button class="btn small ghost" onclick="openActivityModal('${k}', ${idx})">Editar</button>
        <button class="btn small danger" onclick="deleteActivity('${k}', ${idx})">Borrar</button>
      </div>`;
      div.appendChild(left); div.appendChild(right);
      c.appendChild(div);
    });
  });
}

function addActivityToTank(tankIdx){
  const desc = prompt('Descripci√≥n de la actividad (ej. Reposici√≥n de sello):');
  if(!desc) return;
  const key = `tank${tankIdx}`;
  actividades[key] = actividades[key] || [];
  actividades[key].push({descripcion: desc, antesFiles: [], despuesFiles: []});
  renderActivitiesForTankList(tankIdx);
}

function renderActivitiesForTankList(tankIdx){
  const containerId = `activitiesTankList_${tankIdx}`;
  const el = document.getElementById(containerId);
  if(!el) return;
  el.innerHTML = '';
  const key = `tank${tankIdx}`;
  const arr = actividades[key] || [];
  arr.forEach((act, idx)=>{
    const div = document.createElement('div'); div.className='tank-card'; div.style.display='flex'; div.style.justifyContent='space-between';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700;color:#fff">Tanque ${tankIdx} ‚Äî Act ${idx+1}</div><div style="color:#dff9ff;margin-top:6px">${act.descripcion}</div>`;
    const right = document.createElement('div'); right.innerHTML = `<div style="display:flex;gap:6px"><button class="btn small ghost" onclick="openActivityModal('tank${tankIdx}', ${idx})">Editar</button><button class="btn small danger" onclick="deleteActivity('tank${tankIdx}', ${idx})">Borrar</button></div>`;
    div.appendChild(left); div.appendChild(right); el.appendChild(div);
  });
}

/* Modal activity handlers */
let activityModalContext = null; // { key, index }

function openActivityModal(key, index){
  activityModalContext = {key, index};
  const act = actividades[key] && actividades[key][index];
  if(!act) return;
  document.getElementById('modalActivityTitle').innerText = `Editar: ${key} ‚Äî Actividad ${index+1}`;
  document.getElementById('modal_activity_desc').value = act.descripcion || '';
  // clear previews
  document.getElementById('modal_before_preview').innerHTML = '';
  document.getElementById('modal_after_preview').innerHTML = '';
  // set input files to empty (can't programmatically set FileList), but show existing filenames if any
  const beforePreview = document.getElementById('modal_before_preview');
  (act.antesFiles||[]).forEach(fmeta=>{
    const sp = document.createElement('div'); sp.textContent = fmeta.name || fmeta.filename || '(archivo)'; beforePreview.appendChild(sp);
  });
  const afterPreview = document.getElementById('modal_after_preview');
  (act.despuesFiles||[]).forEach(fmeta=>{
    const sp = document.createElement('div'); sp.textContent = fmeta.name || fmeta.filename || '(archivo)'; afterPreview.appendChild(sp);
  });
  // clear file inputs
  document.getElementById('modal_activity_files_before').value = '';
  document.getElementById('modal_activity_files_after').value = '';
  document.getElementById('modalActivity').classList.add('active');
}

function closeActivityModal(){
  activityModalContext = null;
  document.getElementById('modalActivity').classList.remove('active');
}

/* Save modal: store description and attach File objects to the activity (temporarily in memory)
   Note: File objects only exist on client; they'll be appended to FormData on final submission.
*/
function saveActivityModal(){
  if(!activityModalContext) { closeActivityModal(); return; }
  const {key, index} = activityModalContext;
  const act = actividades[key] && actividades[key][index];
  if(!act) return;
  act.descripcion = (document.getElementById('modal_activity_desc').value || '').trim();
  const beforeFilesInput = document.getElementById('modal_activity_files_before');
  const afterFilesInput = document.getElementById('modal_activity_files_after');
  // Replace arrays with File objects lists (if user selected)
  if(beforeFilesInput.files && beforeFilesInput.files.length) {
    act.antesFiles = Array.from(beforeFilesInput.files);
  }
  if(afterFilesInput.files && afterFilesInput.files.length) {
    act.despuesFiles = Array.from(afterFilesInput.files);
  }
  // update lists UI
  renderActivitiesRed();
  renderActivitiesEquipo();
  // Also render per-tank lists if applicable
  Object.keys(actividades).forEach(k=>{
    if(k.startsWith('tank')) {
      const ti = parseInt(k.replace('tank',''),10);
      if(!isNaN(ti)) renderActivitiesForTankList(ti);
    }
  });
  closeActivityModal();
}

/* delete activity */
function deleteActivity(key, index){
  if(!confirm('Eliminar actividad?')) return;
  if(!actividades[key]) return;
  actividades[key].splice(index,1);
  if(actividades[key].length === 0) delete actividades[key];
  renderActivitiesRed();
  renderActivitiesEquipo();
  Object.keys(actividades).forEach(k=>{
    if(k.startsWith('tank')) {
      const ti = parseInt(k.replace('tank',''),10);
      if(!isNaN(ti)) renderActivitiesForTankList(ti);
    }
  });
}

/* -------------------------
   EQUIPOS: render helper to keep select for activities up to date
   ------------------------- */
function updateEquipoSelects(){
  const sel = document.getElementById('select_eq_for_activity');
  sel.innerHTML = '<option value="">-- seleccionar equipo --</option>';
  equipos.forEach((eq,i)=>{
    const key = `equipo_${i+1}`;
    const opt = document.createElement('option'); opt.value = key; opt.textContent = `${key} ‚Äî ${eq["Equipo"]||'-'}`;
    sel.appendChild(opt);
  });
}

/* When adding equipo (function defined in PARTE 1's script), ensure it sets actividad key naming (equipo_N) */
/* We will rely on addEquipo() from Parte1 to push into equipos[] and call updateEquipoSelects() after that. */

/* -------------------------
   Integration points: when tanks or equipos change, update activities UI
   ------------------------- */
function onTanksOrEquiposChanged(){
  // re-render selects / per-tank activity lists
  updateTankSelectOptions(); // from Parte 1
  updateEquipoSelects();
  // create per-tank activity containers inside tank cards (if desired)
  // for each tank card append activities placeholder if not present
  const tanksContainer = document.getElementById('tanksList');
  tanks.forEach((t, i) => {
    const idx = i+1;
    // ensure a container exists for activities under each tank card (we'll add it in the card render function)
    renderActivitiesForTankList(idx);
  });
}

/* Hook into existing functions that mutate tanks/equipos:
   - In Parte 1, saveTank, deleteTank, editTank should call onTanksOrEquiposChanged()
   - In Parte 1, addEquipo/editEquipo/deleteEquipo should call updateEquipoSelects() and onTanksOrEquiposChanged()
   (If those functions are in Parte 1, ensure they call these helpers.)
*/

</script>

<!-- NOTE: Parte 2 termina aqu√≠. En la PARTE 3/3 incluir√© STEP 6, STEP 7 (tabla din√°mica de fotos integrada con previews y subida ANTES/DESPU√âS por actividad), todo el JS de env√≠o final (generate Word) ajustado al servidor.py que me diste, y la integraci√≥n para redimensionar / recortar im√°genes a 15x10 cm antes de enviar (cliente) y las llamadas al backend (/bloques_fotos, /generate_docx). -->
<!-- === PARTE 3/3 === -->
<!-- STEP 6 (Observaciones) ya estaba en Parte 1; continuamos con Step 7 y la tabla de fotos integrada -->

<!-- STEP 7: Carga de Fotos (tabla integrada) -->
<section id="step-7" class="step">
  <div class="card-header">
    <div>
      <div class="card-title">7 ¬∑ Carga de fotos</div>
      <div class="hint">Sube las fotos solicitadas desde la tabla. Solo se habilitar√°n los campos que apliquen al informe. Para actividades (10.X) hay separaci√≥n clara ANTES / DESPU√âS.</div>
    </div>
    <div><span class="hint">Paso 7 / 7</span></div>
  </div>

  <div id="photoContainer" style="margin-top:6px"></div>

  <div style="margin-top:12px" class="small-muted">Sugerencia: sube cada imagen con calidad adecuada. Las im√°genes se redimensionar√°n a 15x10 cm (se env√≠an como JPG). Para recuadros ‚ÄúANTES/DESPU√âS‚Äù sube ambas im√°genes con las claves indicadas.</div>

  <div style="margin-top:14px" id="err-step-7" class="errlist"></div>

  <div class="controls" style="margin-top:16px">
    <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
    <div style="flex:1"></div>
    <button class="btn primary" id="finalGenerate">Generar Word ‚Üí</button>
  </div>
</section>

<script>
/* -------------------------
   Utilities: image resize to 15x10 cm (client-side)
   - We resize to 1500x1000 px (15x10 cm at 254 dpi approx). This produces good quality.
   - If you prefer a different pixel density, cambia TARGET_W/TARGET_H.
   ------------------------- */

const TARGET_W = 1500; // px (15 cm)
const TARGET_H = 1000; // px (10 cm)

function fileToImage(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> {
      const img = new Image();
      img.onload = ()=> resolve(img);
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

function resizeImageToTarget(file){
  // returns Promise<Blob> (jpeg)
  return fileToImage(file).then(img => {
    // compute cover fit while preserving aspect ratio, then center crop to TARGET_W x TARGET_H
    const canvas = document.createElement('canvas');
    canvas.width = TARGET_W;
    canvas.height = TARGET_H;
    const ctx = canvas.getContext('2d');

    // determine scale to cover
    const scale = Math.max(TARGET_W / img.width, TARGET_H / img.height);
    const sw = TARGET_W / scale;
    const sh = TARGET_H / scale;
    const sx = (img.width - sw) / 2;
    const sy = (img.height - sh) / 2;

    // draw
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, TARGET_W, TARGET_H);

    return new Promise((resolve)=>{
      canvas.toBlob((blob)=>{
        // create a File-like object preserving name
        const outName = (file.name || 'img.jpg').replace(/\s+/g,'_');
        // Convert blob -> File if supported
        let outFile;
        try { outFile = new File([blob], outName, {type:blob.type}); }
        catch(e){ outFile = blob; outFile.name = outName; }
        resolve(outFile);
      }, 'image/jpeg', 0.90);
    });
  });
}

/* -------------------------
   Photo blocks fetching + table builder
   - fetchBloquesFotos() was defined earlier in Parte1, it posts current state to /bloques_fotos
   - bloquesFotosCache and uploadedPhotos exist (Parte1)
   ------------------------- */

async function fetchBloquesFotosAndBuild(){
  document.getElementById('err-step-7').innerText = '';
  try{
    await fetchBloquesFotos(); // this populates bloquesFotosCache and calls buildPhotoTable()
  }catch(e){
    console.error(e);
    document.getElementById('err-step-7').innerText = 'Error obteniendo bloques del servidor.';
  }
}

/* Build/refresh photo table based on bloquesFotosCache (used by fetchBloquesFotos) */
function buildPhotoTable(){
  const container = document.getElementById('photoContainer');
  container.innerHTML = '';

  if(!bloquesFotosCache || !bloquesFotosCache.length){
    container.innerHTML = '<div class="small-muted">No hay bloques fotogr√°ficos definidos.</div>';
    return;
  }

  // Table header already styled in Parte1
  const table = document.createElement('table');
  table.className = 'photo-table';
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr><th>Subt√≠tulo</th><th style="width:120px">N¬∞ Fotos</th><th style="width:160px">Estado</th><th style="width:220px">Acci√≥n</th></tr>`;
  table.appendChild(thead);
  const tbody = document.createElement('tbody');

  // For activities (10.X) we'll create an expandable / separate area inside the table to avoid confusion
  bloquesFotosCache.forEach(block => {
    const tr = document.createElement('tr');
    if(!block.aplica) tr.classList.add('disabled');

    // title
    const tdTitle = document.createElement('td');
    const titleDiv = document.createElement('div');
    titleDiv.className = 'photo-row-title';
    titleDiv.innerText = block.titulo;
    const subDiv = document.createElement('div');
    subDiv.className = 'photo-row-sub';
    subDiv.innerText = block.clave;
    tdTitle.appendChild(titleDiv);
    tdTitle.appendChild(subDiv);

    // count
    const tdCount = document.createElement('td');
    tdCount.innerHTML = `<div class="photo-count">${block.fotos} foto(s)</div>`;

    // status
    const tdStatus = document.createElement('td');
    const badge = document.createElement('span');
    badge.className = 'badge-state badge-red';
    badge.innerText = 'Sin subir';
    tdStatus.appendChild(badge);

    // actions: input hidden + upload btn + view btn + preview area
    const tdAction = document.createElement('td');
    tdAction.className = 'photo-action';

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    if(block.fotos && block.fotos > 1) input.multiple = true;
    input.className = 'file-input-hidden';
    input.dataset.clave = block.clave;

    // preview container (small thumbnails)
    const previewWrap = document.createElement('div');
    previewWrap.style.display = 'flex';
    previewWrap.style.gap = '6px';
    previewWrap.style.alignItems = 'center';

    // event handler: when files selected -> process and store in uploadedPhotos
    input.addEventListener('change', async (ev)=>{
      const files = Array.from(ev.target.files || []);
      if(files.length === 0) return;
      if(block.fotos && files.length > block.fotos){
        alert(`Se permiten m√°ximo ${block.fotos} fotos para este subt√≠tulo.`);
        return;
      }
      // process each file (resize)
      const processed = [];
      previewWrap.innerHTML = '';
      for(const f of files){
        // show temporary preview using URL.createObjectURL
        const thumb = document.createElement('img');
        thumb.className = 'photo-preview';
        thumb.style.width='120px'; thumb.style.height='80px'; thumb.style.objectFit='cover';
        thumb.src = URL.createObjectURL(f);
        previewWrap.appendChild(thumb);

        // resize in background
        try{
          const resized = await resizeImageToTarget(f);
          processed.push(resized);
        }catch(err){
          console.error('resize fail', err);
          processed.push(f); // fallback original
        }
      }
      uploadedPhotos[block.clave] = processed;
      updatePhotoRowStatus(block.clave, tr, badge, block.fotos);
    });

    // buttons
    const btn = document.createElement('button');
    btn.className = 'btn small primary';
    btn.type = 'button';
    btn.innerText = block.aplica ? (block.fotos > 1 ? 'Subir fotos' : 'Subir foto') : 'No aplica';
    btn.disabled = !block.aplica;
    btn.addEventListener('click', ()=> input.click());

    const btnView = document.createElement('button');
    btnView.className = 'btn small ghost';
    btnView.type = 'button';
    btnView.innerText = 'Ver';
    btnView.disabled = true;
    btnView.addEventListener('click', ()=>{
      const list = uploadedPhotos[block.clave] || [];
      if(!list.length){ alert('No hay im√°genes para ver.'); return; }
      list.forEach(f=>{
        const url = URL.createObjectURL(f);
        window.open(url);
      });
    });

    tdAction.appendChild(input);
    tdAction.appendChild(btn);
    tdAction.appendChild(btnView);
    tdAction.appendChild(previewWrap);

    tr.appendChild(tdTitle);
    tr.appendChild(tdCount);
    tr.appendChild(tdStatus);
    tr.appendChild(tdAction);
    tr.dataset.clave = block.clave;

    tbody.appendChild(tr);

    // If block.clave is a "foto_10..." (actividades) we'll add a helper area linking to activities.
    if(block.clave.startsWith('foto_10_')){
      // leave it as is (these keys will be populated when activities exist); if the block corresponds to "no_actividades" fotos==0 we show a note
      if(block.fotos === 0){
        // nothing to add
      }
    }
  });

  table.appendChild(tbody);
  container.appendChild(table);

  // After table, provide expanded UI for actividades (so user can upload BEFORE/DESPU√âS per activity easily)
  buildActivitiesUploadArea(container);
}

/* Activities upload area
   - Shows all actividades currently defined in actividades{tankX, red_XXX, equipo_N}
   - For each activity: shows desc and two file inputs (antes/despues). Process images to target size and store using keys consistent with server.
*/
function buildActivitiesUploadArea(container){
  // remove existing activities wrapper if any
  const existing = document.getElementById('activitiesUploadWrapper');
  if(existing) existing.remove();

  const wrapper = document.createElement('div');
  wrapper.id = 'activitiesUploadWrapper';
  wrapper.style.marginTop = '14px';
  wrapper.innerHTML = `<div class="card-header"><div><div class="card-title">10 ¬∑ Trabajos realizados (Actividades) ‚Äî Subida ANTES / DESPU√âS</div><div class="hint">Para cada actividad sube la(s) foto(s) ANTES y DESPU√âS. Las claves se asignan autom√°ticamente.</div></div></div>`;

  Object.keys(actividades).forEach(key => {
    const arr = actividades[key] || [];
    if(!arr || !arr.length) return;
    const sec = document.createElement('div');
    sec.style.marginTop = '10px';

    const human = key.startsWith('tank') ? `Tanque ${key.replace('tank','')}` : (key.startsWith('red_') ? (key==='red_llenado_retorno' ? 'Red Llenado/Retorno' : 'Red Consumo') : key);
    sec.innerHTML = `<div style="font-weight:800;margin-bottom:6px;color:#fff">${human}</div>`;
    arr.forEach((act, aidx) => {
      const card = document.createElement('div');
      card.className = 'photo-card';
      card.style.display = 'grid';
      card.style.gridTemplateColumns = '1fr 1fr 1fr';
      card.style.gap = '8px';
      card.style.alignItems = 'start';
      // description and preview placeholders
      const descDiv = document.createElement('div');
      descDiv.innerHTML = `<div style="font-weight:700;color:#004085">${aidx+1}. ${act.descripcion}</div><div class="small-muted">Clave base: ${key} ‚Äî actividad ${aidx+1}</div>`;

      // BEFORE column
      const beforeCol = document.createElement('div');
      beforeCol.innerHTML = `<div class="label">ANTES</div>`;
      const inpBefore = document.createElement('input');
      inpBefore.type = 'file'; inpBefore.accept='image/*'; inpBefore.multiple = true;
      inpBefore.style.marginTop='6px';
      const prevB = document.createElement('div'); prevB.style.display='flex'; prevB.style.gap='6px'; prevB.style.marginTop='6px';
      beforeCol.appendChild(inpBefore); beforeCol.appendChild(prevB);

      // AFTER column
      const afterCol = document.createElement('div');
      afterCol.innerHTML = `<div class="label">DESPU√âS</div>`;
      const inpAfter = document.createElement('input');
      inpAfter.type = 'file'; inpAfter.accept='image/*'; inpAfter.multiple = true;
      inpAfter.style.marginTop='6px';
      const prevA = document.createElement('div'); prevA.style.display='flex'; prevA.style.gap='6px'; prevA.style.marginTop='6px';
      afterCol.appendChild(inpAfter); afterCol.appendChild(prevA);

      // When files selected: resize and store them in actividades object (antesFiles / despuesFiles), but also append to uploadedPhotos map so they are sent
      inpBefore.addEventListener('change', async (ev)=>{
        const files = Array.from(ev.target.files || []);
        prevB.innerHTML = '';
        const processed = [];
        for(const f of files){
          const thumb = document.createElement('img'); thumb.style.width='120px'; thumb.style.height='80px'; thumb.style.objectFit='cover';
          thumb.src = URL.createObjectURL(f);
          prevB.appendChild(thumb);
          try{
            const resized = await resizeImageToTarget(f);
            processed.push(resized);
          }catch(e){ processed.push(f); }
        }
        // store
        act.antesFiles = processed;
        // store also in uploadedPhotos with key convention for server
        const aIdxOne = aidx+1;
        // server expects keys like foto_10_tank{i}_act{a_idx}__antes or foto_10_{rw}_act{a_idx}__antes
        const claveBase = key.replace(/^tank/,'tank'); // keep same
        const clave = `foto_10_${claveBase}_act${aIdxOne}__antes`;
        uploadedPhotos[clave] = processed;
        updateTableCellsStatusFromUploads();
      });

      inpAfter.addEventListener('change', async (ev)=>{
        const files = Array.from(ev.target.files || []);
        prevA.innerHTML = '';
        const processed = [];
        for(const f of files){
          const thumb = document.createElement('img'); thumb.style.width='120px'; thumb.style.height='80px'; thumb.style.objectFit='cover';
          thumb.src = URL.createObjectURL(f);
          prevA.appendChild(thumb);
          try{
            const resized = await resizeImageToTarget(f);
            processed.push(resized);
          }catch(e){ processed.push(f); }
        }
        act.despuesFiles = processed;
        const aIdxOne = aidx+1;
        const claveBase = key.replace(/^tank/,'tank');
        const clave = `foto_10_${claveBase}_act${aIdxOne}__despues`;
        uploadedPhotos[clave] = processed;
        updateTableCellsStatusFromUploads();
      });

      card.appendChild(descDiv);
      card.appendChild(beforeCol);
      card.appendChild(afterCol);
      sec.appendChild(card);
    });

    wrapper.appendChild(sec);
  });

  container.appendChild(wrapper);
}

/* Update table rows status from uploadedPhotos contents (synchronizes badges & view buttons) */
function updateTableCellsStatusFromUploads(){
  // iterate through table rows (photo-table) and update
  const rows = document.querySelectorAll('#photoContainer table.photo-table tbody tr');
  rows.forEach(tr=>{
    const clave = tr.dataset.clave;
    if(!clave) return;
    const badge = tr.querySelector('.badge-state');
    updatePhotoRowStatus(clave, tr, badge, (bloquesFotosCache.find(b=>b.clave===clave)||{}).fotos);
  });
}

/* Overwrite updatePhotoRowStatus to enable correct view button selection for dynamic table */
function updatePhotoRowStatus(clave, trElem, badgeElem, fotosNecesarias, btnViewElem) {
  const files = uploadedPhotos[clave] || [];
  const n = Array.isArray(files) ? files.length : 0;
  const badge = badgeElem;
  const tr = trElem;
  const btnView = btnViewElem || tr.querySelector('button.ghost');
  if(n === 0) {
    badge.className = 'badge-state badge-red';
    badge.innerText = 'Sin subir';
    if(btnView) btnView.disabled = true;
  } else if(fotosNecesarias && n < fotosNecesarias) {
    badge.className = 'badge-state badge-yellow';
    badge.innerText = `${n}/${fotosNecesarias}`;
    if(btnView) btnView.disabled = false;
  } else {
    badge.className = 'badge-state badge-green';
    badge.innerText = fotosNecesarias ? `${n}/${fotosNecesarias}` : `${n}`;
    if(btnView) btnView.disabled = false;
  }
}

/* When entering step 7 we fetch bloques and build table (showStep override in Parte1 already calls fetchBloquesFotos) */

/* -------------------------
   Final generate: assemble payload + FormData
   - This will include:
     - payload JSON (general, tanques, accesoriosTanque, accesoriosRed, equipos, observaciones, actividades)
     - files: uploadedPhotos keys + actividades files (already stored in uploadedPhotos with claves)
   ------------------------- */

async function generateWordWithPhotos(e){
  e && e.preventDefault && e.preventDefault();
  document.getElementById('err-step-7').innerText = '';
  try{
    // Validate previous steps
    for(let i=1;i<=6;i++){
      if(!validateStep(i)) { showStep(i); throw new Error('Validaci√≥n fallida en pasos previos'); }
    }

    // Build payload including ACTIVIDADES in a structured way expected by server.py
    // We'll construct actividades object mapping tank indices and redes/equipos keys to arrays of {descripcion}
    const actividadesPayload = {};
    Object.keys(actividades).forEach(k=>{
      const arr = actividades[k] || [];
      if(!arr.length) return;
      actividadesPayload[k] = arr.map(act => ({ descripcion: act.descripcion || '' }));
    });

    const payload = {
      general: generalInfo,
      tanques: tanks,
      accesoriosTanque: Object.assign({}, accessoriesByTank),
      accesoriosRed: redes,
      equipos: equipos,
      observaciones: {
        "7.1": document.getElementById('obs_71').value.trim(),
        "7.2": document.getElementById('obs_72').value.trim(),
        "7.3": document.getElementById('obs_73').value.trim(),
        "7.4": document.getElementById('obs_74').value.trim(),
        "7.5": document.getElementById('obs_75').value.trim()
      },
      actividades: actividadesPayload
    };

    const form = new FormData();
    form.append('payload', JSON.stringify(payload));

    // Append files: uploadedPhotos holds clave -> [File,...]
    for(const clave in uploadedPhotos){
      const files = uploadedPhotos[clave];
      if(!files || !files.length) continue;
      if(Array.isArray(files)){
        for(let i=0;i<files.length;i++){
          // keep key naming: clave__1, clave__2, ... to be safe
          const key = (files.length > 1) ? `${clave}__${i+1}` : clave;
          const f = files[i];
          // ensure f is a File (if blob-like, try to attach a name)
          if(f instanceof Blob && !(f instanceof File)){
            let name = f.name || `${key}.jpg`;
            try { form.append(key, new File([f], name, {type: f.type})); }
            catch(err){ // older browsers
              // convert blob to blob with filename hack
              form.append(key, f, name);
            }
          } else {
            form.append(key, f, f.name || `${key}.jpg`);
          }
        }
      } else {
        // single blob/file
        const f = files;
        form.append(clave, f, f.name || `${clave}.jpg`);
      }
    }

    // Additionally, include activities' antes/despues explicitly if they exist but might not be present in uploadedPhotos
    // (uploadedPhotos keys already filled when user uploaded via Activities UI, so often redundant)
    Object.keys(actividades).forEach(k=>{
      const arr = actividades[k] || [];
      arr.forEach((act, idx) => {
        const num = idx+1;
        if(act.antesFiles && act.antesFiles.length){
          act.antesFiles.forEach((f,iF)=>{
            const key = (act.antesFiles.length>1) ? `foto_10_${k}_act${num}__antes__${iF+1}` : `foto_10_${k}_act${num}__antes`;
            form.append(key, f, f.name || `${key}.jpg`);
          });
        }
        if(act.despuesFiles && act.despuesFiles.length){
          act.despuesFiles.forEach((f,iF)=>{
            const key = (act.despuesFiles.length>1) ? `foto_10_${k}_act${num}__despues__${iF+1}` : `foto_10_${k}_act${num}__despues`;
            form.append(key, f, f.name || `${key}.jpg`);
          });
        }
      });
    });

    const btn = document.getElementById('finalGenerate');
    btn.disabled = true;
    const originalText = btn.innerText;
    btn.innerText = 'Generando...';

    const res = await fetch('/generate_docx', { method:'POST', body: form });
    if(!res.ok){
      const txt = await res.text().catch(()=>null);
      throw new Error(txt || 'Error en servidor al generar DOCX');
    }
    // get blob
    const blob = await res.blob();
    // try to get filename
    const disposition = res.headers.get('content-disposition') || res.headers.get('Content-Disposition') || '';
    let filename = 'informe_generado.docx';
    const m = /filename\*?=UTF-8''(.+)|filename="?([^"]+)"?/.exec(disposition);
    if(m){
      filename = decodeURIComponent(m[1] || m[2] || filename);
    }
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    btn.disabled = false;
    btn.innerText = originalText;
    alert('Informe generado y descargado.');
  }catch(err){
    console.error(err);
    document.getElementById('err-step-7').innerText = 'Error generando el Word: ' + (err.message || err);
    const btn = document.getElementById('finalGenerate');
    if(btn){ btn.disabled = false; btn.innerText = 'Generar Word ‚Üí'; }
  }
}

/* Bind final button (override previous binding if exists) */
document.getElementById('finalGenerate').removeEventListener && document.getElementById('finalGenerate').removeEventListener('click', generateWordWithPhotos);
document.getElementById('finalGenerate').addEventListener('click', generateWordWithPhotos);

/* When showStep(7) was called earlier, fetchBloquesFotos was invoked; but let's ensure the table is built if bloquesFotosCache exists */
if(typeof bloquesFotosCache !== 'undefined' && bloquesFotosCache.length){
  buildPhotoTable();
}

/* Ensure activities UIs are rendered on init */
onTanksOrEquiposChanged();
renderActivitiesRed();
renderActivitiesEquipo();

</script>
<!-- === FIN PARTE 3/3 === -->        
    
