<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Generador de Informes - Futurista</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        /* ======================== */
        /*   ESTILO GLOBAL FUTURISTA  */
        /* ======================== */

        :root{
            --bg:#0c0f1a;
            --panel-bg: rgba(255,255,255,0.03);
            --accent:#4ea8de;
            --muted:#9db4d0;
            --glass-border: rgba(78,168,222,0.3);
        }

        html,body{
            height:100%;
            margin:0;
            padding:0;
            background:var(--bg);
            font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color:#e5e7eb;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        h1{ text-align:center; margin-top:24px; color:var(--accent); font-size:28px; letter-spacing:1px; text-shadow:0 0 8px rgba(62,161,219,0.18); }
        h2{ color:var(--accent); margin:0 0 12px 0; font-size:18px; }

        .container{
            width:95%;
            max-width:1200px;
            margin:20px auto 80px;
        }

        .panel{
            background: var(--panel-bg);
            padding:20px;
            border-radius:12px;
            margin-bottom:18px;
            border:1px solid var(--glass-border);
            box-shadow: 0 0 8px rgba(78,168,222,0.12);
        }

        .form-row{ margin-bottom:12px; display:flex; flex-direction:column; }
        .form-row label{ color:var(--muted); font-size:13px; margin-bottom:6px; }
        .form-row input, .form-row select, .form-row textarea {
            background: rgba(255,255,255,0.05);
            border:1px solid rgba(255,255,255,0.04);
            padding:10px;
            color:#fff;
            border-radius:8px;
            font-size:14px;
        }
        .form-row textarea{ min-height:90px; resize:vertical; }

        button{
            border:none;
            padding:10px 14px;
            background:var(--accent);
            color:#fff;
            border-radius:8px;
            cursor:pointer;
            transition:all .16s ease;
        }
        button:hover{ transform:translateY(-2px); }
        .btn-danger{ background:#d9534f; }
        .btn-add{ background:#5cb85c; }

        .tank-block, .equip-block, .acc-block, .red-block{
            padding:14px;
            border-radius:10px;
            background: rgba(255,255,255,0.02);
            margin-bottom:10px;
            border-left:4px solid var(--accent);
        }

        .images-grid{
            display:grid;
            grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
            gap:10px;
        }
        .img-preview{ position:relative; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.08); }
        .img-preview img{ width:100%; height:110px; object-fit:cover; display:block; }
        .delete-img{ position:absolute; top:6px; right:6px; background:rgba(220,38,38,0.95); color:#fff; border-radius:50%; width:28px; height:28px; border:none; cursor:pointer; }

        .foto-slot{ margin-bottom:16px; padding:12px; border-left:3px solid var(--accent); border-radius:8px; background: rgba(255,255,255,0.01); }
        .slot-upload-row{ display:flex; gap:12px; flex-wrap:wrap; }
        .slot-upload{
            border:1px dashed rgba(255,255,255,0.08);
            padding:10px;
            border-radius:8px;
            width:180px;
            text-align:center;
            cursor:pointer;
            background: rgba(255,255,255,0.01);
        }
        .slot-upload:hover{ border-color:var(--accent); background: rgba(255,255,255,0.02); }
        .slot-upload input{ display:none; }
        .slot-title{ font-size:13px; color:var(--muted); }

        .activity-block{ padding:12px; border:1px solid rgba(255,255,255,0.04); border-radius:10px; margin-top:10px; background: rgba(255,255,255,0.01); }
        .activity-title{ color:#9fc5f8; font-size:14px; margin-bottom:8px; }

        @media (max-width:780px){
            .container{ padding:10px; }
            .slot-upload{ width:48%; }
        }

    </style>
</head>
<body>
    <h1>GENERADOR AUTOMÁTICO DE INFORMES</h1>

    <div class="container">

        <!-- PANEL: DATOS DEL CLIENTE -->
        <section class="panel" id="panel-general">
            <h2>1. Información del Cliente</h2>

            <div class="form-row">
                <label>Nombre o razón social del cliente:</label>
                <input type="text" id="c_nombre" />
            </div>

            <div class="form-row">
                <label>Fecha de inspección:</label>
                <input type="date" id="c_fecha" />
            </div>

            <div class="form-row">
                <label>Dirección:</label>
                <input type="text" id="c_direccion" />
            </div>

            <div class="form-row" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
                <div>
                    <label>RUC o DNI:</label>
                    <input type="text" id="c_doc" />
                </div>
                <div>
                    <label>Número de instalación:</label>
                    <input type="text" id="c_instalacion" />
                </div>
                <div>
                    <label>Distrito:</label>
                    <input type="text" id="c_distrito" />
                </div>
            </div>

            <div class="form-row" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px">
                <div>
                    <label>Departamento:</label>
                    <input type="text" id="c_departamento" />
                </div>
                <div>
                    <label>Coordenadas:</label>
                    <input type="text" id="c_coordenadas" />
                </div>
                <div>
                    <label>Nombre del contacto:</label>
                    <input type="text" id="c_contacto" />
                </div>
            </div>

            <div class="form-row" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px">
                <div>
                    <label>Número del contacto:</label>
                    <input type="text" id="c_num_contacto" />
                </div>
                <div>
                    <label>Correo del contacto:</label>
                    <input type="email" id="c_correo" />
                </div>
            </div>
        </section>

        <!-- PANEL DE TANQUES -->
        <section class="panel" id="panel-tanques">
            <h2>2. Tanques inspeccionados</h2>

            <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
                <button class="btn-add" id="btnAddTank">+ Agregar Tanque</button>
                <div style="color:var(--muted);font-size:13px">Agrega tantos tanques como existan en la instalación.</div>
            </div>

            <div id="lista-tanques">
                <!-- bloques de tanque generados por JS -->
            </div>
        </section>

        <!-- ACCESORIOS POR TANQUE -->
        <section class="panel" id="panel-accesorios-tanque">
            <h2>3. Accesorios por tanque</h2>
            <div style="color:var(--muted);margin-bottom:10px">Selecciona el tanque para editar accesorios (Marca, Código, Serie, Mes/Año).</div>
            <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
                <label style="color:var(--muted)">Tanque seleccionado:</label>
                <select id="selectTanqueForAcc"></select>
            </div>
            <div id="accesorios-tanque-contenedor">
                <!-- formulario accesorios por tanque -->
            </div>
        </section>

        <!-- ACCESORIOS EN RED -->
        <section class="panel" id="panel-accesorios-red">
            <h2>4. Accesorios en la red</h2>
            <div style="color:var(--muted);margin-bottom:10px">Agrega accesorios encontrados en la red (Tipo, Marca, Serie, Código, Mes/Año).</div>

            <div id="lista-accesorios-red">
                <!-- items añadidos por JS -->
            </div>

            <div style="margin-top:10px">
                <button id="btnAddAccRed" class="btn">+ Agregar accesorio en red</button>
            </div>
        </section>

        <!-- EQUIPOS -->
        <section class="panel" id="panel-equipos">
            <h2>5. Equipos de la instalación</h2>
            <div style="color:var(--muted);margin-bottom:10px">Añade equipos (vaporizador, quemador, decantador, etc.).</div>

            <div id="lista-equipos">
                <!-- items añadidos por JS -->
            </div>

            <div style="margin-top:10px">
                <button id="btnAddEquipo" class="btn">+ Agregar equipo</button>
            </div>
        </section>

        <!-- OBSERVACIONES -->
        <section class="panel" id="panel-observaciones">
            <h2>6. Observaciones</h2>

            <div class="form-row">
                <label>7.1 Observaciones al cliente</label>
                <textarea id="obs_7_1"></textarea>
            </div>

            <div class="form-row">
                <label>7.2 Observaciones en red de llenado y retorno</label>
                <textarea id="obs_7_2"></textarea>
            </div>

            <div class="form-row">
                <label>7.3 Observaciones en zona de tanque</label>
                <textarea id="obs_7_3"></textarea>
            </div>

            <div class="form-row">
                <label>7.4 Observaciones en red de consumo</label>
                <textarea id="obs_7_4"></textarea>
            </div>

            <div class="form-row">
                <label>7.5 Observaciones en equipos varios (separar por punto con '.')</label>
                <textarea id="obs_7_5" placeholder="Ejemplo: Vaporizador en mal estado. Quemador necesita ajuste."></textarea>
            </div>
        </section>

        <!-- PANEL DINÁMICO: SLOTS DE FOTOS 9.x -->
        <section class="panel" id="panel-fotos">
            <h2>7. Evidencia Fotográfica (9.x)</h2>
            <div style="color:var(--muted);margin-bottom:10px">
                Los subtítulos que requieren fotos serán generados automáticamente según los tanques,
                equipos y accesorios enviados.  
                <br>Los recuadros aparecerán aquí para que subas fotos JPG/PNG.
            </div>

            <div id="containerSlotsFotos">
                <!-- Aquí JS insertará los bloques 9.x -->
            </div>
        </section>

        <!-- PANEL: ACTIVIDADES (10.x) -->
        <section class="panel" id="panel-actividades">
            <h2>8. Evidencia de Mantenimiento (10.x)</h2>
            <div style="color:var(--muted);margin-bottom:10px">
                Para cada tanque y para las redes de llenado/retorno y consumo, podrás agregar
                las actividades realizadas y subir fotos del <b>ANTES</b> y <b>DESPUÉS</b>.
            </div>

            <div id="containerActividades">
                <!-- JS insertará dinámicamente los bloques 10.1 ... 10.N -->
            </div>
        </section>

        <!-- BOTÓN FINAL PARA GENERAR DOCUMENTO -->
        <section class="panel">
            <h2>Generar Informe</h2>
            <button id="btnGenerarDoc" style="width:100%;padding:16px;font-size:16px">
                GENERAR DOCUMENTO WORD
            </button>
            <div id="estadoGeneracion" style="margin-top:12px;color:var(--muted);font-size:14px"></div>
        </section>

    </div>

    <!-- ============================== -->
    <!--     SCRIPTS PRINCIPALES        -->
    <!-- ============================== -->

    <script>
        /* ======================================================= */
        /*  UTILIDADES GENERALES                                  */
        /* ======================================================= */

        function createElement(html){
            const div = document.createElement("div");
            div.innerHTML = html.trim();
            return div.firstChild;
        }

        function generarIdAleatorio(){
            return Math.floor(Math.random()*9999999).toString(16);
        }

        /* ======================================================= */
        /*       MANEJO DE TANQUES                                 */
        /* ======================================================= */

        let tanques = [];
        const contTanques = document.getElementById("lista-tanques");
        const btnAddTank = document.getElementById("btnAddTank");

        btnAddTank.addEventListener("click",()=>{
            const id = generarIdAleatorio();
            const idx = tanques.length + 1;
            tanques.push({id:id});

            const block = createElement(`
                <div class="tank-block" id="tank_${id}">
                    <h3 style="color:var(--accent);font-size:15px;margin-top:0">Tanque ${idx}</h3>

                    <div class="form-row">
                        <label>N° de serie:</label>
                        <input type="text" class="t_serie" />
                    </div>

                    <div class="form-row">
                        <label>Capacidad (gal):</label>
                        <input type="number" class="t_capa" />
                    </div>

                    <div class="form-row">
                        <label>Año de fabricación:</label>
                        <input type="text" class="t_anio" />
                    </div>

                    <div class="form-row">
                        <label>Tipo de tanque:</label>
                        <input type="text" class="t_tipo" />
                    </div>

                    <div class="form-row">
                        <label>Fabricante:</label>
                        <input type="text" class="t_fabricante" />
                    </div>

                    <div class="form-row">
                        <label>% Actual:</label>
                        <input type="text" class="t_porcentaje" />
                    </div>

                    <div style="margin-top:8px">
                        <button class="btn-danger" onclick="document.getElementById('tank_${id}').remove(); actualizarSelectTanque()">Eliminar tanque</button>
                    </div>

                </div>
            `);

            contTanques.appendChild(block);
            actualizarSelectTanque();
        });

        function actualizarSelectTanque(){
            const select = document.getElementById("selectTanqueForAcc");
            select.innerHTML = "";
            const tankEls = document.querySelectorAll(".tank-block");
            tankEls.forEach((tb,i)=>{
                const op = document.createElement("option");
                op.value = tb.id.replace("tank_","");
                op.textContent = "Tanque " + (i+1);
                select.appendChild(op);
            });
            renderAccesoriosTanque();
        }

        /* ======================================================= */
        /*      ACCESORIOS POR TANQUE                              */
        /* ======================================================= */

        const contAccTank = document.getElementById("accesorios-tanque-contenedor");

        function renderAccesoriosTanque(){
            const select = document.getElementById("selectTanqueForAcc");
            const idSel = select.value;
            if(!idSel){ contAccTank.innerHTML = ""; return; }

            const html = `
                <div class="acc-block">
                    <h3 style="color:var(--accent);font-size:15px;margin-top:0">Accesorios</h3>

                    <p style="color:var(--muted);margin-top:-4px;margin-bottom:10px">
                        Ingresa Marca, Código, Serie y Mes/Año.
                    </p>

                    <div class="form-row">
                        <label>Válvula de llenado (Marca):</label>
                        <input type="text" id="a_ll_marca" />
                    </div>
                    <div class="form-row">
                        <label>Código:</label><input type="text" id="a_ll_codigo" />
                    </div>
                    <div class="form-row">
                        <label>Serie:</label><input type="text" id="a_ll_serie" />
                    </div>
                    <div class="form-row">
                        <label>Mes/Año de fabricación:</label><input type="text" id="a_ll_mesanio" />
                    </div>
                </div>
            `;

            contAccTank.innerHTML = html;
        }

        document.getElementById("selectTanqueForAcc").addEventListener("change", renderAccesoriosTanque);

        /* ======================================================= */
        /*  ACCESORIOS DE RED (7.x)                                */
        /* ======================================================= */

        const contAccRed = document.getElementById("lista-accesorios-red");
        const btnAddAccRed = document.getElementById("btnAddAccRed");

        btnAddAccRed.addEventListener("click",()=>{
            const id = generarIdAleatorio();
            const block = createElement(`
                <div class="red-block" id="red_${id}">
                    <div class="form-row">
                        <label>Tipo:</label>
                        <input type="text" class="r_tipo" />
                    </div>
                    <div class="form-row">
                        <label>Marca:</label>
                        <input type="text" class="r_marca" />
                    </div>
                    <div class="form-row">
                        <label>Serie:</label>
                        <input type="text" class="r_serie" />
                    </div>
                    <div class="form-row">
                        <label>Código:</label>
                        <input type="text" class="r_codigo" />
                    </div>
                    <div class="form-row">
                        <label>Mes/Año de fabricación:</label>
                        <input type="text" class="r_mesanio" />
                    </div>

                    <div style="margin-top:8px">
                        <button class="btn-danger" onclick="document.getElementById('red_${id}').remove()">Eliminar</button>
                    </div>
                </div>
            `);
            contAccRed.appendChild(block);
        });

        /* ======================================================= */
        /* EQUIPOS DE INSTALACIÓN                                 */
        /* ======================================================= */

        const contEquipos = document.getElementById("lista-equipos");
        const btnAddEquipo = document.getElementById("btnAddEquipo");

        btnAddEquipo.addEventListener("click",()=>{
            const id = generarIdAleatorio();
            const block = createElement(`
                <div class="equip-block" id="eq_${id}">
                    <div class="form-row">
                        <label>Tipo de equipo:</label>
                        <input type="text" class="eq_tipo" />
                    </div>
                    <div class="form-row">
                        <label>Marca:</label>
                        <input type="text" class="eq_marca" />
                    </div>
                    <div class="form-row">
                        <label>Serie:</label>
                        <input type="text" class="eq_serie" />
                    </div>

                    <div style="margin-top:8px">
                        <button class="btn-danger" onclick="document.getElementById('eq_${id}').remove()">Eliminar</button>
                    </div>
                </div>
            `);
            contEquipos.appendChild(block);
        });

        /* ======================================================= */
        /*   PETICIÓN DE SLOTS AL BACKEND (/photo_slots)          */
        /* ======================================================= */

        async function solicitarSlotsAlBackend(){
            const payload = construirPayloadBasico();
            try{
                const res = await fetch("/photo_slots", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if(!res.ok){
                    const txt = await res.text();
                    alert("Error al solicitar subtítulos: " + txt);
                    return [];
                }
                const j = await res.json();
                return j.slots || [];
            }catch(err){
                console.error("Error fetch slots:", err);
                alert("Error de red solicitando subtítulos.");
                return [];
            }
        }

        function construirPayloadBasico(){
            const general = {
                "Nombre o razón social del cliente": document.getElementById("c_nombre").value || "",
                "Fecha de inspección": document.getElementById("c_fecha").value || "",
                "Dirección": document.getElementById("c_direccion").value || "",
                "RUC o DNI": document.getElementById("c_doc").value || "",
                "Número de instalación": document.getElementById("c_instalacion").value || "",
                "Distrito": document.getElementById("c_distrito").value || "",
                "Departamento": document.getElementById("c_departamento").value || "",
                "Coordenadas": document.getElementById("c_coordenadas").value || "",
                "Nombre del contacto": document.getElementById("c_contacto").value || "",
                "Número del contacto": document.getElementById("c_num_contacto").value || "",
                "Correo de contacto": document.getElementById("c_correo").value || ""
            };

            const tanquesPayload = [];
            const tankEls = document.querySelectorAll(".tank-block");
            tankEls.forEach(tb => {
                const serie = tb.querySelector(".t_serie") ? tb.querySelector(".t_serie").value : "";
                const capacidad = tb.querySelector(".t_capa") ? tb.querySelector(".t_capa").value : "";
                const anio = tb.querySelector(".t_anio") ? tb.querySelector(".t_anio").value : "";
                const tipo = tb.querySelector(".t_tipo") ? tb.querySelector(".t_tipo").value : "";
                const fabricante = tb.querySelector(".t_fabricante") ? tb.querySelector(".t_fabricante").value : "";
                const porcentaje = tb.querySelector(".t_porcentaje") ? tb.querySelector(".t_porcentaje").value : "";
                tanquesPayload.push({ serie, capacidad, anio, tipo, fabricante, porcentaje });
            });

            const accesoriosTanque = {}; // UI simple - puedes ampliar
            const accesoriosRed = [];
            document.querySelectorAll(".red-block").forEach(rb => {
                accesoriosRed.push({
                    "Tipo": rb.querySelector(".r_tipo") ? rb.querySelector(".r_tipo").value : "",
                    "Marca": rb.querySelector(".r_marca") ? rb.querySelector(".r_marca").value : "",
                    "Serie": rb.querySelector(".r_serie") ? rb.querySelector(".r_serie").value : "",
                    "Código": rb.querySelector(".r_codigo") ? rb.querySelector(".r_codigo").value : "",
                    "Mes/Año de fabricación": rb.querySelector(".r_mesanio") ? rb.querySelector(".r_mesanio").value : ""
                });
            });

            const equipos = [];
            document.querySelectorAll(".equip-block").forEach(eb => {
                equipos.push({
                    "Tipo de equipo": eb.querySelector(".eq_tipo") ? eb.querySelector(".eq_tipo").value : "",
                    "Equipo": "",
                    "Marca": eb.querySelector(".eq_marca") ? eb.querySelector(".eq_marca").value : "",
                    "Modelo": "",
                    "Serie": eb.querySelector(".eq_serie") ? eb.querySelector(".eq_serie").value : ""
                });
            });

            const observaciones = {
                "7.1": document.getElementById("obs_7_1").value || "",
                "7.2": document.getElementById("obs_7_2").value || "",
                "7.3": document.getElementById("obs_7_3").value || "",
                "7.4": document.getElementById("obs_7_4").value || "",
                "7.5": document.getElementById("obs_7_5").value || ""
            };

            return {
                general,
                tanques: tanquesPayload,
                accesoriosTanque,
                accesoriosRed,
                equipos,
                observaciones
            };
        }

        /* ======================================================= */
        /*   RENDER DE SLOTS 9.x Y SUBIDA DE IMÁGENES              */
        /* ======================================================= */

        const containerSlotsFotos = document.getElementById("containerSlotsFotos");
        let currentSlots = [];

        async function cargarYRenderizarSlots(){
            containerSlotsFotos.innerHTML = "<div style='color:var(--muted)'>Solicitando subtítulos...</div>";
            const slots = await solicitarSlotsAlBackend();
            currentSlots = slots;
            if(!slots.length){
                containerSlotsFotos.innerHTML = "<div style='color:var(--muted)'>No se encontraron subtítulos para imágenes.</div>";
                return;
            }
            containerSlotsFotos.innerHTML = "";
            slots.forEach(s => {
                const slotKey = s.code.replace(".", "_");
                const slotDiv = document.createElement("div");
                slotDiv.className = "foto-slot";
                slotDiv.id = `slot_wrap_${slotKey}`;
                slotDiv.innerHTML = `<h3 style="margin:0 0 8px 0;color:var(--accent)">${s.code} · ${s.label}</h3>
                    <div class="slot-upload-row" id="row_${slotKey}"></div>`;
                containerSlotsFotos.appendChild(slotDiv);

                const row = slotDiv.querySelector(`#row_${slotKey}`);
                for(let i=0;i< s.cantidad; i++){
                    const idx = i+1;
                    const uploadId = `${slotKey}__${idx}`;
                    const el = document.createElement("div");
                    el.className = "slot-upload";
                    el.id = `slot_upload_${uploadId}`;
                    el.innerHTML = `<div class="slot-title">Recuadro ${idx}</div>
                                    <input type="file" accept="image/png, image/jpeg" id="file_${uploadId}" style="display:none">`;
                    row.appendChild(el);

                    const input = el.querySelector("input[type=file]");
                    el.addEventListener("click", ()=> input.click());
                    input.addEventListener("change", (ev)=> {
                        const f = ev.target.files[0];
                        manejarArchivoSlot(slotKey, idx, f);
                    });

                    // drag & drop
                    el.addEventListener("dragover", (e)=> { e.preventDefault(); el.style.background="rgba(255,255,255,0.02)"; });
                    el.addEventListener("dragleave", (e)=> { el.style.background=""; });
                    el.addEventListener("drop", (e)=> {
                        e.preventDefault();
                        el.style.background="";
                        const files = Array.from(e.dataTransfer.files).filter(ff => ff.type.startsWith("image/"));
                        if(files.length) manejarArchivoSlot(slotKey, idx, files[0]);
                    });
                }
            });
        }

        // estructura para almacenar archivos en memoria antes del submit
        const uploadState = {
            slots: {},     // { "9_1": [File,...] }
            activities: {} // { "10_1": {1:{antes:File,despues:File}, ...} }
        };

        function manejarArchivoSlot(slotKey, idx, file){
            if(!file) return;
            const ext = file.name.split(".").pop().toLowerCase();
            if(!["jpg","jpeg","png"].includes(ext)){
                alert("Formato no permitido. Solo JPG/PNG.");
                return;
            }
            if(file.size > (6*1024*1024)){
                alert("Archivo demasiado grande (>6MB).");
                return;
            }
            uploadState.slots[slotKey] = uploadState.slots[slotKey] || [];
            uploadState.slots[slotKey][idx-1] = file;
            renderThumbSlot(slotKey, idx);
        }

        function renderThumbSlot(slotKey, idx){
            const uploadId = `${slotKey}__${idx}`;
            const el = document.getElementById(`slot_upload_${uploadId}`);
            if(!el) return;
            const prevImg = el.querySelector("img");
            if(prevImg) prevImg.remove();
            const prevBtn = el.querySelector(".delete-img");
            if(prevBtn) prevBtn.remove();

            const file = uploadState.slots[slotKey] && uploadState.slots[slotKey][idx-1];
            if(file){
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.style.width = "100%"; img.style.height="90px"; img.style.objectFit="cover";
                el.appendChild(img);
                const btn = document.createElement("button");
                btn.className = "delete-img";
                btn.innerText = "×";
                btn.onclick = (ev)=> { ev.stopPropagation(); eliminarArchivoSlot(slotKey, idx); };
                el.appendChild(btn);
            }
        }

        function eliminarArchivoSlot(slotKey, idx){
            if(uploadState.slots[slotKey]) uploadState.slots[slotKey][idx-1] = null;
            const uploadId = `${slotKey}__${idx}`;
            const el = document.getElementById(`slot_upload_${uploadId}`);
            if(!el) return;
            const img = el.querySelector("img"); if(img) img.remove();
            const btn = el.querySelector(".delete-img"); if(btn) btn.remove();
        }

        /* ======================================================= */
        /*   ACTIVIDADES 10.x (ANTES / DESPUÉS)                   */
        /* ======================================================= */

        const containerActividades = document.getElementById("containerActividades");

        async function cargarActividadesSegunSlots(){
            if(!currentSlots.length){
                await cargarYRenderizarSlots();
            }
            containerActividades.innerHTML = "";

            const actividadesSlots = currentSlots.filter(s => s.tipo === "actividad" || (s.code && s.code.startsWith("10.")));
            actividadesSlots.forEach(s => {
                const slotKey = s.code.replace(".", "_");
                const div = document.createElement("div");
                div.className = "foto-slot";
                div.id = `actividad_wrap_${slotKey}`;

                div.innerHTML = `
                    <h3 style="margin:0 0 8px 0;color:var(--accent)">
                        ${s.code} · ${s.label}
                    </h3>

                    <div>
                        <button class="btn-add" onclick="agregarActividad('${slotKey}')">
                            + Agregar Actividad
                        </button>
                    </div>

                    <div id="lista_acts_${slotKey}" style="margin-top:10px"></div>
                `;

                containerActividades.appendChild(div);
            });
        }

        function agregarActividad(slotKey){
            uploadState.activities[slotKey] = uploadState.activities[slotKey] || {};
            const actIndex = Object.keys(uploadState.activities[slotKey]).length + 1;

            uploadState.activities[slotKey][actIndex] = { antes: null, despues: null };

            const cont = document.getElementById(`lista_acts_${slotKey}`);
            const actDiv = document.createElement("div");
            actDiv.className = "activity-block";
            actDiv.id = `act_${slotKey}_${actIndex}`;

            actDiv.innerHTML = `
                <div class="activity-title">(Actividad ${actIndex})</div>
                <div class="form-row">
                    <label>Descripción:</label>
                    <textarea id="desc_${slotKey}_${actIndex}" placeholder="Describa el trabajo realizado"></textarea>
                </div>

                <div style="display:flex;gap:14px;flex-wrap:wrap">
                    <div class="slot-upload" id="antes_${slotKey}_${actIndex}">
                        <div class="slot-title">Foto ANTES</div>
                        <input type="file" accept="image/png,image/jpeg" onchange="subirAntes('${slotKey}',${actIndex},this.files[0])">
                    </div>

                    <div class="slot-upload" id="desp_${slotKey}_${actIndex}">
                        <div class="slot-title">Foto DESPUÉS</div>
                        <input type="file" accept="image/png,image/jpeg" onchange="subirDespues('${slotKey}',${actIndex},this.files[0])">
                    </div>
                </div>

                <div style="margin-top:8px">
                    <button class="btn-danger" onclick="eliminarActividad('${slotKey}',${actIndex})">Eliminar Actividad</button>
                </div>
            `;

            cont.appendChild(actDiv);
        }

        function subirAntes(slotKey, actIndex, file){
            if(!validarImagen(file)) return;
            uploadState.activities[slotKey][actIndex].antes = file;
            renderPreviewActividad(slotKey, actIndex, "antes");
        }

        function subirDespues(slotKey, actIndex, file){
            if(!validarImagen(file)) return;
            uploadState.activities[slotKey][actIndex].despues = file;
            renderPreviewActividad(slotKey, actIndex, "despues");
        }

        function renderPreviewActividad(slotKey, actIndex, tipo){
            const divId = `${tipo}_${slotKey}_${actIndex}`;
            const el = document.getElementById(divId);
            if(!el) return;

            const oldImg = el.querySelector("img"); if(oldImg) oldImg.remove();
            const oldBtn = el.querySelector(".delete-img"); if(oldBtn) oldBtn.remove();

            const file = uploadState.activities[slotKey][actIndex][tipo];
            if(!file) return;

            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.style.width = "100%";
            img.style.height = "90px";
            img.style.objectFit = "cover";
            el.appendChild(img);

            const del = document.createElement("button");
            del.className = "delete-img";
            del.textContent = "×";
            del.onclick = (ev)=>{
                ev.stopPropagation();
                uploadState.activities[slotKey][actIndex][tipo] = null;
                renderPreviewActividad(slotKey, actIndex, tipo);
            };
            el.appendChild(del);
        }

        function eliminarActividad(slotKey, actIndex){
            delete uploadState.activities[slotKey][actIndex];
            const el = document.getElementById(`act_${slotKey}_${actIndex}`);
            if(el) el.remove();
        }

        function validarImagen(file){
            if(!file) return false;
            const ext = file.name.split(".").pop().toLowerCase();
            if(!["jpg","jpeg","png"].includes(ext)){
                alert("Formato no permitido. Debe ser JPG o PNG.");
                return false;
            }
            if(file.size > 6*1024*1024){
                alert("Archivo excede el límite de 6MB.");
                return false;
            }
            return true;
        }

        /* ======================================================= */
        /*   CONSTRUIR PAYLOAD COMPLETO (incluye actividades)      */
        /* ======================================================= */

        function construirPayloadCompleto(){
            const payload = construirPayloadBasico();

            payload.actividades = {};
            for(const slotKey in uploadState.activities){
                const code = slotKey.replace("_",".");
                payload.actividades[code] = [];
                const acts = uploadState.activities[slotKey];
                for(const actIndex in acts){
                    const descEl = document.getElementById(`desc_${slotKey}_${actIndex}`);
                    const descripcion = descEl ? descEl.value : "";
                    payload.actividades[code].push({
                        descripcion
                    });
                }
            }
            return payload;
        }

        /* ======================================================= */
        /*   PREPARAR FormData PARA /generar (con imágenes)        */
        /* ======================================================= */

        function construirFormData(payload){
            const fd = new FormData();
            fd.append("payload", JSON.stringify(payload));

            // Adjuntar fotos 9.x
            for(const slotKey in uploadState.slots){
                const arr = uploadState.slots[slotKey];
                if(!arr) continue;
                arr.forEach((file,idx)=>{
                    if(!file) return;
                    const key = `photo__${slotKey}__${idx+1}`;
                    fd.append(key, file);
                });
            }

            // Adjuntar fotos de actividades 10.x
            for(const slotKey in uploadState.activities){
                const acts = uploadState.activities[slotKey];
                for(const actIndex in acts){
                    const obj = acts[actIndex];
                    if(obj.antes){
                        const keyA = `photo__${slotKey}__act${actIndex}__antes`;
                        fd.append(keyA, obj.antes);
                    }
                    if(obj.despues){
                        const keyB = `photo__${slotKey}__act${actIndex}__despues`;
                        fd.append(keyB, obj.despues);
                    }
                }
            }

            return fd;
        }

        /* ======================================================= */
        /*   ENVÍO FINAL: Generar .docx y descargar                */
        /* ======================================================= */

        let slotsLoaded = false;
        const btnGenerar = document.getElementById("btnGenerarDoc");
        const estadoEl = document.getElementById("estadoGeneracion");

        btnGenerar.addEventListener("click", async () => {
            try {
                btnGenerar.disabled = true;

                if (!slotsLoaded) {
                    estadoEl.innerText = "Solicitando subtítulos al servidor...";
                    await cargarYRenderizarSlots();
                    await cargarActividadesSegunSlots();
                    slotsLoaded = true;
                    estadoEl.innerText = "Subtítulos cargados. Sube las fotos y actividades. Cuando estés listo vuelve a presionar GENERAR.";
                    btnGenerar.innerText = "Confirmar y Generar documento";
                    btnGenerar.disabled = false;
                    return;
                }

                estadoEl.innerText = "Preparando documento...";
                const nombre = document.getElementById("c_nombre").value || "";
                const fecha = document.getElementById("c_fecha").value || "";
                const tanquesCount = document.querySelectorAll(".tank-block").length;
                if (!nombre || !fecha || tanquesCount === 0) {
                    alert("Faltan datos obligatorios: Nombre, Fecha o al menos 1 tanque.");
                    btnGenerar.disabled = false;
                    return;
                }

                const payload = construirPayloadCompleto();
                const fd = construirFormData(payload);

                estadoEl.innerText = "Enviando datos al servidor (esto puede tardar)...";
                btnGenerar.innerText = "Generando...";

                const res = await fetch("/generar", {
                    method: "POST",
                    body: fd
                });

                if (!res.ok) {
                    let txt;
                    try { txt = await res.json(); } catch { txt = await res.text(); }
                    console.error("Error respuesta /generar", txt);
                    alert("Error generando documento: " + (typeof txt === "string" ? txt : JSON.stringify(txt)));
                    estadoEl.innerText = "Error en generación. Revisa la consola.";
                    btnGenerar.innerText = "Confirmar y Generar documento";
                    btnGenerar.disabled = false;
                    return;
                }

                const blob = await res.blob();
                const filenameHeader = res.headers.get("Content-Disposition") || "";
                let suggestedName = "Informe_Mantenimiento.docx";
                try {
                    const m = /filename="?([^"]+)"?/.exec(filenameHeader);
                    if (m && m[1]) suggestedName = m[1];
                } catch (e) { }

                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = suggestedName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);

                estadoEl.innerText = "Documento generado y descargado correctamente.";
                btnGenerar.innerText = "Generar documento";
                btnGenerar.disabled = false;

            } catch (err) {
                console.error("Error en generación:", err);
                alert("Error inesperado: " + err.message);
                estadoEl.innerText = "Error inesperado. Revisa la consola.";
                btnGenerar.disabled = false;
                btnGenerar.innerText = "Confirmar y Generar documento";
            }
        });

        // Doble click en título limpia uploads (utilidad)
        try {
            document.querySelector("h1").addEventListener("dblclick", ()=> {
                if(confirm("¿Limpiar archivos cargados?")) {
                    uploadState.slots = {};
                    uploadState.activities = {};
                    document.querySelectorAll("[id^='slot_upload_']").forEach(el=>{
                        const img = el.querySelector("img"); if(img) img.remove();
                        const btn = el.querySelector(".delete-img"); if(btn) btn.remove();
                    });
                    document.querySelectorAll("[id^='antes_'], [id^='desp_']").forEach(el=>{
                        const img = el.querySelector("img"); if(img) img.remove();
                        const btn = el.querySelector(".delete-img"); if(btn) btn.remove();
                    });
                    estadoEl.innerText = "Archivos borrados.";
                }
            });
        } catch(e){/* ignore */}

    </script>

</body>
</html>
