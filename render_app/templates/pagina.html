<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solgas ¬∑ Inspecci√≥n GLP</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg-1:#030419;
  --bg-2:#042133;
  --accent:#00d2ff;
  --gold:#f6b73c;
  --card:#071827;
  --input-bg:#ffffff;
  --muted:#9fdcff;
  --label:#2b2b2b;
  --input-text-dark:#041018;
  --danger:#ff6b6b;
  --radius:12px;
  --glass: rgba(255,255,255,0.03);
  --panel:#071827;
  --light-card-bg:#f7fbff;
}
*{box-sizing:border-box;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#e6f7ff}
html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:24px auto;padding:18px;border-radius:14px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:800;box-shadow:0 10px 30px rgba(0,194,255,0.07)}
.title{font-size:20px;margin:0}
.lead{color:var(--muted);font-size:13px;margin:0}

/* PROGRESS BAR (fixed top) */
#topProgressWrap{position:fixed;left:0;right:0;top:0;height:8px;background:rgba(255,255,255,0.06);z-index:120;border-bottom:1px solid rgba(255,255,255,0.02)}
#topProgress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--gold));transition:width .3s ease}

/* layout */
.app{display:grid;grid-template-columns:320px 1fr;gap:18px;padding-top:12px}
/* sidebar */
.sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03)}
.userbox{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.user-company{font-weight:700;color:#eafcff}
.navlist{margin-top:8px}
.nav-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .12s}
.nav-item.disabled{opacity:.45;cursor:not-allowed}
.nav-item.active{background:linear-gradient(90deg, rgba(0,194,255,0.06), rgba(246,183,60,0.03)); border:1px solid rgba(0,194,255,0.08)}
.status{font-size:13px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted)}

/* main */
.main{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.02)}
.step{display:none}
.step.active{display:block; animation:fadeIn .26s ease both}
@keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.card-title{font-weight:700; color:var(--accent)}
.hint{font-size:13px;color:var(--muted);opacity:.95}

/* fields */
.row{display:grid;gap:10px}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:1fr 1fr 1fr}
.field{background:var(--input-bg); border-radius:10px; padding:8px; display:flex; align-items:center; gap:8px; border:1px solid rgba(0,0,0,0.06)}
.field input, .field textarea, .field select{border:none;background:transparent;width:100%;outline:none;color:var(--input-text-dark);font-size:14px}
.label{font-size:12px;color:var(--accent);margin-bottom:6px;font-weight:700}
.small{font-size:12px;color:var(--muted)}

/* buttons */
.controls{display:flex;gap:10px;margin-top:12px;align-items:center}
.btn{padding:10px 14px;border-radius:999px;border:none;font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent), #6efcff); color:#041018; box-shadow:0 14px 40px rgba(0,194,255,0.08)}
.btn.ghost{background:#ffffff;border:1px solid rgba(0,0,0,0.06); color:#041018}
.btn.warn{background:linear-gradient(90deg,var(--gold), #ffd36b); color:#081017}
.btn.danger{background:var(--danger); color:#041018}
.btn.small{padding:6px 10px;border-radius:8px;font-weight:600}

/* lists */
.list{margin-top:8px}
.tank-card{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.18)); border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,0.02); margin-bottom:10px; display:flex;justify-content:space-between;align-items:center}
.tank-info{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;width:85%}
.tank-actions{display:flex;gap:8px;align-items:center}

/* modal (accessories edit) */
.modal-back{position:fixed;inset:0;background:rgba(2,6,10,0);display:none;align-items:center;justify-content:center;z-index:60;padding:20px}
.modal-back.active{display:flex ; color: #041018 }
.modal{background:#ffffff;border-radius:12px;width:980px;max-width:98%;padding:16px;color:#041018;box-shadow:0 18px 50px rgba(2,6,20,0)}
.modal h3{margin:0 0 8px 0 ; color : var(--accent) }
.modal .field input{color:#041018}

/* modal table */
.acc-table{width:100%;border-collapse:collapse;margin-top:8px}
.acc-table th,.acc-table td{border:1px solid #ddd;padding:6px;text-align:center}
.acc-table th{background:#f3f3f3;color:#041018;font-weight:700}

/* invalid */
.invalid{border-color:#ff5b6b !important; box-shadow:0 6px 24px rgba(255,91,107,0.07)}
.errlist{color:#ff9aa2; margin-top:8px; font-weight:700}

/* accessory badges */
.badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:700;color:var(--muted);font-size:12px}

/* inline actions */
.inline-actions{display:flex;gap:8px;align-items:center}

/* select styling for good contrast */
select.custom-select{background:#ffffff;color:#041018;padding:8px;border-radius:8px;border:1px solid #cfeef8;outline:none}
select.custom-select option{color:#041018;background:#ffffff}

/* contrast input text on dark mini cards */
.card-dark{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.18));padding:10px;border-radius:8px;color:#ffffff}

/* accessory header dark */
.acc-header{font-weight:800;color:#041018;background:#f3f3f3;padding:8px;border-radius:8px;display:inline-block;margin-bottom:8px}

/* responsive */
@media (max-width:980px){ .app{grid-template-columns:1fr} .tank-info{grid-template-columns:repeat(2,1fr);width:60%} }

/* LOGIN overlay */
#loginOverlay{position:fixed;inset:0;background:linear-gradient(160deg,var(--bg-1),var(--bg-2));display:flex;align-items:center;justify-content:center;z-index:200}
#loginCard{width:520px;max-width:95%;background:#ffffff;border-radius:12px;padding:20px;color:#041018;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.login-title{font-weight:800;font-size:20px;margin-bottom:6px ; color:#6b7280 }
.login-sub{color:#6b7280;margin-bottom:12px}
.login-field .field{background:#f3f7fb}
.login-err{color:var(--danger);margin-top:10px;font-weight:700}

/* ensure modal inputs and table texts are dark on white background */
.modal input, .modal select, .modal textarea { color: #041018; background: #fff; border:1px solid #e6eef3; padding:6px; border-radius:6px }

/* ensure acc-list table contrast */
#acc-list table th, #acc-list table td {color:var(--accent) }
#acc-list input { color:#041018; background:#fff; border:1px solid #e6eef3; padding:6px; border-radius:6px; width:100% }

td.accesorio {
	color : #041018 !important;
}

/* Photo preview modal (new) */
#photoPreviewModal{display:none;position:fixed;inset:0;background:rgba(2,6,10,0.6);display:flex;align-items:center;justify-content:center;z-index:150}
#photoPreviewModal .modal{max-width:1000px; width:94%; max-height:88vh; overflow:auto}
.preview-card{border-radius:8px;overflow:hidden;border:1px solid rgba(0,0,0,0.06); background:#fff; color:#041018}
.preview-card img{width:100%;height:160px;object-fit:cover}

/* photo table small button */
.photo-action-btn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;margin-right:6px}

/* small helpers */
.hidden{display:none}
</style>
</head>
<body>
  <!-- Top progress bar -->
  <div id="topProgressWrap"><div id="topProgress"></div></div>

  <!-- Login overlay -->
  <div id="loginOverlay" role="dialog" aria-modal="true">
    <div id="loginCard">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:800">SG</div>
        <div>
          <div class="login-title">Acceso - SOLGAS</div>
          <div class="login-sub">Ingresa con tu correo corporativo y el nombre de empresa.</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="label">Correo corporativo</div>
        <div class="login-field field"><input id="loginEmail" type="email" placeholder="usuario@solgas.com.pe"></div>

        <div class="label" style="margin-top:8px">Empresa</div>
        <div class="login-field field"><input id="loginCompany" type="text" placeholder="Solgas"></div>

        <div class="login-err" id="loginErr" style="display:none"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn ghost" onclick="loginCancel()">Salir</button>
          <button class="btn primary" id="loginBtn" onclick="doLogin()">Ingresar</button>
        </div>
      </div>
    </div>
  </div>

<div class="container" id="mainContainer" style="display:block;margin-top:18px">
  <div class="header">
    <div class="logo">SOLGAS</div>
    <div>
      <div class="title">Solgas ¬∑ Inspecci√≥n GLP</div>
      <div class="lead">Formulario interactivo ‚Äî completa paso a paso y genera el informe Word</div>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
      <button class="btn ghost" id="downloadTemplateBtn">Plantilla</button>
      <button class="btn primary" id="btnGenerate" onclick="showStep(6)">Generar Word</button>
    </div>
  </div>

  <div id="app" class="app" style="display:block; margin-top:10px">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="userbox">
        <div style="width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:700" id="userInitials">SG</div>
        <div>
          <div id="sidebarCompany" class="user-company">Empresa</div>
          <div id="sidebarEmail" class="small">correo@dominio.com</div>
        </div>
      </div>

      <div style="font-weight:700;color:var(--muted);margin-bottom:8px">Secciones</div>
      <div id="navlist" class="navlist">
        <div class="nav-item active" data-step="1" onclick="navTo(1)">
          <div>1 ¬∑ Informaci√≥n general</div>
          <div class="status" id="status-1">Obligatorio</div>
        </div>
        <div class="nav-item" data-step="2" onclick="navTo(2)">
          <div>2 ¬∑ Tanques</div>
          <div class="status" id="status-2">0 tanques</div>
        </div>
        <div class="nav-item" data-step="3" onclick="navTo(3)">
          <div>3 ¬∑ Accesorios por tanque</div>
          <div class="status" id="status-3">‚Äî</div>
        </div>
        <div class="nav-item" data-step="4" onclick="navTo(4)">
          <div>4 ¬∑ Accesorios en redes</div>
          <div class="status" id="status-4">‚Äî</div>
        </div>
        <div class="nav-item" data-step="5" onclick="navTo(5)">
          <div>5 ¬∑ Equipos</div>
          <div class="status" id="status-5">‚Äî</div>
        </div>
        <div class="nav-item" data-step="6" onclick="navTo(6)">
          <div>6 ¬∑ Observaciones & Final</div>
          <div class="status" id="status-6">‚Äî</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn primary" onclick="handleGenerate()">üì§ Generar</button>
        <button class="btn ghost" onclick="resetApp()">Reiniciar</button>
      </div>

      <div style="margin-top:12px;font-size:13px;color:var(--muted)">Progreso: <span id="progressLabel">0 / 8</span></div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- STEP 1 -->
      <section id="step-1" class="step active">
        <div class="card-header">
          <div>
            <div class="card-title">1 ¬∑ Informaci√≥n general por instalaci√≥n</div>
            <div class="hint">Completa los 11 campos obligatorios para continuar.</div>
          </div>
          <div><span class="hint">Paso 1 / 8</span></div>
        </div>

      <!-- (Aqu√≠ contin√∫a el resto del formulario en la Parte 2) -->
	<!-- ====================== -->
      <!--  STEP 1 ‚Äî INFORMACI√ìN  -->
      <!-- ====================== -->
      <div class="row cols-3" style="margin-top:12px">

        <div>
          <div class="label">Cliente</div>
          <div class="field"><input id="cliente" type="text" placeholder="Nombre del cliente"></div>
        </div>

        <div>
          <div class="label">Direcci√≥n</div>
          <div class="field"><input id="direccion" type="text" placeholder="Direcci√≥n completa"></div>
        </div>

        <div>
          <div class="label">Distrito</div>
          <div class="field"><input id="distrito" type="text" placeholder="Distrito"></div>
        </div>

        <div>
          <div class="label">Departamento</div>
          <div class="field"><input id="departamento" type="text" placeholder="Departamento"></div>
        </div>

        <div>
          <div class="label">Provincia</div>
          <div class="field"><input id="provincia" type="text" placeholder="Provincia"></div>
        </div>

        <div>
          <div class="label">Fecha evaluaci√≥n</div>
          <div class="field"><input id="fechaEval" type="date"></div>
        </div>

        <div>
          <div class="label">Nombre t√©cnico(s)</div>
          <div class="field"><input id="tecnicos" type="text" placeholder="Ej: Juan P√©rez / Mar√≠a D√≠az"></div>
        </div>

        <div>
          <div class="label">Contacto</div>
          <div class="field"><input id="contacto" type="text" placeholder="Persona de contacto"></div>
        </div>

        <div>
          <div class="label">N√∫mero de contacto</div>
          <div class="field"><input id="numeroContacto" type="text" placeholder="987654321"></div>
        </div>

        <div>
          <div class="label">Tipo de instalaci√≥n</div>
          <div class="field">
            <select id="tipoInst" class="custom-select">
              <option value="">Seleccionar</option>
              <option value="Tanque estacionario">Tanque estacionario</option>
              <option value="Cilindros">Cilindros</option>
              <option value="Mixto">Mixto</option>
            </select>
          </div>
        </div>

        <div>
          <div class="label">Raz√≥n social</div>
          <div class="field"><input id="ruc" type="text" placeholder="RUC o raz√≥n social"></div>
        </div>

        <div>
          <div class="label">Observaciones iniciales</div>
          <div class="field"><textarea id="obsIniciales" placeholder="Anotaciones generales" rows="3"></textarea></div>
        </div>

      </div>

      <div class="controls">
        <button class="btn primary" onclick="validateStep1()">Continuar ‚Üí</button>
      </div>
    </section>


    <!-- ====================== -->
    <!--        STEP 2         -->
    <!--    REGISTRO TANQUES   -->
    <!-- ====================== -->
    <section id="step-2" class="step">
      <div class="card-header">
        <div>
          <div class="card-title">2 ¬∑ Registro de tanques</div>
          <div class="hint">Agrega todos los tanques presentes en la instalaci√≥n.</div>
        </div>
        <div><span class="hint">Paso 2 / 8</span></div>
      </div>

      <div class="row cols-3">
        <div>
          <div class="label">C√≥digo tanque</div>
          <div class="field"><input id="tk_cod" placeholder="Ej: TK-01"></div>
        </div>

        <div>
          <div class="label">Capacidad (gal)</div>
          <div class="field"><input id="tk_cap" type="number" placeholder="Ej: 120"></div>
        </div>

        <div>
          <div class="label">N√∫mero de serie</div>
          <div class="field"><input id="tk_serie" placeholder="Serie"></div>
        </div>

        <div>
          <div class="label">A√±o fabricaci√≥n</div>
          <div class="field"><input id="tk_fab" type="number"></div>
        </div>

        <div>
          <div class="label">Estado pintura</div>
          <div class="field">
            <select id="tk_pintura" class="custom-select">
              <option value="">Seleccionar</option>
              <option>Buena</option>
              <option>Regular</option>
              <option>Mala</option>
            </select>
          </div>
        </div>

        <div>
          <div class="label">Ubicaci√≥n</div>
          <div class="field"><input id="tk_ubic" placeholder="Ej: Exterior / Interior"></div>
        </div>

      </div>

      <div class="controls">
        <button class="btn ghost" onclick="clearTankForm()">Limpiar</button>
        <button class="btn primary" onclick="addTank()">Agregar tanque</button>
      </div>

      <div id="tankList" class="list" style="margin-top:16px"></div>

      <div class="controls">
        <button class="btn primary" onclick="continueStep2()">Continuar ‚Üí</button>
      </div>

    </section>


    <!-- ====================== -->
    <!--        STEP 3         -->
    <!-- ACCESORIOS POR TANQUE -->
    <!-- ====================== -->
    <section id="step-3" class="step">
      <div class="card-header">
        <div>
          <div class="card-title">3 ¬∑ Accesorios por tanque</div>
          <div class="hint">Completa los accesorios y condiciones para cada tanque registrado.</div>
        </div>
        <div><span class="hint">Paso 3 / 8</span></div>
      </div>

      <div id="accTanksContainer"></div>

      <div class="controls">
        <button class="btn primary" onclick="continueStep3()">Continuar ‚Üí</button>
      </div>
    </section>
	<!-- ====================== -->
    <!--        STEP 4         -->
    <!--    ACCESORIOS RED     -->
    <!-- ====================== -->
    <section id="step-4" class="step">
      <div class="card-header">
        <div>
          <div class="card-title">4 ¬∑ Accesorios en redes</div>
          <div class="hint">Registra los accesorios instalados en la red de llenado y consumo.</div>
        </div>
        <div><span class="hint">Paso 4 / 8</span></div>
      </div>

      <div style="margin-top:12px">
        <div class="label">¬øExisten accesorios en la red?</div>
        <div class="field">
          <select id="hayAccRed" class="custom-select" onchange="toggleAccRed()">
            <option value="">Seleccionar</option>
            <option value="Si">S√≠</option>
            <option value="No">No</option>
          </select>
        </div>
      </div>

      <div id="accRedContainer" class="hidden" style="margin-top:16px">
        <div class="card-dark" style="padding:10px;margin-bottom:10px">
          <div class="label" style="color:#fff">Agregar accesorio</div>
          <div class="row cols-3">

            <div>
              <div class="label">Tipo accesorio</div>
              <div class="field">
                <select id="accRedTipo" class="custom-select">
                  <option value="">Seleccionar</option>
                  <option value="Pull away">Pull away</option>
                  <option value="1ra etapa">1ra etapa</option>
                  <option value="2da etapa">2da etapa</option>
                  <option value="Regulador">Regulador</option>
                  <option value="V√°lvula de exceso de flujo">V√°lvula exceso de flujo</option>
                  <option value="Prensa estopero / Otros">Prensa estopero / Otros</option>
                </select>
              </div>
            </div>

            <div>
              <div class="label">Estado</div>
              <div class="field">
                <select id="accRedEstado" class="custom-select">
                  <option value="">Seleccionar</option>
                  <option>Buen estado</option>
                  <option>Deteriorado</option>
                  <option>Requiere cambio</option>
                </select>
              </div>
            </div>

            <div>
              <div class="label">Cantidad</div>
              <div class="field"><input id="accRedCant" type="number" placeholder="0"></div>
            </div>

          </div>

          <div class="controls">
            <button class="btn ghost" onclick="clearAccRedForm()">Limpiar</button>
            <button class="btn primary" onclick="addAccRed()">Agregar accesorio</button>
          </div>

        </div>

        <div id="accRedList" class="list"></div>
      </div>

      <div class="controls">
        <button class="btn primary" onclick="continueStep4()">Continuar ‚Üí</button>
      </div>

    </section>


    <!-- ====================== -->
    <!--        STEP 5         -->
    <!--        EQUIPOS        -->
    <!-- ====================== -->
    <section id="step-5" class="step">
      <div class="card-header">
        <div>
          <div class="card-title">5 ¬∑ Equipos adicionales</div>
          <div class="hint">Agrega equipos relacionados a la instalaci√≥n.</div>
        </div>
        <div><span class="hint">Paso 5 / 8</span></div>
      </div>

      <div class="card-dark" style="padding:14px;margin-bottom:16px">
        <div class="label" style="color:#fff">Agregar equipo</div>

        <div class="row cols-3" style="margin-bottom:12px">
          <div>
            <div class="label">Tipo de equipo</div>
            <div class="field">
              <select id="eq_tipo" class="custom-select" onchange="renderEquipoDynFields()">
                <option value="">Seleccionar</option>
                <option value="vaporizador">Vaporizador</option>
                <option value="quemador">Quemador</option>
                <option value="calentador">Calentador</option>
                <option value="otros">Otros</option>
              </select>
            </div>
          </div>

          <div>
            <div class="label">Nombre del equipo</div>
            <div class="field"><input id="eq_name" placeholder="Ej: Vaporizador 300kg/h"></div>
          </div>

        </div>

        <div id="dynamicFields" class="row cols-3"></div>

        <div class="controls">
          <button class="btn ghost" onclick="clearEquipoForm()">Limpiar</button>
          <button class="btn primary" onclick="addEquipo()">Agregar equipo</button>
        </div>
      </div>

      <!-- LISTA DE EQUIPOS (corregido para que SI se muestre) -->
      <div id="equiposList" class="list" style="margin-top:10px"></div>

      <div class="controls">
        <button class="btn primary" onclick="continueStep5()">Continuar ‚Üí</button>
      </div>

    </section>


    <!-- ====================== -->
    <!--        STEP 6         -->
    <!--   OBSERVACIONES       -->
    <!-- ====================== -->
    <section id="step-6" class="step">
      <div class="card-header">
        <div>
          <div class="card-title">6 ¬∑ Observaciones finales</div>
          <div class="hint">Agrega comentarios adicionales relevantes.</div>
        </div>
        <div><span class="hint">Paso 6 / 8</span></div>
      </div>

      <div style="margin-top:12px">
        <div class="label">Observaciones generales</div>
        <div class="field"><textarea id="obsFinales" rows="4" placeholder="Observaciones finales‚Ä¶"></textarea></div>
      </div>

      <div class="controls">
        <button class="btn primary" onclick="prepareActividades()">Continuar ‚Üí Fotos y actividades</button>
      </div>

    </section>
	<!-- ====================================================== -->
    <!--                STEP 7 ‚Äì ACTIVIDADES (PUNTO 10)         -->
    <!-- ====================================================== -->
    <section id="step-7" class="step">
      <div class="card-header">
        <div>
          <div class="card-title">7 ¬∑ Trabajos realizados (Punto 10)</div>
          <div class="hint">Agrega actividades de mantenimiento por tanque.</div>
        </div>
        <div><span class="hint">Paso 7 / 8</span></div>
      </div>

      <div id="actividadesContainer"></div>

      <div class="controls">
        <button class="btn primary" onclick="goFotos()">Continuar ‚Üí Evidencia</button>
      </div>
    </section>


    <!-- ====================================================== -->
    <!--             STEP 8 ‚Äì SUBIDA DE FOTOS (PUNTOS 8 y 9)    -->
    <!-- ====================================================== -->
    <section id="step-8" class="step">
      <div class="card-header">
        <div>
          <div class="card-title">8 ¬∑ Evidencia fotogr√°fica</div>
          <div class="hint">Sube las fotos correspondientes a cada subt√≠tulo requerido.</div>
        </div>
        <div><span class="hint">Paso 8 / 8</span></div>
      </div>

      <div id="fotosContainer"></div>

      <div class="controls">
        <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
        <button class="btn primary" onclick="enviarInforme()">Generar informe</button>
      </div>

    </section>
	<script>
/* -------------------------
   Allowed emails (client-side)
   ------------------------- */
const allowedEmails = [
  "alexander.buleje@solgas.com.pe",
  "renzo.delgado@solgas.com.pe",
  "ingenieriaeye@hotmail.com",
  "jarmas@inginor.com.pe",
  "Jaime.valdeiglesias16@totalgassac.com",
  "area.mantenimiento@gsgasperu.com",
  "mantenimiento@cmagol.com.pe",
  "aherrera@gypingenieros.com",
  "iserrepe@openersac.com",
  "operacionesglp@northcompany.com.pe",
  "ingenieria1@semmaq.com",
  "administracion@citecservices.com"
];

/* -------------------------
   Application state
   ------------------------- */
let currentStep = 1;
const TOTAL_STEPS = 8;

let generalInfo = {};
let tanks = [];
let accessoriesByTank = {};
let redes = [];
let zona_medidores_val = null;
let equipos = [];
let actividades = [];

let photoSubtitles = []; // {id, title, required, isActivity, meta: {type, tankIndex, accessoryName, equipoIndex}}
let photosBySubtitle = {}; // {subId: [ {file, role, genName} ]}

/* estructura_equipos */
const estructuraEquipos = {
  "vaporizador": ["Equipo", "Marca", "Tipo", "Serie", "A√±o de fabricaci√≥n", "Capacidad"],
  "quemador": ["Equipo", "Marca", "Modelo", "Tipo", "Serie", "A√±o de fabricaci√≥n", "Capacidad (kW)"],
  "decantador": ["Equipo", "Fabricante", "Modelo", "Tipo", "Serie", "A√±o de fabricaci√≥n", "Capacidad (gal)"],
  "dispensador_de_gas": ["Equipo", "Marca", "Modelo", "Serie"],
  "bomba": ["Equipo", "Marca", "Modelo", "Serie"],
  "tablero": ["Equipo", "TAG"],
  "estabilizador": ["Equipo", "Marca", "Modelo", "Serie"],
  "detector": ["Equipo", "Marca", "Modelo", "Serie"],
  "extintor": ["Equipo", "Marca", "Serie", "A√±o de fabricaci√≥n", "Pr√≥xima PH", "Fecha de pr√≥xima recarga"]
};

const accesoriosFijos = [
  "V√°lvula de llenado", "Medidor de porcentaje", "V√°lvula de seguridad",
  "V√°lvula de drenaje", "Multiv√°lvula"
];
const accesoriosOpcionales = [
  "V√°lvula exceso de flujo (Retorno)",
  "V√°lvula exceso de flujo (Bypass)",
  "Val 3"
];

/* -------------------------
   UI helpers
   ------------------------- */
function updateProgressUI() {
  document.getElementById('progressLabel').innerText = `${currentStep} / ${TOTAL_STEPS}`;
  const percent = Math.round(((currentStep-1)/(TOTAL_STEPS-1))*100);
  document.getElementById('topProgress').style.width = percent + '%';
  document.getElementById('status-2').innerText = `${tanks.length} tanques`;
}

function showStep(n) {
  currentStep = n;
  for (let i=1;i<=TOTAL_STEPS;i++){
    const stepEl = document.getElementById(`step-${i}`);
    if(stepEl) stepEl.classList.remove('active');
    const nav = document.querySelector(`.nav-item[data-step="${i}"]`);
    if(nav) nav.classList.remove('active');
  }
  const target = document.getElementById(`step-${n}`);
  if(target) target.classList.add('active');
  const navActive = document.querySelector(`.nav-item[data-step="${n}"]`);
  if(navActive) navActive.classList.add('active');
  updateProgressUI();
  if(n === 7) renderActividadesUI();
  if(n === 8) buildPhotoSubtitles();
}

/* -------------------------
   Login
   ------------------------- */
function doLogin(){
  const email = (document.getElementById('loginEmail').value || '').trim().toLowerCase();
  const company = (document.getElementById('loginCompany').value || '').trim();
  const err = document.getElementById('loginErr');
  if(!email || !company){ err.style.display='block'; err.innerText = 'Correo y Empresa son obligatorios.'; return; }
  if(!allowedEmails.includes(email)){
    err.style.display='block'; err.innerText = 'Correo no autorizado.';
    return;
  }
  document.getElementById('loginOverlay').remove();
  document.getElementById('sidebarCompany').innerText = company;
  document.getElementById('sidebarEmail').innerText = email;
  document.getElementById('userInitials').innerText = company.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
  updateProgressUI();
}
function loginCancel(){ alert('Salida de la aplicaci√≥n.'); document.getElementById('loginOverlay').style.display='none'; document.body.innerHTML = '<div style="padding:40px;font-family:Arial;">Acceso cancelado.</div>'; }

/* -------------------------
   Step1 - general
   ------------------------- */
function saveGeneral(showMsg=false){
  const required = [
    "g_nombre","g_fecha","g_direccion","g_ruc","g_numinst","g_distrito",
    "g_departamento","g_coordenadas","g_contacto","g_telefono","g_correo"
  ];
  const missing = required.filter(id => {
    const el = document.getElementById(id);
    return !el || !String(el.value || '').trim();
  });
  if(missing.length){
    document.getElementById('err-step-1').innerText = 'Faltan campos obligatorios en Informaci√≥n general.';
    return false;
  }
  document.getElementById('err-step-1').innerText = '';
  generalInfo = {
    "Nombre o raz√≥n social del cliente": document.getElementById('g_nombre').value.trim(),
    "Fecha de inspecci√≥n": document.getElementById('g_fecha').value,
    "Direcci√≥n": document.getElementById('g_direccion').value.trim(),
    "RUC o DNI": document.getElementById('g_ruc').value.trim(),
    "N√∫mero de instalaci√≥n": document.getElementById('g_numinst').value.trim(),
    "Distrito": document.getElementById('g_distrito').value.trim(),
    "Departamento": document.getElementById('g_departamento').value.trim(),
    "Coordenadas": document.getElementById('g_coordenadas').value.trim(),
    "Nombre del contacto": document.getElementById('g_contacto').value.trim(),
    "N√∫mero del contacto": document.getElementById('g_telefono').value.trim(),
    "Correo de contacto": document.getElementById('g_correo').value.trim()
  };
  if(showMsg) alert('Informaci√≥n general guardada.');
  return true;
}

/* Validation per step (keeps your rules) */
function validateStep(step){
  if(step === 1) return saveGeneral(false);
  if(step === 2){
    if(tanks.length === 0){ document.getElementById('err-step-2').innerText = 'Debes agregar al menos un tanque.'; return false; }
    document.getElementById('err-step-2').innerText = '';
    return true;
  }
  if(step === 3){
    for(const [tk, obj] of Object.entries(accessoriesByTank)){
      for(const [accName, fields] of Object.entries(obj)){
        const anyFilled = (fields["Marca"]||'').trim() || (fields["C√≥digo"]||'').trim() || (fields["Serie"]||'').trim() || (fields["Mes/A√±o de fabricaci√≥n"]||'').trim();
        if(anyFilled){
          const missing = ["Marca","C√≥digo","Serie","Mes/A√±o de fabricaci√≥n"].filter(k => !String(fields[k]||'').trim());
          if(missing.length){
            document.getElementById('err-step-3').innerText = `En el tanque ${tk} el accesorio "${accName}" no est√° completo: faltan ${missing.join(', ')}`;
            return false;
          }
        }
      }
    }
    document.getElementById('err-step-3').innerText = '';
    return true;
  }
  if(step === 5){
    for(let i=0;i<equipos.length;i++){
      const eq = equipos[i];
      if(eq["Tipo de equipo"]){
        const cols = estructuraEquipos[eq["Tipo de equipo"]];
        if(cols){
          const missing = cols.filter(c => !String(eq[c]||'').trim());
          if(missing.length){
            document.getElementById('err-step-5') && (document.getElementById('err-step-5').innerText = `Equipo ${i+1} incompleto: faltan ${missing.join(', ')}`);
            return false;
          }
        }
      }
    }
    document.getElementById('err-step-5') && (document.getElementById('err-step-5').innerText = '');
    return true;
  }
  return true;
}

/* -------------------------
   Tanks (step 2)
   ------------------------- */
function clearTankForm(){
  ["tank_serie","tank_capacidad","tank_anio","tank_tipo","tank_fabricante","tank_porcentaje"].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
  document.getElementById('err-tank').innerText = '';
}
function saveTank(){
  const serie = document.getElementById('tank_serie').value.trim();
  const tipo = document.getElementById('tank_tipo').value;
  if(!serie || !tipo){ document.getElementById('err-tank').innerText = 'N¬∞ de serie y Tipo son obligatorios.'; return; }
  const tank = {
    serie,
    capacidad: document.getElementById('tank_capacidad').value.trim(),
    anio: document.getElementById('tank_anio').value.trim(),
    tipo,
    fabricante: document.getElementById('tank_fabricante').value.trim(),
    porcentaje: document.getElementById('tank_porcentaje').value.trim()
  };
  tanks.push(tank);
  const idx = String(tanks.length);
  if(!accessoriesByTank[idx]) {
    accessoriesByTank[idx] = {};
    accesoriosFijos.forEach(name => {
      accessoriesByTank[idx][name] = {"Marca": "","C√≥digo": "","Serie": "","Mes/A√±o de fabricaci√≥n": ""};
    });
  }
  renderTanks();
  clearTankForm();
  updateTankSelectOptions();
  updateProgressUI();
}
function renderTanks(){
  const container = document.getElementById('tanksList');
  container.innerHTML = '';
  tanks.forEach((t,i) => {
    const idx = i+1;
    const card = document.createElement('div');
    card.className = 'tank-card';
    const info = document.createElement('div');
    info.className = 'tank-info';
    info.innerHTML = `
      <div><strong style="color:#fff">#${idx}</strong></div>
      <div><div class="small">Serie</div><div style="color:#fff">${t.serie || '-'}</div></div>
      <div><div class="small">Capacidad</div><div style="color:#fff">${t.capacidad || '-'}</div></div>
      <div><div class="small">Tipo</div><div style="color:#fff">${t.tipo || '-'}</div></div>
      <div><div class="small">% Actual</div><div style="color:#fff">${t.porcentaje || '-'}</div></div>
    `;
    const actions = document.createElement('div');
    actions.className = 'tank-actions';
    actions.innerHTML = `
      <div class="inline-actions">
        <button class="btn small ghost" style="background:#e9f7ff;color:#041018;border:1px solid rgba(0,0,0,0.04)" onclick="editTank(${i})">Editar</button>
        <button class="btn small warn" onclick="openAccForTank(${i})">Accesorios</button>
        <button class="btn small danger" onclick="deleteTank(${i})">Borrar</button>
      </div>
    `;
    card.appendChild(info); card.appendChild(actions); container.appendChild(card);
  });
}
function editTank(index){
  const t = tanks[index];
  if(!t) return;
  ["serie","capacidad","anio","tipo","fabricante","porcentaje"].forEach((k, idx) => {
    const idmap = ['tank_serie','tank_capacidad','tank_anio','tank_tipo','tank_fabricante','tank_porcentaje'][idx];
    document.getElementById(idmap).value = t[k] || '';
  });
  tanks.splice(index,1);
  rebuildAccessoriesAfterTankDeletion();
  renderTanks(); updateTankSelectOptions();
}
function deleteTank(index){ if(!confirm('¬øEliminar este tanque?')) return; tanks.splice(index,1); rebuildAccessoriesAfterTankDeletion(); renderTanks(); updateTankSelectOptions(); updateProgressUI(); }
function rebuildAccessoriesAfterTankDeletion(){
  const newMap = {};
  tanks.forEach((t, i) => {
    const key = String(i+1);
    newMap[key] = accessoriesByTank[key] || {};
    accesoriosFijos.forEach(name => { if(!newMap[key][name]) newMap[key][name] = {"Marca": "","C√≥digo": "","Serie": "","Mes/A√±o de fabricaci√≥n": ""}; });
  });
  accessoriesByTank = newMap;
}
function clearTanks(){ if(!confirm('Limpiar todos los tanques?')) return; tanks=[]; accessoriesByTank={}; renderTanks(); updateTankSelectOptions(); updateProgressUI(); }
function updateTankSelectOptions(){
  const sel = document.getElementById('select_tanque');
  if(!sel) return;
  sel.innerHTML = '<option value="">-- seleccionar tanque --</option>';
  tanks.forEach((t,i) => { const opt = document.createElement('option'); opt.value = String(i+1); opt.textContent = `${i+1} ¬∑ Serie: ${t.serie || '-'}`; sel.appendChild(opt); });
  document.getElementById('status-2').innerText = `${tanks.length} tanques`;
}

/* -------------------------
   Accessories per tank (step3)
   ------------------------- */
document.getElementById('select_tanque').addEventListener('change', function(){ updateAccArea(this.value); });

function updateAccArea(tankIndex){
  const titulo = document.getElementById('acc-titulo');
  if(!tankIndex){ titulo.innerText = 'Accesorio del tanque ‚Äî'; document.getElementById('acc-list').innerHTML = '<div class="small">Selecciona un tanque para ver/editar sus accesorios.</div>'; return; }
  const t = tanks[Number(tankIndex)-1];
  titulo.textContent = `Accesorio del tanque ${tankIndex} de serie : ${t ? t.serie : '-'}`;
  document.getElementById('acc-titulo').style.background = '#f3f3f3'; document.getElementById('acc-titulo').style.color = '#041018';
  if(!accessoriesByTank[tankIndex]) { accessoriesByTank[tankIndex] = {}; accesoriosFijos.forEach(name => { accessoriesByTank[tankIndex][name] = {"Marca": "","C√≥digo": "","Serie": "","Mes/A√±o de fabricaci√≥n": ""}; }); }
  renderAccList(tankIndex);
  accesoriosOpcionales.forEach((name, i) => {
    const elId = (i===0?'opt_exceso_retorno': i===1? 'opt_exceso_bypass':'opt_val3');
    const exists = !!accessoriesByTank[tankIndex][name];
    document.getElementById(elId).checked = !!exists;
  });
}
function renderAccList(tankIndex){
  const cont = document.getElementById('acc-list');
  cont.innerHTML = '';
  const accMap = accessoriesByTank[tankIndex] || {};
  const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
  table.innerHTML = `<thead style="background:#f3f3f3;color:#041018"><tr><th style="padding:8px;text-align:left">Accesorio</th><th style="padding:8px">Marca</th><th style="padding:8px">C√≥digo</th><th style="padding:8px">Serie</th><th style="padding:8px">Mes/A√±o</th></tr></thead>`;
  const tbody = document.createElement('tbody');
  Object.keys(accMap).forEach(accName => {
    const fields = accMap[accName];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:8px;border-bottom:1px solid #eee">${accName}</td>
      <td style="padding:8px;border-bottom:1px solid #eee"><input data-acc="${accName}" data-tank="${tankIndex}" data-field="Marca" value="${fields["Marca"]||''}" style="width:100%"></td>
      <td style="padding:8px;border-bottom:1px solid #eee"><input data-acc="${accName}" data-tank="${tankIndex}" data-field="C√≥digo" value="${fields["C√≥digo"]||''}" style="width:100%"></td>
      <td style="padding:8px;border-bottom:1px solid #eee"><input data-acc="${accName}" data-tank="${tankIndex}" data-field="Serie" value="${fields["Serie"]||''}" style="width:100%"></td>
      <td style="padding:8px;border-bottom:1px solid #eee"><input data-acc="${accName}" data-tank="${tankIndex}" data-field="Mes/A√±o de fabricaci√≥n" value="${fields["Mes/A√±o de fabricaci√≥n"]||''}" style="width:100%"></td>
    `;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); cont.appendChild(table);
  cont.querySelectorAll('input[data-acc]').forEach(inp => {
    inp.addEventListener('input', function(){
      const t = this.getAttribute('data-tank'); const acc = this.getAttribute('data-acc'); const field = this.getAttribute('data-field');
      if(!accessoriesByTank[t]) accessoriesByTank[t] = {};
      if(!accessoriesByTank[t][acc]) accessoriesByTank[t][acc] = {"Marca": "","C√≥digo": "","Serie": "","Mes/A√±o de fabricaci√≥n": ""};
      accessoriesByTank[t][acc][field] = this.value;
    });
  });
}
["opt_exceso_retorno","opt_exceso_bypass","opt_val3"].forEach(id => { document.getElementById(id).addEventListener('change', function(){ toggleOptionalAccessory(this.checked, id); }); });
function toggleOptionalAccessory(enabled, elId){
  const name = elId==='opt_exceso_retorno' ? "V√°lvula exceso de flujo (Retorno)" : elId==='opt_exceso_bypass' ? "V√°lvula exceso de flujo (Bypass)" : "Val 3";
  const sel = document.getElementById('select_tanque'); const tankIndex = sel.value;
  if(!tankIndex){ alert('Seleccione primero un tanque.'); document.getElementById(elId).checked = false; return; }
  if(enabled) accessoriesByTank[tankIndex][name] = {"Marca": "","C√≥digo": "","Serie": "","Mes/A√±o de fabricaci√≥n": ""};
  else delete accessoriesByTank[tankIndex][name];
  renderAccList(tankIndex);
}
function openModalForTank(tankIndex){
  const modal = document.getElementById('modalAcc');
  const t = tanks[Number(tankIndex)-1];
  modal.classList.add('active');
  document.getElementById('modalTitle').innerText = `Editar accesorios de tanque ${tankIndex} de serie : ${t ? t.serie : '-'}`;
  const tbody = document.querySelector('#modalAccTable tbody'); tbody.innerHTML='';
  const accMap = accessoriesByTank[tankIndex] || {};
  Object.keys(accMap).forEach(name => {
    const fields = accMap[name];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="accesorio" style="padding:6px">${name}</td>
      <td style="padding:6px"><input data-modal-acc="${name}" data-modal-field="Marca" value="${fields["Marca"]||''}"></td>
      <td style="padding:6px"><input data-modal-acc="${name}" data-modal-field="C√≥digo" value="${fields["C√≥digo"]||''}"></td>
      <td style="padding:6px"><input data-modal-acc="${name}" data-modal-field="Serie" value="${fields["Serie"]||''}"></td>
      <td style="padding:6px"><input data-modal-acc="${name}" data-modal-field="Mes/A√±o de fabricaci√≥n" value="${fields["Mes/A√±o de fabricaci√≥n"]||''}"></td>`;
    tbody.appendChild(tr);
  });
}
function closeAccModal(){ document.getElementById('modalAcc').classList.remove('active'); }
function saveAccModal(){
  const sel = document.getElementById('select_tanque'); const t = sel.value || '';
  if(!t) { closeAccModal(); return; }
  const inputs = document.querySelectorAll('#modalAccTable input[data-modal-acc]');
  inputs.forEach(inp => {
    const acc = inp.getAttribute('data-modal-acc'); const field = inp.getAttribute('data-modal-field');
    if(!accessoriesByTank[t]) accessoriesByTank[t] = {};
    if(!accessoriesByTank[t][acc]) accessoriesByTank[t][acc] = {"Marca": "","C√≥digo": "","Serie": "","Mes/A√±o de fabricaci√≥n": ""};
    accessoriesByTank[t][acc][field] = inp.value;
  });
  renderAccList(t); closeAccModal();
}

/* -------------------------
   REDES (step4)
   ------------------------- */
function clearRedForm(){ ["red_tipo","red_marca","red_serie","red_codigo","red_mesano"].forEach(id=>{const e=document.getElementById(id); if(e) e.value='';}); document.querySelectorAll('input[name="zona_med"]').forEach(r=>r.checked=false); document.getElementById('zonaMedidoresControls').style.display='none'; }
document.getElementById('red_tipo').addEventListener('change', function(){ document.getElementById('zonaMedidoresControls').style.display = this.value==='zona_medidores' ? 'block':'none'; });
function addRed(){
  const tipo = document.getElementById('red_tipo').value;
  if(!tipo){ alert('Selecciona tipo de accesorio'); return; }
  if(tipo === 'zona_medidores'){
    const sel = document.querySelector('input[name="zona_med"]:checked'); if(!sel){ alert('Selecciona Tiene / No tiene para zona de medidores'); return; }
    zona_medidores_val = sel.value === 'true';
    redes = redes.filter(r => r.Tipo !== 'zona_medidores');
    redes.push({"Tipo": "zona_medidores", "Marca":"", "Serie":"", "C√≥digo": zona_medidores_val ? "True" : "False", "Mes/A√±o de fabricaci√≥n": ""});
    renderRedList(); clearRedForm(); return;
  }
  const obj = {"Tipo": tipo, "Marca": document.getElementById('red_marca').value.trim() || '', "Serie": document.getElementById('red_serie').value.trim() || '', "C√≥digo": document.getElementById('red_codigo').value.trim() || '', "Mes/A√±o de fabricaci√≥n": document.getElementById('red_mesano').value.trim() || ''};
  redes.push(obj); renderRedList(); clearRedForm();
}
function renderRedList(){ const c = document.getElementById('redList'); c.innerHTML = ''; if(redes.length===0){ c.innerHTML = '<div class="small">No hay accesorios en redes agregados.</div>'; return; } redes.forEach((r,i)=>{ const div=document.createElement('div'); div.className='tank-card'; div.style.display='flex'; div.style.justifyContent='space-between'; const left=document.createElement('div'); left.innerHTML=`<div style="font-weight:700;color:#fff">${i+1}. ${humanReadableTipo(r.Tipo)}</div><div style="color:#dff9ff;margin-top:6px">${(r.Marca||'-')} ‚Äî ${(r.Serie||'-')} ‚Äî ${(r.C√≥digo||'-')}</div>`; const right=document.createElement('div'); right.innerHTML=`<div style="display:flex;gap:8px"><button class="btn small ghost" onclick="editRed(${i})">Editar</button><button class="btn small danger" onclick="deleteRed(${i})">Borrar</button></div>`; div.appendChild(left); div.appendChild(right); c.appendChild(div); }); }
function humanReadableTipo(tipo){ const map={ "llenado_toma_desplazada":"V√°lvula de llenado de toma desplazada", "retorno_toma_desplazada":"V√°lvula de retorno toma desplazada", "alivio_hidrostatico":"V√°lvula de alivio hidrost√°tico", "regulador_primera_etapa":"Regulador primera etapa", "alivio":"V√°lvula de alivio", "regulador_2da":"Regulador segunda etapa", "pull_away":"V√°lvula Pull Away", "zona_medidores":"Zona de medidores" }; return map[tipo] || tipo; }
function editRed(i){ const r=redes[i]; if(!r) return; document.getElementById('red_tipo').value=r.Tipo; document.getElementById('red_marca').value=r.Marca||''; document.getElementById('red_serie').value=r.Serie||''; document.getElementById('red_codigo').value=r.C√≥digo||''; document.getElementById('red_mesano').value=r["Mes/A√±o de fabricaci√≥n"]||''; redes.splice(i,1); renderRedList(); }
function deleteRed(i){ if(!confirm('Eliminar accesorio en red?')) return; redes.splice(i,1); renderRedList(); }

/* -------------------------
   Equipos (step 5)
   ------------------------- */
function clearEquipoForm(){ document.getElementById('eq_tipo').value=''; document.getElementById('eq_name').value=''; document.getElementById('dynamicFields').innerHTML=''; }
document.getElementById('eq_tipo').addEventListener('change', function(){
  const tipo = this.value;
  const nameInput = document.getElementById('eq_name');
  const countForType = equipos.filter(e => e["Tipo de equipo"] === tipo).length;
  const nextIdx = countForType + 1;
  if(tipo) {
    const pretty = tipo.replace(/_/g,' ');
    const capital = pretty.charAt(0).toUpperCase() + pretty.slice(1);
    nameInput.value = `${capital}${nextIdx}`;
  } else nameInput.value = '';
  renderDynamicFields(tipo);
});
function renderDynamicFields(tipo){
  const container = document.getElementById('dynamicFields'); container.innerHTML='';
  if(!tipo) return;
  const cols = estructuraEquipos[tipo] || [];
  cols.forEach(col => {
    if(col === 'Equipo') return;
    const wrap=document.createElement('div'); wrap.style.minWidth='160px';
    const safeId = 'dyn_' + col.replace(/\s/g,'_').replace(/[()]/g,'');
    wrap.innerHTML = `<div class="label" style="font-size:12px">${col}</div><div class="field"><input id="${safeId}" type="text"></div>`;
    container.appendChild(wrap);
  });
}
function addEquipo(){
  const tipo = document.getElementById('eq_tipo').value;
  if(!tipo){ alert('Selecciona tipo de equipo'); return; }
  const cols = estructuraEquipos[tipo];
  if(!cols){ alert('Tipo de equipo inv√°lido'); return; }
  const eq = {"Tipo de equipo": tipo};
  const nombre = document.getElementById('eq_name').value || '';
  eq["Equipo"] = nombre;
  cols.forEach(col => {
    if(col === 'Equipo') return;
    const id = 'dyn_' + col.replace(/\s/g,'_').replace(/[()]/g,'');
    const el = document.getElementById(id);
    eq[col] = el ? el.value.trim() : '';
  });
  const missing = cols.filter(c => !String(eq[c]||'').trim());
  if(missing.length){ alert(`Faltan campos en equipo: ${missing.join(', ')}`); return; }
  equipos.push(eq);
  clearEquipoForm(); renderEquiposList(); buildActividadContextOptions();
}
function renderEquiposList(){
  const c = document.getElementById('equiposList'); c.innerHTML='';
  if(equipos.length === 0){ c.innerHTML = '<div class="small">No hay equipos agregados.</div>'; return; }
  const table = document.createElement('table'); table.style.width='100%';
  const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>#</th><th>Equipo</th><th>Tipo</th><th>Detalles</th><th>Acciones</th></tr>';
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  equipos.forEach((eq,i) => {
    const tr = document.createElement('tr');
    const details = Object.keys(eq).filter(k=>!["Equipo","Tipo de equipo"].includes(k)).map(k=>`${k}: ${eq[k]||'-'}`).join(' ‚Ä¢ ');
    tr.innerHTML = `<td style="padding:8px">${i+1}</td>
      <td style="padding:8px">${eq["Equipo"]||'-'}</td>
      <td style="padding:8px">${eq["Tipo de equipo"]||'-'}</td>
      <td style="padding:8px">${details}</td>
      <td style="padding:8px"><button class="btn small ghost" onclick="editEquipo(${i})">Editar</button> <button class="btn small danger" onclick="deleteEquipo(${i})">Borrar</button></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); c.appendChild(table);
}

/* -------------------------
   Actividades UI (step 7)
   ------------------------- */
function buildActividadContextOptions(){
  const sel = document.getElementById('actividad_contexto');
  if(!sel) return;
  sel.innerHTML = '<option value="general">General</option>';
  tanks.forEach((t,i) => { const o=document.createElement('option'); o.value=`tanque_${i+1}`; o.text=`Tanque ${i+1} ¬∑ Serie: ${t.serie||'-'}`; sel.appendChild(o); });
  redes.forEach((r,i) => { const o=document.createElement('option'); o.value=`red_${i+1}`; o.text=`Red ${i+1} ¬∑ ${humanReadableTipo(r.Type||r.Tipo)}`; sel.appendChild(o); });
  equipos.forEach((eq,i) => { const o=document.createElement('option'); o.value=`equipo_${i+1}`; o.text=`Equipo ${i+1} ¬∑ ${eq["Equipo"]||eq["Tipo de equipo"]||'-'}`; sel.appendChild(o); });
}
function uid(prefix){ return prefix + '_' + Date.now().toString(36) + '_' + Math.floor(Math.random()*1000); }
function addActividad(){
  const contexto = document.getElementById('actividad_contexto').value || 'general';
  const titulo = document.getElementById('actividad_titulo').value.trim() || 'Actividad';
  const tiempo = document.getElementById('actividad_tiempo').value.trim() || '';
  const estado = document.getElementById('actividad_estado').value || 'realizado';
  const id = uid('actividad');
  actividades.push({id, contexto, titulo, tiempo, estado});
  renderActividades();
  document.getElementById('actividad_titulo').value=''; document.getElementById('actividad_tiempo').value='';
  buildActividadContextOptions();
}
function removeActividad(index){ if(!confirm('Eliminar actividad?')) return; actividades.splice(index,1); renderActividades(); }
function renderActividades(){
  const tbody = document.getElementById('actividades_table_body'); tbody.innerHTML='';
  actividades.forEach((a,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:8px">${i+1}</td>
      <td style="padding:8px">${contextLabel(a.contexto)}</td>
      <td style="padding:8px">${a.titulo}</td>
      <td style="padding:8px">${a.tiempo}</td>
      <td style="padding:8px">${a.estado}</td>
      <td style="padding:8px"><button class="btn small ghost" onclick="removeActividad(${i})">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
}
function contextLabel(ctx){
  if(ctx === 'general') return 'General';
  if(ctx.startsWith('tanque_')){ const idx = Number(ctx.split('_')[1]) - 1; const t = tanks[idx]; return `Tanque ${idx+1} ¬∑ ${t ? t.serie : '-'}`; }
  if(ctx.startsWith('red_')){ const idx = Number(ctx.split('_')[1]) - 1; const r = redes[idx]; return `Red ${idx+1} ¬∑ ${r ? humanReadableTipo(r.Tipo) : '-'}`; }
  if(ctx.startsWith('equipo_')){ const idx = Number(ctx.split('_')[1]) - 1; const e = equipos[idx]; return `Equipo ${idx+1} ¬∑ ${e ? e.Equipo : '-'}`; }
  return ctx;
}
/* A compact UI render for step7 (list + add controls already exist in HTML; we ensure the table is up to date) */
function renderActividadesUI(){ renderActividades(); buildActividadContextOptions(); }

/* go to fotos (button) */
function onActividadesNext(){ buildPhotoSubtitles(); showStep(8); }
document.querySelectorAll('#step-7 .btn.primary').forEach(b => { if(b) b.addEventListener('click', onActividadesNext); });

/* -------------------------
   PHOTO SUBTITLES builder (matches backend logic)
   ------------------------- */
function buildPhotoSubtitles(){
  photoSubtitles = []; photosBySubtitle = {};

  // Subt√≠tulo 8 - foto establecimiento
  photoSubtitles.push({id:'sub_8_establecimiento', title: '8 ¬∑ FOTO DEL ESTABLECIMIENTO', required:1, isActivity:false, meta:{type:'establecimiento'}});

  // Punto 9: panor√°micas y placas generales
  photoSubtitles.push({id:'9_panoramica_general', title:'9.1 ¬∑ FOTO PANOR√ÅMICA GENERAL', required:1, isActivity:false, meta:{type:'panoramica_general'}});
  photoSubtitles.push({id:'9_placa_panel_equipos', title:'9.2 ¬∑ FOTO PLACA Y PANEL (EQUIPOS)', required:1, isActivity:false, meta:{type:'placa_panel_equipos'}});

  // For each tank: add a set of subtitles (placa, multiv√°lvula, v√°lvula llenado, v√°lvula seguridad, medidor porcentaje, drenaje, panor√°mica)
  tanks.forEach((t, idx) => {
    const i = idx+1;
    const base = `tanque_${i}`;
    // placa
    photoSubtitles.push({id:`${base}_placa`, title:`9.${10+idx*10} ¬∑ PLACA DE TANQUE ${i} ‚Äî SERIE: ${t.serie||'-'}`, required:1, isActivity:false, meta:{type:'placa_tanque', tankIndex:i}});
    // multivalvula (if data present or optional)
    photoSubtitles.push({id:`${base}_multivalvula`, title:`9.${10+idx*10+1} ¬∑ MULTIV√ÅLVULA TANQUE ${i}`, required:1, isActivity:false, meta:{type:'multivalvula', tankIndex:i}});
    // valvula llenado
    photoSubtitles.push({id:`${base}_valvula_llenado`, title:`9.${10+idx*10+2} ¬∑ V√ÅLVULA DE LLENADO TANQUE ${i}`, required:1, isActivity:false, meta:{type:'valvula_llenado', tankIndex:i}});
    // valvula seguridad
    photoSubtitles.push({id:`${base}_valvula_seguridad`, title:`9.${10+idx*10+3} ¬∑ V√ÅLVULA DE SEGURIDAD TANQUE ${i}`, required:1, isActivity:false, meta:{type:'valvula_seguridad', tankIndex:i}});
    // medidor porcentaje
    photoSubtitles.push({id:`${base}_medidor_porcentaje`, title:`9.${10+idx*10+4} ¬∑ MEDIDOR DE PORCENTAJE TANQUE ${i}`, required:1, isActivity:false, meta:{type:'medidor_porcentaje', tankIndex:i}});
    // valvula drenaje
    photoSubtitles.push({id:`${base}_valvula_drenaje`, title:`9.${10+idx*10+5} ¬∑ V√ÅLVULA DE DRENAJE TANQUE ${i}`, required:1, isActivity:false, meta:{type:'valvula_drenaje', tankIndex:i}});
    // panoramica alrededor (4 fotos)
    photoSubtitles.push({id:`${base}_panoramica`, title:`9.${10+idx*10+6} ¬∑ PANOR√ÅMICA ALREDEDOR TANQUE ${i}`, required:4, isActivity:false, meta:{type:'panoramica_tanque', tankIndex:i}});
  });

  // Accessories in redes: create subtitles for each specific type added in redes
  redes.forEach((r, idx) => {
    const id = `red_${idx+1}_${r.Tipo}`;
    const readable = humanReadableTipo(r.Tipo);
    photoSubtitles.push({id:id, title:`9.RED${idx+1} ¬∑ ${readable}`, required:1, isActivity:false, meta:{type:'red_accesorio', redIndex: idx, redTipo: r.Tipo}});
    // if zone medidores, maybe require panoramica
    if(r.Tipo === 'zona_medidores') {
      photoSubtitles.push({id:`red_${idx+1}_zona_panoramica`, title:`9.RED${idx+1} ¬∑ PANOR√ÅMICA ZONA MEDIDORES`, required:2, isActivity:false, meta:{type:'zona_medidores_panoramica', redIndex:idx}});
    }
  });

  // Equipos: placa por equipo y panor√°mica o detalle si requiere (1 foto)
  equipos.forEach((eq, idx) => {
    const i = idx+1;
    photoSubtitles.push({id:`equipo_${i}_placa`, title:`9.EQ${i} ¬∑ PLACA EQUIPO ${eq.Equipo || eq["Tipo de equipo"] || i}`, required:1, isActivity:false, meta:{type:'placa_equipo', equipoIndex:i}});
    photoSubtitles.push({id:`equipo_${i}_detalle`, title:`9.EQ${i} ¬∑ DETALLE/UBICACI√ìN EQUIPO ${eq.Equipo || i}`, required:1, isActivity:false, meta:{type:'detalle_equipo', equipoIndex:i}});
  });

  // special global accessories that often exist in the PDF: pull_away, alivio, reguladores etc. If they exist in redes as tipo, they already added above.
  // Activities (Punto 10): each activity requires two photos (antes/despues)
  actividades.forEach((act, idx) => {
    const aid = act.id;
    photoSubtitles.push({id:aid, title:`10.${idx+1} ¬∑ ${act.titulo} ‚Äî ${contextLabel(act.contexto)}`, required:2, isActivity:true, meta:{type:'actividad', actividadIndex: idx, actividadId:aid}});
  });

  // Initialize containers
  photoSubtitles.forEach(s => { photosBySubtitle[s.id] = []; });

  renderPhotoTable();
}

/* Renders the photo table (step 8) */
function renderPhotoTable(){
  const tbody = document.querySelector('#photoTable tbody');
  if(!tbody) {
    // if not present (custom containers) also render in #fotosContainer
    const fc = document.getElementById('fotosContainer');
    if(!fc) return;
    fc.innerHTML = '';
    photoSubtitles.forEach(s => {
      const card = document.createElement('div');
      card.className = 'tank-card';
      const left = document.createElement('div'); left.style.flex='1';
      left.innerHTML = `<div style="font-weight:700;color:#fff">${s.title}</div><div class="small" style="margin-top:6px">Requeridas: ${s.required}</div>`;
      const right = document.createElement('div'); right.innerHTML = s.isActivity
        ? `<div style="display:flex;gap:6px">
             <button class="btn small ghost" onclick="openFileDialog('${s.id}','before')">Subir (Antes)</button>
             <button class="btn small ghost" onclick="openFileDialog('${s.id}','after')">Subir (Despu√©s)</button>
             <button class="btn small ghost" onclick="openPhotoPreview('${s.id}')">Ver</button>
           </div>`
        : `<div style="display:flex;gap:6px">
             <button class="btn small ghost" onclick="openFileDialog('${s.id}')">Subir</button>
             <button class="btn small ghost" onclick="openPhotoPreview('${s.id}')">Ver</button>
           </div>`;
      card.appendChild(left); card.appendChild(right); fc.appendChild(card);
    });
    return;
  }

  tbody.innerHTML = '';
  photoSubtitles.forEach(s => {
    const uploaded = (photosBySubtitle[s.id] || []).length;
    let actionsHtml = '';
    if(s.isActivity){
      actionsHtml = `<button class="photo-action-btn" onclick="openFileDialog('${s.id}','before')" style="background:#e9f7ff;color:#041018">Subir (Antes)</button>
                     <button class="photo-action-btn" onclick="openFileDialog('${s.id}','after')" style="background:#e9f7ff;color:#041018">Subir (Despu√©s)</button>
                     <button class="photo-action-btn" onclick="openPhotoPreview('${s.id}')">Ver</button>`;
    } else {
      actionsHtml = `<button class="photo-action-btn" onclick="openFileDialog('${s.id}')" style="background:#e9f7ff;color:#041018">Subir</button>
                     <button class="photo-action-btn" onclick="openPhotoPreview('${s.id}')">Ver</button>`;
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:10px">${s.title}</td>
                    <td style="text-align:center">${s.required}</td>
                    <td style="text-align:center">${uploaded}/${s.required}</td>
                    <td>${actionsHtml}</td>`;
    tbody.appendChild(tr);
  });
}

/* file selection */
function openFileDialog(subId, role){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.multiple = (role ? false : true);
  input.onchange = (e) => handleFilesSelected(subId, e.target.files, role);
  input.click();
}

function handleFilesSelected(subId, fileList, role){
  if(!photosBySubtitle[subId]) photosBySubtitle[subId] = [];
  for(let i=0;i<fileList.length;i++){
    const f = fileList[i];
    if(role === 'before' || role === 'after'){
      const genName = `${subId}__${role}__${Date.now()}__${f.name}`;
      // ensure only one before and one after per activity (if desired)
      if(role === 'before') photosBySubtitle[subId] = photosBySubtitle[subId].filter(x=>x.role!=='before');
      if(role === 'after') photosBySubtitle[subId] = photosBySubtitle[subId].filter(x=>x.role!=='after');
      photosBySubtitle[subId].push({file:f, role:role, genName});
    } else {
      const genName = `${subId}__${photosBySubtitle[subId].length}__${Date.now()}__${f.name}`;
      photosBySubtitle[subId].push({file:f, role:null, genName});
    }
  }
  renderPhotoTable();
}

/* preview modal */
function openPhotoPreview(subId){
  const modal = document.getElementById('photoPreviewModal');
  const grid = document.getElementById('previewGrid');
  const title = document.getElementById('previewModalTitle');
  grid.innerHTML = '';
  const arr = photosBySubtitle[subId] || [];
  title.innerText = `Previsualizar ‚Äî ${subId} (${arr.length})`;
  if(arr.length === 0){ grid.innerHTML = '<div class="small">No hay im√°genes subidas</div>'; }
  else {
    arr.forEach((entry, idx) => {
      const url = URL.createObjectURL(entry.file);
      const card = document.createElement('div'); card.className='preview-card';
      card.innerHTML = `<img src="${url}" alt="img"><div style="padding:8px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:12px;color:#666">${entry.role ? entry.role.toUpperCase() : ''}</div>
        <div><button class="btn small ghost" onclick="removePhoto('${subId}',${idx})">Eliminar</button></div></div>`;
      grid.appendChild(card);
    });
  }
  modal.style.display = 'flex';
}
function closePhotoPreview(){ document.getElementById('photoPreviewModal').style.display = 'none'; }
function removePhoto(subId, idx){ photosBySubtitle[subId].splice(idx,1); renderPhotoTable(); openPhotoPreview(subId); }

/* -------------------------
   Build payload & send (multipart with files)
   ------------------------- */
function buildPayload(){
  if(!saveGeneral(false)) { showStep(1); throw 'General incomplete'; }
  if(tanks.length === 0){ showStep(2); throw 'Se requiere al menos un tanque'; }

  const tanquesArr = tanks.map(t => ({"serie": t.serie || '',"capacidad": t.capacidad || '',"anio": t.anio || '',"tipo": t.tipo || '',"fabricante": t.fabricante || '',"porcentaje": t.porcentaje || ''}));

  const accByTankPayload = {};
  Object.keys(accessoriesByTank).forEach(k => {
    const accs = accessoriesByTank[k];
    const out = {};
    Object.keys(accs).forEach(name => {
      const fields = accs[name];
      const any = Object.values(fields).some(v => String(v||'').trim() !== '');
      if(any){
        out[name] = {
          "Marca": fields["Marca"] || '',
          "C√≥digo": fields["C√≥digo"] || '',
          "Serie": fields["Serie"] || '',
          "Mes/A√±o de fabricaci√≥n": fields["Mes/A√±o de fabricaci√≥n"] || ''
        };
      }
    });
    if(Object.keys(out).length) accByTankPayload[k] = out;
  });

  const redPayload = redes.map(r => ({"Tipo": r.Tipo || '',"Marca": r.Marca || '',"Serie": r.Serie || '',"C√≥digo": r.C√≥digo || '',"Mes/A√±o de fabricaci√≥n": r["Mes/A√±o de fabricaci√≥n"] || ''}));
  const equiposPayload = equipos.map(eq => Object.assign({}, eq));
  const observaciones = {
    "7.1": document.getElementById('obs_71').value.trim(),
    "7.2": document.getElementById('obs_72').value.trim(),
    "7.3": document.getElementById('obs_73').value.trim(),
    "7.4": document.getElementById('obs_74').value.trim(),
    "7.5": document.getElementById('obs_75').value.trim()
  };

  return {
    "general": generalInfo,
    "tanques": tanquesArr,
    "accesoriosTanque": accByTankPayload,
    "accesoriosRed": redPayload,
    "equipos": equiposPayload,
    "observaciones": observaciones,
    "actividades": actividades.map(a => ({id:a.id, contexto:a.contexto, titulo:a.titulo, tiempo:a.tiempo, estado:a.estado}))
  };
}

async function handleGenerateWithPhotos(){
  let payload = {};
  try{ payload = buildPayload(); } catch(e){ alert('Error en datos: ' + e); return; }

  const fd = new FormData();
  fd.append('json', JSON.stringify(payload));

  // append files with encoded names so backend can map subId & role
  Object.keys(photosBySubtitle).forEach(subId => {
    const arr = photosBySubtitle[subId] || [];
    arr.forEach((entry, idx) => {
      // we keep 'files' as field name to remain compatible; filename encodes subId & role
      fd.append('files', entry.file, entry.genName || `${subId}__${idx}__${entry.file.name}`);
    });
  });

  const btn = document.querySelector('#finalGenerateWithPhotos, #finalGenerate'); 
  try{
    if(btn){ btn.disabled = true; btn.innerText = 'Generando...'; }
    const resp = await fetch('/generar', { method:'POST', body: fd });
    if(!resp.ok){
      const err = await resp.json().catch(()=>({error:'Error servidor'}));
      alert('Error: ' + (err.error || JSON.stringify(err)));
      if(btn){ btn.disabled = false; btn.innerText = 'Generar Documento Final ‚Üí'; }
      return;
    }
    const blob = await resp.blob();
    const disposition = resp.headers.get('content-disposition') || '';
    let filename = 'Informe_Mantenimiento.docx';
    const fnMatch = /filename\*=UTF-8''(.+)|filename="?(.+)"?/.exec(disposition);
    if(fnMatch) filename = decodeURIComponent(fnMatch[1] || fnMatch[2] || filename);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    alert('Documento generado y descargado.');
  }catch(err){ console.error(err); alert('Error de red: ' + (err.message||err)); }
  finally{ if(btn){ btn.disabled = false; btn.innerText = 'Generar Documento Final ‚Üí'; } }
}

/* Bind final buttons */
document.getElementById('btnGenerate').addEventListener('click', () => showStep(6));
const finalBtn = document.getElementById('finalGenerateWithPhotos');
if(finalBtn) finalBtn.addEventListener('click', handleGenerateWithPhotos);

/* Init */
function init(){
  updateProgressUI(); renderTanks(); renderRedList(); renderEquiposList(); updateTankSelectOptions();
  // ensure Step7 button uses our handler
  const step7NextBtns = document.querySelectorAll('#step-7 .btn.primary');
  step7NextBtns.forEach(b=>b.addEventListener('click', onActividadesNext));
}
init();
</script>
