<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solgas ¬∑ Inspecci√≥n GLP</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg-1:#030419;
  --bg-2:#042133;
  --accent:#00d2ff;
  --gold:#f6b73c;
  --card:#071827;
  --input-bg:#ffffff;
  --muted:#9fdcff;
  --label:#2b2b2b;
  --input-text-dark:#041018;
  --danger:#ff6b6b;
  --radius:12px;
  --glass: rgba(255,255,255,0.03);
  --panel:#071827;
  --light-card-bg:#f7fbff;
}
*{box-sizing:border-box;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#e6f7ff}
html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:24px auto;padding:18px;border-radius:14px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:800;box-shadow:0 10px 30px rgba(0,194,255,0.07)}
.title{font-size:20px;margin:0}
.lead{color:var(--muted);font-size:13px;margin:0}

/* PROGRESS BAR (fixed top) */
#topProgressWrap{position:fixed;left:0;right:0;top:0;height:8px;background:rgba(255,255,255,0.06);z-index:120;border-bottom:1px solid rgba(255,255,255,0.02)}
#topProgress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--gold));transition:width .3s ease}

/* layout */
.app{display:grid;grid-template-columns:320px 1fr;gap:18px;padding-top:12px}
/* sidebar */
.sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03)}
.userbox{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.user-company{font-weight:700;color:#eafcff}
.navlist{margin-top:8px}
.nav-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .12s}
.nav-item.disabled{opacity:.45;cursor:not-allowed}
.nav-item.active{background:linear-gradient(90deg, rgba(0,194,255,0.06), rgba(246,183,60,0.03)); border:1px solid rgba(0,194,255,0.08)}
.status{font-size:13px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted)}

/* main */
.main{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.02)}
.step{display:none}
.step.active{display:block; animation:fadeIn .26s ease both}
@keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.card-title{font-weight:700; color:var(--accent)}
.hint{font-size:13px;color:var(--muted);opacity:.95}

/* fields */
.row{display:grid;gap:10px}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:1fr 1fr 1fr}
.field{background:var(--input-bg); border-radius:10px; padding:8px; display:flex; align-items:center; gap:8px; border:1px solid rgba(0,0,0,0.06)}
.field input, .field textarea, .field select{border:none;background:transparent;width:100%;outline:none;color:var(--input-text-dark);font-size:14px}
.label{font-size:12px;color:var(--accent);margin-bottom:6px;font-weight:700}
.small{font-size:12px;color:var(--muted)}

/* buttons */
.controls{display:flex;gap:10px;margin-top:12px;align-items:center}
.btn{padding:10px 14px;border-radius:999px;border:none;font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent), #6efcff); color:#041018; box-shadow:0 14px 40px rgba(0,194,255,0.08)}
.btn.ghost{background:#ffffff;border:1px solid rgba(0,0,0,0.06); color:#041018}
.btn.warn{padding: 8px 10px; background:linear-gradient(90deg,var(--gold), #ffd36b); color:#081017}
.btn.danger{background:var(--danger); color:#041018}
.btn.small{padding:6px 10px;border-radius:8px;font-weight:600}

/* lists */
.list{margin-top:8px}
.tank-card{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.18)); border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,0.02); margin-bottom:10px; display:flex;justify-content:space-between;align-items:center}
.tank-info{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;width:85%}
.tank-actions{display:flex;gap:8px;align-items:center}

/* modal (accessories edit) */
.modal-back{position:fixed;inset:0;background:rgba(2,6,10,0);display:none;align-items:center;justify-content:center;z-index:60;padding:20px}
.modal-back.active{display:flex ; color: #041018 }
.modal{background:#ffffff;border-radius:12px;width:980px;max-width:98%;padding:16px;color:#041018;box-shadow:0 18px 50px rgba(2,6,20,0)}
.modal h3{margin:0 0 8px 0 ; color : var(--accent) }
.modal .field input{color:#041018}

/* modal table */
.acc-table{width:100%;border-collapse:collapse;margin-top:8px}
.acc-table th,.acc-table td{border:1px solid #ddd;padding:6px;text-align:center}
.acc-table th{background:#f3f3f3;color:#041018;font-weight:700}

/* invalid */
.invalid{border-color:#ff5b6b !important; box-shadow:0 6px 24px rgba(255,91,107,0.07)}
.errlist{color:#ff9aa2; margin-top:8px; font-weight:700}

/* accessory badges */
.badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:700;color:var(--muted);font-size:12px}

/* inline actions */
.inline-actions{display:flex;gap:8px;align-items:center}

/* select styling for good contrast */
select.custom-select{background:#ffffff;color:#041018;padding:8px;border-radius:8px;border:1px solid #cfeef8;outline:none}
select.custom-select option{color:#041018;background:#ffffff}

/* contrast input text on dark mini cards */
.card-dark{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.18));padding:10px;border-radius:8px;color:#ffffff}

/* accessory header dark */
.acc-header{font-weight:800;color:#041018;background:#f3f3f3;padding:8px;border-radius:8px;display:inline-block;margin-bottom:8px}

/* responsive */
@media (max-width:980px){ .app{grid-template-columns:1fr} .tank-info{grid-template-columns:repeat(2,1fr);width:60%} }

/* LOGIN overlay */
#loginOverlay{position:fixed;inset:0;background:linear-gradient(160deg,var(--bg-1),var(--bg-2));display:flex;align-items:center;justify-content:center;z-index:200}
#loginCard{width:520px;max-width:95%;background:#ffffff;border-radius:12px;padding:20px;color:#041018;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
.login-title{font-weight:800;font-size:20px;margin-bottom:6px ; color:#6b7280 }
.login-sub{color:#6b7280;margin-bottom:12px}
.login-field .field{background:#f3f7fb}
.login-err{color:var(--danger);margin-top:10px;font-weight:700}

/* ensure modal inputs and table texts are dark on white background */
.modal input, .modal select, .modal textarea { color: #041018; background: #fff; border:1px solid #e6eef3; padding:6px; border-radius:6px }

/* ensure acc-list table contrast */
#acc-list table th, #acc-list table td {color:var(--accent) }
#acc-list input { color:#041018; background:#fff; border:1px solid #e6eef3; padding:6px; border-radius:6px; width:100% }

td.accesorio {
	color : #041018 !important;
}

/* Photo preview modal (new) */
#photoPreviewModal{display:none;position:fixed;inset:0;background:rgba(2,6,10,0.6);display:flex;align-items:center;justify-content:center;z-index:150}
#photoPreviewModal .modal{max-width:1000px; width:94%; max-height:88vh; overflow:auto}
.preview-card{border-radius:8px;overflow:hidden;border:1px solid rgba(0,0,0,0.06); background:#fff; color:#041018}
.preview-card img{width:100%;height:160px;object-fit:cover}

/* photo table small button */
.photo-action-btn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;margin-right:6px}
.disabled-btn{opacity:0.45; cursor:not-allowed}
</style>
</head>
<body>
  <!-- Top progress bar -->
  <div id="topProgressWrap"><div id="topProgress"></div></div>

  <!-- Login overlay -->
  <div id="loginOverlay" role="dialog" aria-modal="true">
    <div id="loginCard">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:800">SG</div>
        <div>
          <div class="login-title">Acceso - SOLGAS</div>
          <div class="login-sub">Ingresa con tu correo corporativo y el nombre de empresa.</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="label">Correo corporativo</div>
        <div class="login-field field"><input id="loginEmail" type="email" placeholder="usuario@solgas.com.pe"></div>

        <div class="label" style="margin-top:8px">Empresa</div>
        <div class="login-field field"><input id="loginCompany" type="text" placeholder="Solgas"></div>

        <div class="login-err" id="loginErr" style="display:none"></div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn ghost" onclick="loginCancel()">Salir</button>
          <button class="btn primary" id="loginBtn" onclick="doLogin()">Ingresar</button>
        </div>
      </div>
    </div>
  </div>

<div class="container" id="mainContainer" style="display:block;margin-top:18px">
  <div class="header">
    <div class="logo">SOLGAS</div>
    <div>
      <div class="title">Solgas ¬∑ Inspecci√≥n GLP</div>
      <div class="lead">Formulario interactivo ‚Äî completa paso a paso y genera el informe Word</div>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
      <button class="btn ghost" id="downloadTemplateBtn">Plantilla</button>
      <button class="btn primary" id="btnGenerate" onclick="showStep(6)">Generar Word</button>
    </div>
  </div>

  <div id="app" class="app" style="display:block; margin-top:10px">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="userbox">
        <div style="width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:700" id="userInitials">SG</div>
        <div>
          <div id="sidebarCompany" class="user-company">Empresa</div>
          <div id="sidebarEmail" class="small">correo@dominio.com</div>
        </div>
      </div>

      <div style="font-weight:700;color:var(--muted);margin-bottom:8px">Secciones</div>
      <div id="navlist" class="navlist">
        <div class="nav-item active" data-step="1" onclick="navTo(1)">
          <div>1 ¬∑ Informaci√≥n general</div>
          <div class="status" id="status-1">Obligatorio</div>
        </div>
        <div class="nav-item" data-step="2" onclick="navTo(2)">
          <div>2 ¬∑ Tanques</div>
          <div class="status" id="status-2">0 tanques</div>
        </div>
        <div class="nav-item" data-step="3" onclick="navTo(3)">
          <div>3 ¬∑ Accesorios por tanque</div>
          <div class="status" id="status-3">‚Äî</div>
        </div>
        <div class="nav-item" data-step="4" onclick="navTo(4)">
          <div>4 ¬∑ Accesorios en redes</div>
          <div class="status" id="status-4">‚Äî</div>
        </div>
        <div class="nav-item" data-step="5" onclick="navTo(5)">
          <div>5 ¬∑ Equipos</div>
          <div class="status" id="status-5">‚Äî</div>
        </div>
        <div class="nav-item" data-step="6" onclick="navTo(6)">
          <div>6 ¬∑ Observaciones & Final</div>
          <div class="status" id="status-6">‚Äî</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn primary" onclick="handleGenerate()">üì§ Generar</button>
        <button class="btn ghost" onclick="resetApp()">Reiniciar</button>
      </div>

      <div style="margin-top:12px;font-size:13px;color:var(--muted)">Progreso: <span id="progressLabel">0 / 8</span></div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- STEP 1 -->
      <section id="step-1" class="step active">
        <div class="card-header">
          <div>
            <div class="card-title">1 ¬∑ Informaci√≥n general por instalaci√≥n</div>
            <div class="hint">Completa los 11 campos obligatorios para continuar.</div>
          </div>
          <div><span class="hint">Paso 1 / 8</span></div>
        </div>

        <div class="row cols-3">
          <div>
            <div class="label">Nombre o raz√≥n social del cliente *</div>
            <div class="field"><input id="g_nombre" type="text" placeholder=""></div>
          </div>
          <div>
            <div class="label">Fecha de inspecci√≥n *</div>
            <div class="field"><input id="g_fecha" type="date" placeholder=""></div>
          </div>
          <div>
            <div class="label">Direcci√≥n *</div>
            <div class="field"><input id="g_direccion" type="text"></div>
          </div>

          <div>
            <div class="label">RUC o DNI *</div>
            <div class="field"><input id="g_ruc" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">N√∫mero de instalaci√≥n *</div>
            <div class="field"><input id="g_numinst" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">Distrito *</div>
            <div class="field"><input id="g_distrito" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">Departamento *</div>
            <div class="field"><input id="g_departamento" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">Coordenadas *</div>
            <div class="field"><input id="g_coordenadas" type="text" placeholder="lat, lon"></div>
          </div>

          <div>
            <div class="label">Nombre del contacto *</div>
            <div class="field"><input id="g_contacto" type="text" placeholder=""></div>
          </div>

          <div>
            <div class="label">N√∫mero del contacto *</div>
            <div class="field"><input id="g_telefono" type="text" placeholder=""></div>
          </div>

          <div style="grid-column:1/-1">
            <div class="label">Correo de contacto *</div>
            <div class="field"><input id="g_correo" type="email" placeholder=""></div>
          </div>
        </div>

        <div id="err-step-1" class="errlist"></div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="saveGeneral(true)">Guardar</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

      <!-- STEP 2: Tanques -->
      <section id="step-2" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">2 ¬∑ Tanques inspeccionados</div>
            <div class="hint">Agrega los tanques en el formulario ‚Äî el n√∫mero se asigna autom√°ticamente.</div>
          </div>
          <div><span class="hint">Paso 2 / 8</span></div>
        </div>

        <!-- Inline form para a√±adir/editar tanque -->
        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div style="min-width:160px;">
              <div class="label">N¬∞ de serie *</div>
              <div class="field"><input id="tank_serie" type="text" placeholder="Serie del tanque"></div>
            </div>

            <div style="min-width:120px;">
              <div class="label">Capacidad (gal)</div>
              <div class="field"><input id="tank_capacidad" type="text" placeholder="p. ej. 120"></div>
            </div>

            <div style="min-width:120px;">
              <div class="label">A√±o de fabricaci√≥n</div>
              <div class="field"><input id="tank_anio" type="number" min="1900" max="2099" placeholder=""></div>
            </div>

            <div style="min-width:160px;">
              <div class="label">Tipo (A√©reo / Soterrado / M√≥vil) *</div>
              <div class="field">
                <select id="tank_tipo" class="custom-select">
                  <option value="">-- seleccionar --</option>
                  <option value="A√©reo">A√©reo</option>
                  <option value="Soterrado">Soterrado</option>
                  <option value="M√≥vil">M√≥vil</option>
                </select>
              </div>
            </div>

            <div style="min-width:160px;">
              <div class="label">Fabricante</div>
              <div class="field"><input id="tank_fabricante" type="text" placeholder=""></div>
            </div>

            <div style="min-width:120px;">
              <div class="label">% Actual</div>
              <div class="field"><input id="tank_porcentaje" type="text" placeholder=""></div>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px">
              <button id="saveTankBtn" class="btn primary" onclick="saveTank()">Agregar / Guardar</button>
              <button class="btn ghost" onclick="clearTankForm()">Limpiar</button>
            </div>
          </div>
          <div id="err-tank" class="errlist" style="margin-top:8px"></div>
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px">
          <button class="btn ghost" onclick="clearTanks()">Limpiar todos los tanques</button>
          <div class="small" style="margin-left:auto">Despu√©s de guardar un tanque puedes editar sus accesorios.</div>
        </div>

        <div id="tanksList" class="list"></div>

        <div id="err-step-2" class="errlist"></div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

      <!-- STEP 3: Accesorios por tanque -->
      <section id="step-3" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">3 ¬∑ Accesorios por tanque</div>
            <div class="hint">Selecciona un tanque y llena sus accesorios. Las v√°lvulas opcionales aparecen solo si activas su checkbox.</div>
          </div>
          <div><span class="hint">Paso 3 / 8</span></div>
        </div>

        <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px">
          <div style="min-width:260px">
            <div class="label">Seleccionar tanque *</div>
            <div class="field">
              <select id="select_tanque" class="custom-select">
                <option value="">-- seleccionar tanque --</option>
              </select>
            </div>
          </div>

          <div style="margin-left:auto; display:flex;gap:8px">
            <button class="btn warn" onclick="openAccModalFromStep3()">Editar accesorios</button>
          </div>
        </div>

        <div id="accTankArea">
          <div class="acc-header" id="acc-titulo">Accesorio del tanque ‚Äî</div>
          <div class="small" style="margin-bottom:10px">Rellena Marca / C√≥digo / Serie / Mes/A√±o de fabricaci√≥n. Si no se completan aparecer√° un gui√≥n en el informe.</div>

          <div id="acc-list"></div>

          <div style="margin-top:10px">
            <label style="font-weight:700;color:var(--muted)">Opcionales (activa para a√±adir)</label>
            <div style="display:flex;gap:12px;margin-top:6px">
              <label><input type="checkbox" id="opt_exceso_retorno"> V√°lvula exceso de flujo (Retorno)</label>
              <label><input type="checkbox" id="opt_exceso_bypass"> V√°lvula exceso de flujo (Bypass)</label>
              <label><input type="checkbox" id="opt_val3"> Val 3</label>
            </div>
          </div>
        </div>

        <div id="err-step-3" class="errlist"></div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

      <!-- STEP 4: Accesorios en redes -->
      <section id="step-4" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">4 ¬∑ Accesorios en redes</div>
            <div class="hint">Agrega accesorios en redes. Selecciona el tipo (amigable) ‚Äî se enviar√° el tipo interno esperado por el servidor.</div>
          </div>
          <div><span class="hint">Paso 4 / 8</span></div>
        </div>

        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div style="min-width:260px;">
              <div class="label">Tipo de accesorio *</div>
              <div class="field">
                <select id="red_tipo" class="custom-select">
                  <option value="">-- seleccionar --</option>
                  <option value="llenado_toma_desplazada">V√°lvula de llenado de toma desplazada</option>
                  <option value="retorno_toma_desplazada">V√°lvula de retorno de toma desplazada</option>
                  <option value="alivio_hidrostatico">V√°lvula de alivio hidrost√°tico</option>
                  <option value="regulador_primera_etapa">Regulador de primera etapa</option>
                  <option value="alivio">V√°lvula de alivio</option>
                  <option value="regulador_2da">Regulador de segunda etapa</option>
                  <option value="pull_away">V√°lvula Pull Away</option>
                  <option value="zona_medidores">Zona de medidores (Tiene / No)</option>
                </select>
              </div>
            </div>

            <div style="min-width:160px;">
              <div class="label">Marca</div>
              <div class="field"><input id="red_marca" type="text"></div>
            </div>

            <div style="min-width:160px;">
              <div class="label">Serie</div>
              <div class="field"><input id="red_serie" type="text"></div>
            </div>

            <div style="min-width:160px;">
              <div class="label">C√≥digo</div>
              <div class="field"><input id="red_codigo" type="text"></div>
            </div>

            <div style="min-width:200px;">
              <div class="label">Mes/A√±o de fabricaci√≥n</div>
              <div class="field"><input id="red_mesano" type="text" placeholder="MM/YYYY"></div>
            </div>

            <div style="margin-left:auto; display:flex; gap:8px">
              <button class="btn primary" onclick="addRed()">Agregar</button>
              <button class="btn ghost" onclick="clearRedForm()">Limpiar</button>
            </div>
          </div>

          <div id="zonaMedidoresControls" style="display:none;margin-top:8px">
            <div class="label">Zona de medidores</div>
            <div style="display:flex;gap:12px;align-items:center">
              <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="zona_med" value="true"> Tiene</label>
              <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="zona_med" value="false"> No tiene</label>
            </div>
          </div>
        </div>

        <div>
          <div class="label" style="margin-bottom:6px">Lista de accesorios en redes</div>
          <div id="redList"></div>
        </div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

      <!-- STEP 5: Equipos -->
      <section id="step-5" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">5 ¬∑ Equipos de la instalaci√≥n</div>
            <div class="hint">Agrega equipos ‚Äî el nombre "Equipo" se genera autom√°ticamente (Vaporizador1, Quemador1...).</div>
          </div>
          <div><span class="hint">Paso 5 / 8</span></div>
        </div>

        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="min-width:220px">
              <div class="label">Tipo de equipo *</div>
              <div class="field">
                <select id="eq_tipo" class="custom-select" onchange="onEqTipoChange()">
                  <option value="">-- seleccionar --</option>
                  <option value="vaporizador">Vaporizador</option>
                  <option value="quemador">Quemador</option>
                  <option value="decantador">Decantador</option>
                  <option value="dispensador_de_gas">Dispensador de gas</option>
                  <option value="bomba">Bomba</option>
                  <option value="tablero">Tablero</option>
                  <option value="estabilizador">Estabilizador</option>
                  <option value="detector">Detector</option>
                  <option value="extintor">Extintor</option>
                </select>
              </div>
            </div>

            <div style="min-width:220px">
              <div class="label">Equipo (generado) </div>
              <div class="field"><input id="eq_name" type="text" disabled></div>
            </div>

            <div id="dynamicFields" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div>

            <div style="margin-left:auto;display:flex;gap:8px">
              <button class="btn primary" onclick="addEquipo()">Agregar Equipo</button>
              <button class="btn ghost" onclick="clearEquipoForm()">Limpiar</button>
            </div>
          </div>
        </div>

        <div>
          <div class="label">Lista de equipos</div>
          <div id="equiposList"></div>
        </div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

      <!-- STEP 6: Observaciones y env√≠o -->
      <section id="step-6" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">6 ¬∑ Observaciones & Final</div>
            <div class="hint">Revisa todo y genera el informe Word.</div>
          </div>
          <div><span class="hint">Paso 6 / 8</span></div>
        </div>

        <div>
          <div class="label">7.1 Observaciones al cliente</div>
          <div class="field"><textarea id="obs_71" rows="2" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>

          <div class="label" style="margin-top:8px">7.2 Observaciones en red de llenado y retorno</div>
          <div class="field"><textarea id="obs_72" rows="2" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>

          <div class="label" style="margin-top:8px">7.3 Observaciones en zona de tanque</div>
          <div class="field"><textarea id="obs_73" rows="2" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>

          <div class="label" style="margin-top:8px">7.4 Observaciones en red de consumo</div>
          <div class="field"><textarea id="obs_74" rows="2" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>

          <div class="label" style="margin-top:8px">7.5 Observaciones en equipos varios (separar por punto)</div>
          <div class="field"><textarea id="obs_75" rows="3" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>
        </div>

        <div id="err-step-6" class="errlist"></div>

        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <!-- Avanza a Paso 7 (Actividades) -->
          <button class="btn primary" id="toStep7Btn" onclick="showStep(7)">Siguiente: Actividades ‚Üí</button>
        </div>
      </section>

      <!-- ========== STEP 7: ACTIVIDADES (Subt√≠tulo 10) ========== -->
      <section id="step-7" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">7 ¬∑ Actividades realizadas (Subt√≠tulo 10)</div>
            <div class="hint">Agrega actividades por tanque o por red. Cada actividad requiere fotos ANTES y DESPU√âS en el siguiente paso.</div>
          </div>
          <div><span class="hint">Paso 7 / 8</span></div>
        </div>

        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:8px;align-items:end;flex-wrap:wrap">
            <div style="min-width:240px">
              <div class="label">Contexto (tanque / red)</div>
              <div class="field">
                <select id="actividad_contexto" class="custom-select">
                  <!-- options populated dynamically by rebuildTankSelects() -->
                </select>
              </div>
            </div>

            <div style="flex:1; min-width:320px">
              <div class="label">T√≠tulo de la actividad</div>
              <div class="field"><input id="actividad_titulo" type="text" placeholder="Ej: Reemplazo v√°lvula de llenado"></div>
            </div>

            <div style="min-width:140px">
              <div class="label">Tiempo (hrs)</div>
              <div class="field"><input id="actividad_tiempo" type="text" placeholder="0.5"></div>
            </div>

            <div style="min-width:140px">
              <div class="label">Estado</div>
              <div class="field">
                <select id="actividad_estado" class="custom-select">
                  <option value="realizado">Realizado</option>
                  <option value="pendiente">Pendiente</option>
                </select>
              </div>
            </div>

            <div style="margin-left:auto">
              <button class="btn primary" onclick="addActividad()">Agregar actividad</button>
            </div>
          </div>
        </div>

        <div>
          <table style="width:100%">
            <thead>
              <tr><th>#</th><th>Contexto</th><th>T√≠tulo</th><th>Tiempo</th><th>Estado</th><th>Acciones</th></tr>
            </thead>
            <tbody id="actividades_table_body"></tbody>
          </table>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn ghost" onclick="showStep(6)">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="onActividadesNext()">Siguiente: Subir fotos ‚Üí</button>
        </div>
      </section>

      <!-- ========== STEP 8: SUBIDA DE FOTOS (Puntos 8, 9 y actividades 10) ========== -->
      <section id="step-8" class="step">
        <div class="card-header">
          <div>
            <div class="card-title">8 ¬∑ Subida de fotos (Punto 8, Punto 9 y Actividades 10)</div>
            <div class="hint">Sube las fotos correspondientes. Para actividades (subt√≠tulo 10) se solicitan dos fotos: ANTES y DESPU√âS.</div>
          </div>
          <div><span class="hint">Paso 8 / 8</span></div>
        </div>

        <div class="fut-table">
          <table id="photoTable" style="width:100%">
            <thead>
              <tr><th>Subt√≠tulo</th><th style="width:120px;text-align:center">Cantidad</th><th style="width:120px;text-align:center">Estatus</th><th style="width:260px">Acciones</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn ghost" onclick="showStep(7)">‚Üê Anterior</button>
          <div style="flex:1"></div>
          <button class="btn primary" id="finalGenerateWithPhotos">Generar Documento Final ‚Üí</button>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- Modal: editar accesorios por tanque -->
<div id="modalAcc" class="modal-back">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Editar accesorios</h3>
    <div id="modalContent">
      <table class="acc-table" id="modalAccTable">
        <thead>
          <tr>
            <th>Accesorio</th><th>Marca</th><th>C√≥digo</th><th>Serie</th><th>Mes/A√±o</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn ghost" onclick="closeAccModal()">Cancelar</button>
      <button class="btn primary" onclick="saveAccModal()">Guardar</button>
    </div>
  </div>
</div>

<!-- Photo preview modal (new) -->
<div id="photoPreviewModal" style="display:none">
  <div class="modal">
    <h3 id="previewModalTitle">Previsualizar fotos</h3>
    <div id="previewGrid" class="grid" style="margin-top:12px"></div>
    <div style="text-align:right;margin-top:12px"><button class="btn danger" onclick="closePhotoPreview()">Cerrar</button></div>
  </div>
</div>

<!-- Hidden file input used to attach images for tokens -->
<input type="file" id="hiddenFileInput" style="display:none" accept="image/*" multiple>
<script>
/* -------------------------
   Allowed emails (client-side)
   ------------------------- */
const allowedEmails = [
  "alexander.buleje@solgas.com.pe",
  "renzo.delgado@solgas.com.pe",
  "ingenieriaeye@hotmail.com",
  "jarmas@inginor.com.pe",
  "Jaime.valdeiglesias16@totalgassac.com",
  "area.mantenimiento@gsgasperu.com",
  "mantenimiento@cmagol.com.pe",
  "aherrera@gypingenieros.com",
  "iserrepe@openersac.com",
  "operacionesglp@northcompany.com.pe",
  "ingenieria1@semmaq.com",
  "administracion@citecservices.com"
];

/* -------------------------
   Estado de la app (modelo en memoria)
   ------------------------- */
let state = {
  general: {},
  tanques: [],                 // array of { serie, capacidad, anio, tipo, fabricante, porcentaje }
  accesoriosTanque: {},       // { "1": { "V√°lvula de llenado": {Marca, C√≥digo, Serie, "Mes/A√±o de fabricaci√≥n"}, ... } }
  accesoriosRed: [],          // array of { Tipo, Marca, Serie, C√≥digo, "Mes/A√±o de fabricaci√≥n" }
  equipos: [],                // array of objects consistent with estructura_equipos
  observaciones: {},          // { "7.1": "...", ... }
  actividades: [],            // array of { id, contexto, titulo, tiempo, estado }
  imagesByToken: {},          // { token: [File, File, ...] }  // used only client-side for preview; final upload uses FormData append
};

/* Counters */
let actividadIdCounter = 1;

/* UTIL: show/hide steps and update progress */
function showStep(n) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('step-' + n);
  if (el) el.classList.add('active');
  // Update nav active
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  const nav = document.querySelector(`.nav-item[data-step="${n}"]`);
  if (nav) nav.classList.add('active');
  updateProgress(n);
  if (n === 3) renderAccList();
  if (n === 2) renderTanks();
  if (n === 4) renderRedList();
  if (n === 5) renderEquiposList();
  if (n === 7) renderActividadesTable();
  if (n === 8) buildPhotoTable();
}

function navTo(n) { showStep(n); }

function updateProgress(step) {
  const total = 8;
  let completed = 0;
  for (let i=1;i<=step;i++) completed++;
  document.getElementById('progressLabel').innerText = `${step} / ${total}`;
  const pct = Math.round((step/total)*100);
  document.getElementById('topProgress').style.width = pct + '%';
}

/* -------------------------
   LOGIN (simple client-side check)
   ------------------------- */
function doLogin(){
  const email = document.getElementById('loginEmail').value.trim();
  const company = document.getElementById('loginCompany').value.trim();
  if(!email || !company){ document.getElementById('loginErr').innerText='Completa ambos campos.'; document.getElementById('loginErr').style.display='block'; return; }
  if(!allowedEmails.includes(email.toLowerCase())){ document.getElementById('loginErr').innerText='Correo no autorizado.'; document.getElementById('loginErr').style.display='block'; return; }
  // set minimal UI
  document.getElementById('sidebarCompany').innerText = company;
  document.getElementById('sidebarEmail').innerText = email;
  document.getElementById('userInitials').innerText = email.split('@')[0].slice(0,2).toUpperCase();
  document.getElementById('loginOverlay').style.display = 'none';
}
function loginCancel(){ window.close?.(); }

/* -------------------------
   STEP NAV helpers
   ------------------------- */
function nextStep(){
  const cur = Array.from(document.querySelectorAll('.step')).findIndex(s=>s.classList.contains('active')) + 1;
  if(cur < 8) showStep(cur+1);
}
function prevStep(){
  const cur = Array.from(document.querySelectorAll('.step')).findIndex(s=>s.classList.contains('active')) + 1;
  if(cur > 1) showStep(cur-1);
}

/* -------------------------
   GENERAL
   ------------------------- */
function saveGeneral(next){
  const g = {
    "Nombre o raz√≥n social del cliente": document.getElementById('g_nombre').value.trim(),
    "Fecha de inspecci√≥n": document.getElementById('g_fecha').value,
    "Direcci√≥n": document.getElementById('g_direccion').value.trim(),
    "RUC o DNI": document.getElementById('g_ruc').value.trim(),
    "N√∫mero de instalaci√≥n": document.getElementById('g_numinst').value.trim(),
    "Distrito": document.getElementById('g_distrito').value.trim(),
    "Departamento": document.getElementById('g_departamento').value.trim(),
    "Coordenadas": document.getElementById('g_coordenadas').value.trim(),
    "Nombre del contacto": document.getElementById('g_contacto').value.trim(),
    "N√∫mero del contacto": document.getElementById('g_telefono').value.trim(),
    "Correo de contacto": document.getElementById('g_correo').value.trim(),
  };
  const missing = Object.keys(g).filter(k=>!g[k]);
  if(missing.length){
    document.getElementById('err-step-1').innerText = "Faltan campos obligatorios: " + missing.join(', ');
    return false;
  }
  state.general = g;
  document.getElementById('err-step-1').innerText = '';
  if(next) nextStep();
  return true;
}

/* -------------------------
   TANQUES
   ------------------------- */
function clearTankForm(){
  document.getElementById('tank_serie').value='';
  document.getElementById('tank_capacidad').value='';
  document.getElementById('tank_anio').value='';
  document.getElementById('tank_tipo').value='';
  document.getElementById('tank_fabricante').value='';
  document.getElementById('tank_porcentaje').value='';
  document.getElementById('err-tank').innerText='';
}

function saveTank(){
  const serie = document.getElementById('tank_serie').value.trim();
  const capacidad = document.getElementById('tank_capacidad').value.trim();
  const anio = document.getElementById('tank_anio').value;
  const tipo = document.getElementById('tank_tipo').value;
  const fabricante = document.getElementById('tank_fabricante').value.trim();
  const porcentaje = document.getElementById('tank_porcentaje').value.trim();
  if(!serie || !tipo){ document.getElementById('err-tank').innerText='El N¬∞ de serie y Tipo son obligatorios'; return; }
  // push new
  state.tanques.push({
    serie, capacidad, anio, tipo, fabricante, porcentaje
  });
  // create empty accessories object for this tank index (1-based keys)
  const key = String(state.tanques.length);
  if(!state.accesoriosTanque[key]) {
    // prepare default structure
    const accesorios = [
      "V√°lvula de llenado",
      "Medidor de porcentaje",
      "V√°lvula de seguridad",
      "V√°lvula de drenaje",
      "Multiv√°lvula",
      "V√°lvula exceso de flujo (Retorno)",
      "V√°lvula exceso de flujo (Bypass)",
      "Val 3",
    ];
    state.accesoriosTanque[key] = {};
    accesorios.forEach(a=>{
      state.accesoriosTanque[key][a] = { "Marca":"", "C√≥digo":"", "Serie":"", "Mes/A√±o de fabricaci√≥n":"" };
    });
  }
  clearTankForm();
  renderTanks();
  updateStatuses();
}

function renderTanks(){
  const list = document.getElementById('tanksList');
  list.innerHTML = '';
  state.tanques.forEach((t, idx)=>{
    const n = idx+1;
    const div = document.createElement('div');
    div.className = 'tank-card';
    div.innerHTML = `<div class="tank-info">
        <div><strong>#${n}</strong></div>
        <div>Serie: ${t.serie || '-'}</div>
        <div>Tipo: ${t.tipo || '-'}</div>
        <div>Cap: ${t.capacidad || '-'}</div>
        <div>%: ${t.porcentaje || '-'}</div>
      </div>
      <div class="tank-actions">
        <button class="btn small ghost" onclick="editTank(${idx})">Editar</button>
        <button class="btn warn" onclick="openAccModal(${n})">Accesorios</button>
        <button class="btn small danger" onclick="removeTank(${idx})">Eliminar</button>
      </div>`;
    list.appendChild(div);
  });
  // refresh select in step 3 + actividad contexto
  rebuildTankSelects();
}

function editTank(idx){
  const t = state.tanques[idx];
  document.getElementById('tank_serie').value = t.serie || '';
  document.getElementById('tank_capacidad').value = t.capacidad || '';
  document.getElementById('tank_anio').value = t.anio || '';
  document.getElementById('tank_tipo').value = t.tipo || '';
  document.getElementById('tank_fabricante').value = t.fabricante || '';
  document.getElementById('tank_porcentaje').value = t.porcentaje || '';
  // remove old, user will re-add as new to simplify (could extend to real edit)
  state.tanques.splice(idx,1);
  // rebuild accesorios keys so they remain aligned (remove last)
  const newAcc = {};
  state.tanques.forEach((_, i)=>{
    const prev = state.accesoriosTanque[String(i+1)] || {};
    newAcc[String(i+1)] = prev;
  });
  state.accesoriosTanque = newAcc;
  renderTanks();
}

function removeTank(idx){
  if(!confirm('Eliminar tanque?')) return;
  // remove accesorios entry too: keys shift ‚Äî to keep things consistent we'll rebuild accesoriosTanque keys
  state.tanques.splice(idx,1);
  const newAcc = {};
  state.tanques.forEach((t, i)=>{
    // reuse previous if exists, else blank
    const prev = state.accesoriosTanque[String(i+1)] || {};
    newAcc[String(i+1)] = prev;
  });
  state.accesoriosTanque = newAcc;
  renderTanks();
  updateStatuses();
}

function clearTanks(){
  if(!confirm('Limpiar todos los tanques?')) return;
  state.tanques = [];
  state.accesoriosTanque = {};
  renderTanks();
  updateStatuses();
}

/* -------------------------
   ACCESORIOS por TANQUE (modal)
   ------------------------- */
function rebuildTankSelects(){
  // step-3 select
  const sel = document.getElementById('select_tanque');
  sel.innerHTML = '<option value="">-- seleccionar tanque --</option>';
  state.tanques.forEach((t, idx)=>{
    const opt = document.createElement('option');
    opt.value = String(idx+1);
    opt.textContent = `Tanque ${idx+1} ‚Äî Serie: ${t.serie || '-'}`;
    sel.appendChild(opt);
  });

  // actividad contexto must include tanque_{i} values and two fixed redes: red_llenado and red_consumo
  const ctx = document.getElementById('actividad_contexto');
  if(!ctx) return;
  ctx.innerHTML = ''; // clear all
  // add tank contexts
  state.tanques.forEach((t, idx)=>{
    const opt = document.createElement('option');
    opt.value = `tanque_${idx+1}`;
    opt.textContent = `Tanque ${idx+1} ‚Äî ${t.serie || ''}`;
    ctx.appendChild(opt);
  });

  // add fixed red contexts (exact names as requested)
  const optL = document.createElement('option');
  optL.value = 'red_llenado';
  optL.textContent = 'Red de llenado y retorno';
  ctx.appendChild(optL);

  const optC = document.createElement('option');
  optC.value = 'red_consumo';
  optC.textContent = 'Red de consumo';
  ctx.appendChild(optC);

  // Attach onchange handler to select_tanque so that acc-list updates when user switches
  const selectTankEl = document.getElementById('select_tanque');
  if(selectTankEl) selectTankEl.onchange = renderAccList;
}

function openAccModalFromStep3(){
  const sel = document.getElementById('select_tanque').value;
  if(!sel){ alert('Selecciona un tanque primero.'); return; }
  openAccModal(parseInt(sel));
}

let currentModalTank = null;
function openAccModal(tankNum){
  currentModalTank = tankNum;
  const modal = document.getElementById('modalAcc');
  modal.classList.add('active');
  document.getElementById('modalTitle').innerText = `Accesorios del Tanque ${tankNum}`;
  populateModalAccTable(tankNum);
}

function closeAccModal(){
  document.getElementById('modalAcc').classList.remove('active');
  currentModalTank = null;
}

function populateModalAccTable(tankNum){
  const tbody = document.querySelector('#modalAccTable tbody');
  tbody.innerHTML = '';
  const key = String(tankNum);
  const accesorios = state.accesoriosTanque[key] || {};
  const accNames = Object.keys(accesorios);
  if(accNames.length === 0){
    // create defaults if empty
    const defaults = [
      "V√°lvula de llenado",
      "Medidor de porcentaje",
      "V√°lvula de seguridad",
      "V√°lvula de drenaje",
      "Multiv√°lvula",
      "V√°lvula exceso de flujo (Retorno)",
      "V√°lvula exceso de flujo (Bypass)",
      "Val 3",
    ];
    state.accesoriosTanque[key] = {};
    defaults.forEach(d=>{
      state.accesoriosTanque[key][d] = { "Marca":"", "C√≥digo":"", "Serie":"", "Mes/A√±o de fabricaci√≥n":"" };
    });
  }
  const accList = Object.entries(state.accesoriosTanque[key]);
  accList.forEach(([accName, fields], idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="accesorio">${accName}</td>
      <td><input data-acc="${accName}" data-field="Marca" value="${fields['Marca'] || ''}"></td>
      <td><input data-acc="${accName}" data-field="C√≥digo" value="${fields['C√≥digo'] || ''}"></td>
      <td><input data-acc="${accName}" data-field="Serie" value="${fields['Serie'] || ''}"></td>
      <td><input data-acc="${accName}" data-field="Mes/A√±o de fabricaci√≥n" value="${fields['Mes/A√±o de fabricaci√≥n'] || ''}"></td>
    `;
    tbody.appendChild(tr);
  });
}

function saveAccModal(){
  if(!currentModalTank) return;
  const key = String(currentModalTank);
  const tbody = document.querySelector('#modalAccTable tbody');
  const inputs = tbody.querySelectorAll('input');
  inputs.forEach(inp=>{
    const acc = inp.dataset.acc;
    const field = inp.dataset.field;
    const val = inp.value.trim();
    if(!state.accesoriosTanque[key]) state.accesoriosTanque[key] = {};
    if(!state.accesoriosTanque[key][acc]) state.accesoriosTanque[key][acc] = {"Marca":"","C√≥digo":"","Serie":"","Mes/A√±o de fabricaci√≥n":""};
    state.accesoriosTanque[key][acc][field] = val;
  });
  closeAccModal();
  renderAccList();
  updateStatuses();
}

function renderAccList(){
  const sel = document.getElementById('select_tanque').value;
  const container = document.getElementById('acc-list');
  container.innerHTML = '';
  if(!sel){ container.innerHTML = '<div class="small">Selecciona un tanque para ver sus accesorios.</div>'; document.getElementById('acc-titulo').innerText = 'Accesorio del tanque ‚Äî'; return; }
  const key = String(sel);
  const tIndex = parseInt(key) - 1;
  const serie = state.tanques[tIndex] ? (state.tanques[tIndex].serie || '-') : '-';
  document.getElementById('acc-titulo').innerText = `Accesorio del tanque ‚Äî Tanque ${key} (Serie: ${serie})`;
  const accs = state.accesoriosTanque[key] || {};
  const table = document.createElement('table');
  table.className = 'acc-table';
  table.innerHTML = `<thead><tr><th>Accesorio</th><th>Marca</th><th>C√≥digo</th><th>Serie</th><th>Mes/A√±o</th></tr></thead>`;
  const tbody = document.createElement('tbody');
  Object.entries(accs).forEach(([name, fields])=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td>${fields['Marca']||'-'}</td><td>${fields['C√≥digo']||'-'}</td><td>${fields['Serie']||'-'}</td><td>${fields['Mes/A√±o de fabricaci√≥n']||'-'}</td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

/* -------------------------
   ACCESORIOS EN RED
   ------------------------- */
function clearRedForm(){
  document.getElementById('red_tipo').value='';
  document.getElementById('red_marca').value='';
  document.getElementById('red_serie').value='';
  document.getElementById('red_codigo').value='';
  document.getElementById('red_mesano').value='';
  document.getElementById('zonaMedidoresControls').style.display = 'none';
}
document.getElementById('red_tipo').addEventListener('change', function(){
  if(this.value === 'zona_medidores'){ document.getElementById('zonaMedidoresControls').style.display = 'block'; } else { document.getElementById('zonaMedidoresControls').style.display = 'none'; }
});

function addRed(){
  const tipo = document.getElementById('red_tipo').value;
  if(!tipo){ alert('Selecciona un tipo'); return; }
  const obj = {
    Tipo: tipo,
    Marca: document.getElementById('red_marca').value.trim(),
    Serie: document.getElementById('red_serie').value.trim(),
    C√≥digo: document.getElementById('red_codigo').value.trim(),
    "Mes/A√±o de fabricaci√≥n": document.getElementById('red_mesano').value.trim()
  };
  state.accesoriosRed.push(obj);
  clearRedForm();
  renderRedList();
  rebuildTankSelects();
  updateStatuses();
}

function renderRedList(){
  const container = document.getElementById('redList');
  container.innerHTML = '';
  if(state.accesoriosRed.length === 0) { container.innerHTML = '<div class="small">No hay accesorios en redes a√±adidos.</div>'; return; }
  const table = document.createElement('table');
  table.className = 'acc-table';
  table.innerHTML = `<thead><tr><th>#</th><th>Tipo</th><th>Marca</th><th>Serie</th><th>C√≥digo</th><th>Mes/A√±o</th><th>Acciones</th></tr></thead>`;
  const tbody = document.createElement('tbody');
  state.accesoriosRed.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${r.Tipo}</td><td>${r.Marca||'-'}</td><td>${r.Serie||'-'}</td><td>${r.C√≥digo||'-'}</td><td>${r['Mes/A√±o de fabricaci√≥n']||'-'}</td>
      <td><button class="btn small ghost" onclick="editRed(${idx})">Editar</button> <button class="btn small danger" onclick="removeRed(${idx})">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function editRed(idx){
  const r = state.accesoriosRed[idx];
  document.getElementById('red_tipo').value = r.Tipo || '';
  document.getElementById('red_marca').value = r.Marca || '';
  document.getElementById('red_serie').value = r.Serie || '';
  document.getElementById('red_codigo').value = r.C√≥digo || '';
  document.getElementById('red_mesano').value = r['Mes/A√±o de fabricaci√≥n'] || '';
  // remove so re-adding will save new values
  state.accesoriosRed.splice(idx,1);
  renderRedList();
  rebuildTankSelects();
}

function removeRed(idx){
  if(!confirm('Eliminar accesorio de red?')) return;
  state.accesoriosRed.splice(idx,1);
  renderRedList();
  rebuildTankSelects();
  updateStatuses();
}

/* -------------------------
   EQUIPOS
   ------------------------- */
const equiposStructure = {
  "vaporizador": ["Equipo","Marca","Tipo","Serie","A√±o de fabricaci√≥n","Capacidad"],
  "quemador": ["Equipo","Marca","Modelo","Tipo","Serie","A√±o de fabricaci√≥n","Capacidad (kW)"],
  "decantador": ["Equipo","Fabricante","Modelo","Tipo","Serie","A√±o de fabricaci√≥n","Capacidad (gal)"],
  "dispensador_de_gas": ["Equipo","Marca","Modelo","Serie"],
  "bomba": ["Equipo","Marca","Modelo","Serie"],
  "tablero": ["Equipo","TAG"],
  "estabilizador": ["Equipo","Marca","Modelo","Serie"],
  "detector": ["Equipo","Marca","Modelo","Serie"],
  "extintor": ["Equipo","Marca","Serie","A√±o de fabricaci√≥n","Pr√≥xima PH","Fecha de pr√≥xima recarga"]
};

function onEqTipoChange(){
  const tipo = document.getElementById('eq_tipo').value;
  const dynamic = document.getElementById('dynamicFields');
  dynamic.innerHTML = '';
  if(!tipo) { document.getElementById('eq_name').value = ''; return; }
  // generate default Equipo name like Vaporizador1 (count existing)
  const count = state.equipos.filter(e=> (e['Tipo de equipo']||'') === tipo).length + 1;
  const generatedName = tipo.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()) + ' ' + count;
  document.getElementById('eq_name').value = generatedName;
  const cols = equiposStructure[tipo] || ["Equipo"];
  cols.slice(1).forEach(col=>{
    const wrapper = document.createElement('div');
    wrapper.style.minWidth = '160px';
    wrapper.innerHTML = `<div class="label" style="margin-bottom:4px">${col}</div><div class="field"><input data-col="${col}" class="eq-dyn" type="text"></div>`;
    dynamic.appendChild(wrapper);
  });
}

function clearEquipoForm(){
  document.getElementById('eq_tipo').value='';
  document.getElementById('eq_name').value='';
  document.getElementById('dynamicFields').innerHTML='';
}

function addEquipo(){
  const tipo = document.getElementById('eq_tipo').value;
  if(!tipo){ alert('Selecciona tipo de equipo'); return; }
  const cols = equiposStructure[tipo] || ["Equipo"];
  const obj = {};
  const equipoNombre = document.getElementById('eq_name').value || '';
  obj['Tipo de equipo'] = tipo;
  // first column Equipo set to generated or input
  obj[cols[0]] = equipoNombre;
  // dynamic inputs
  const inputs = document.querySelectorAll('.eq-dyn');
  inputs.forEach(inp=>{
    const col = inp.dataset.col;
    obj[col] = inp.value.trim();
  });
  state.equipos.push(obj);
  clearEquipoForm();
  renderEquiposList();
  rebuildTankSelects();
  updateStatuses();
}

function renderEquiposList(){
  const c = document.getElementById('equiposList');
  c.innerHTML = '';
  if(state.equipos.length === 0){ c.innerHTML = '<div class="small">No hay equipos a√±adidos.</div>'; return; }
  const table = document.createElement('table');
  table.className = 'acc-table';
  const cols = new Set();
  state.equipos.forEach(e=>Object.keys(e).forEach(k=>cols.add(k)));
  const headerCols = Array.from(cols);
  table.innerHTML = `<thead><tr>${headerCols.map(h=>`<th>${h}</th>`).join('')}<th>Acciones</th></tr></thead>`;
  const tbody = document.createElement('tbody');
  state.equipos.forEach((e, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `${headerCols.map(h=>`<td>${e[h]||'-'}</td>`).join('')}<td><button class="btn small ghost" onclick="editEquipo(${idx})">Editar</button> <button class="btn small danger" onclick="removeEquipo(${idx})">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  c.appendChild(table);
}

function editEquipo(idx){
  const e = state.equipos[idx];
  // simple edit approach: fill form with data, delete old
  document.getElementById('eq_tipo').value = e['Tipo de equipo'] || '';
  onEqTipoChange();
  document.getElementById('eq_name').value = e['Equipo'] || '';
  // fill dynamic inputs
  const inputs = document.querySelectorAll('.eq-dyn');
  inputs.forEach(inp=>{
    const col = inp.dataset.col;
    if(e[col]) inp.value = e[col];
  });
  state.equipos.splice(idx,1);
  renderEquiposList();
}

function removeEquipo(idx){
  if(!confirm('Eliminar equipo?')) return;
  state.equipos.splice(idx,1);
  renderEquiposList();
  rebuildTankSelects();
  updateStatuses();
}

/* -------------------------
   ACTIVIDADES
   ------------------------- */
function addActividad(){
  const ctx = document.getElementById('actividad_contexto').value;
  if(!ctx){ alert('Selecciona un contexto (tanque o red)'); return; }
  const titulo = document.getElementById('actividad_titulo').value.trim();
  const tiempo = document.getElementById('actividad_tiempo').value.trim();
  const estado = document.getElementById('actividad_estado').value;
  if(!titulo){ alert('Ingresa t√≠tulo de actividad'); return; }
  const id = actividadIdCounter++;
  // context must be tanque_X or red_*
  state.actividades.push({ id: String(id), contexto: ctx, titulo, tiempo, estado });
  // clear inputs
  document.getElementById('actividad_titulo').value='';
  document.getElementById('actividad_tiempo').value='';
  renderActividadesTable();
  buildPhotoTable(); // reflect activities in photo table
}

function renderActividadesTable(){
  const body = document.getElementById('actividades_table_body');
  body.innerHTML = '';
  state.actividades.forEach((a, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${a.contexto}</td><td>${a.titulo}</td><td>${a.tiempo||'-'}</td><td>${a.estado}</td>
      <td><button class="btn small ghost" onclick="editActividad('${a.id}')">Editar</button> <button class="btn small danger" onclick="removeActividad('${a.id}')">Eliminar</button></td>`;
    body.appendChild(tr);
  });
}

function editActividad(id){
  const idx = state.actividades.findIndex(x=>x.id===id);
  if(idx<0) return;
  const a = state.actividades[idx];
  document.getElementById('actividad_titulo').value = a.titulo;
  document.getElementById('actividad_tiempo').value = a.tiempo;
  document.getElementById('actividad_estado').value = a.estado;
  document.getElementById('actividad_contexto').value = a.contexto;
  // remove old entry (user will re-add)
  state.actividades.splice(idx,1);
  renderActividadesTable();
  buildPhotoTable();
}

function removeActividad(id){
  if(!confirm('Eliminar actividad?')) return;
  state.actividades = state.actividades.filter(a=>a.id !== id);
  renderActividadesTable();
  buildPhotoTable();
}

function onActividadesNext(){
  // when going to photo step, ensure activities contexts exist in select
  rebuildTankSelects();
  showStep(8);
}

/* -------------------------
   PHOTO UPLOAD / TOKENS / TABLE
   ------------------------- */

/*
 Photo table contains rows for:
  - Punto 8 (establecimiento)
  - Bloque 9: generated tokens for each expected subtitulo (we'll mirror backend token strategy simply)
  - Activities (each activity requires two files: {id}_before and {id}_after)
  - Punto 11
 The table will disable attach buttons for rows that "no aplican" according to the current state (e.g., accesorios de red no a√±adidos).
*/

function buildPhotoTable(){
  const tbody = document.querySelector('#photoTable tbody');
  tbody.innerHTML = '';
  const rows = [];

  // Punto 8
  rows.push({ label: '8. EVIDENCIA (establecimiento)', tokens: ['sub_8_establecimiento','8_establecimiento','8'], required: 1, key: '8_establecimiento', enabled: true });

  // Bloque 9: general panorama token 9_1
  rows.push({ label: '9.1 FOTO PANOR√ÅMICA DE LA ZONA', tokens: ['9_1','9_panoramica_general','9_panoramica'], required: 1, key: '9_1', enabled: true });

  // For each tank -> placa, panoramica (4), specifics
  let dynamicIndex = 2; // to emulate numbering 9.2, 9.3... (frontend numbering for visual only)
  state.tanques.forEach((t, idx)=>{
    const i = idx+1;
    rows.push({ label: `PLACA DE TANQUE ${i} ‚Äî Serie: ${t.serie || '-'}`, tokens: [`tanque_${i}_placa`, `9_${dynamicIndex}`], required: 1, key: `tanque_${i}_placa`, enabled: true }); dynamicIndex++;
    rows.push({ label: `PANOR√ÅMICA ALREDEDORES TANQUE ${i}`, tokens: [`tanque_${i}_panoramica`, `9_${dynamicIndex}`], required: 4, key: `tanque_${i}_panoramica`, enabled: true }); dynamicIndex++;
    const specifics = ['bases','manometro_0_60','manometro_0_300','chicote','stickers','anclajes','valvula_llenado','valvula_seguridad','valvula_drenaje','multivalvula','medidor_porcentaje'];
    specifics.forEach(s=>{
      rows.push({ label: `${s.replace(/_/g,' ').toUpperCase()} TANQUE ${i}`, tokens: [`tanque_${i}_${s}`, `9_${dynamicIndex}`], required: 1, key: `tanque_${i}_${s}`, enabled: true });
      dynamicIndex++;
    });
  });

  // Equipos espec√≠ficos (foto de placa y foto)
  const equipoTipos = ["estabilizador","quemador","vaporizador","tablero","bomba","dispensador_de_gas","decantador","detector"];
  equipoTipos.forEach((tipo)=>{
    rows.push({ label: `FOTO PLACA ${tipo.toUpperCase()}`, tokens: [ `${tipo}_placa` ], required: 1, key: `${tipo}_placa`, enabled: Boolean(state.equipos.some(e => (e['Tipo de equipo']||'') === tipo)) });
    rows.push({ label: `FOTO ${tipo.toUpperCase()}`, tokens: [ `${tipo}_foto` ], required: 1, key: `${tipo}_foto`, enabled: Boolean(state.equipos.some(e => (e['Tipo de equipo']||'') === tipo)) });
  });

  // Map accesorios individuales (red).
  // Special logic: if at least one of the toma desplazada accessories (llenado_toma_desplazada OR retorno_toma_desplazada)
  // exists in accesoriosRed, enable the subt√≠tulos relacionados a toma desplazada (both).
  const mapa = ["llenado_toma_desplazada","retorno_toma_desplazada","alivio","regulador_2da","pull_away","alivio_hidrostatico","regulador_primera_etapa"];
  // detect existence
  const tomaExists = state.accesoriosRed.some(r=>{
    const t = (r.Tipo||'').toLowerCase();
    return t === 'llenado_toma_desplazada' || t === 'retorno_toma_desplazada';
  });
		rows.push({ label: `FOTO PUNTO DE TRANSFERENCIA DESPLAZADO`, tokens: ['punto_trans_desplazada'], required: 1, key: 'punto_trans_desplazada', enabled: true });
		rows.push({ label: `FOTO CAJA DE TOMA DESPLAZADA`, tokens: ['toma_desplazada_caja'], required: 1, key: 'toma_desplazada_caja', enabled: true });
		rows.push({ label: `FOTO RECORRIDO DESDE TOMA DESPLAZADA`, tokens: ['toma_desplazada_recorrido'], required: 1, key: 'toma_desplazada_recorrido', enabled: true });
	
  mapa.forEach((m, idx)=>{
    let exists = state.accesoriosRed.some(r=> (r.Tipo||'').toLowerCase() === m.toLowerCase());
    // for toma desplazada types, if either exists we enable both related rows
    if(m === 'llenado_toma_desplazada' || m === 'retorno_toma_desplazada'){
      exists = tomaExists;
	}
    rows.push({ label: `FOTO ${m.replace(/_/g,' ').toUpperCase()}`, tokens: [ `${m}` , `${m}_1`], required: 1, key: `${m}`, enabled: exists });
  });

  // Zona medidores (enabled if accesoriosRed contains zona_medidores)
  const zonaExists = state.accesoriosRed.some(r=> (r.Tipo||'').toLowerCase() === 'zona_medidores');
  rows.push({ label: `FOTO ZONA MEDIDORES`, tokens: ['zona_medidores','zona_medidor'], required: 1, key: 'zona_medidores', enabled: zonaExists });

  // ACTIVIDADES: for each activity create two rows (antes/despues) grouped visually
  state.actividades.forEach(a=>{
    rows.push({ label: `ACT ${a.id} [${a.contexto}] ${a.titulo} - ANTES`, tokens: [ `${a.id}_before`, `${a.id}__before`, `${a.id}_antes` ], required: 1, key: `${a.id}_before`, activityId: a.id, enabled: true });
    rows.push({ label: `ACT ${a.id} [${a.contexto}] ${a.titulo} - DESPUES`, tokens: [ `${a.id}_after`, `${a.id}__after`, `${a.id}_despues` ], required: 1, key: `${a.id}_after`, activityId: a.id, enabled: true });
  });

  // Punto 11
  rows.push({ label: '11. EVIDENCIA DE LA INSTALACI√ìN', tokens: ['11','11_evidencia','11_evidencia_instalacion'], required: 1, key: '11_evidencia', enabled: true });

  // Build table rows
  rows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    const count = countFilesForTokens(r.tokens);
    const status = count >= r.required ? 'OK' : (count === 0 ? (r.enabled ? 'Sin fotos' : 'No aplica') : `Parcial (${count})`);
    // disable attach if not enabled
    const attachBtn = r.enabled ? `<button class="btn small ghost" onclick="attachPhotosForKey('${r.key}', ${r.required}, ${JSON.stringify(r.tokens).replace(/"/g,'&quot;')})">Adjuntar</button>` : `<button class="btn small ghost disabled-btn" disabled>Adjuntar</button>`;
    const previewBtn = (count>0) ? `<button class="btn warn" onclick="previewPhotosForKey('${r.key}', ${JSON.stringify(r.tokens).replace(/"/g,'&quot;')})">Previsualizar</button>` : `<button class="btn small disabled-btn" disabled>Previsualizar</button>`;
    const removeBtn = (count>0) ? `<button class="btn small danger" onclick="removePhotosForKey('${r.key}', ${JSON.stringify(r.tokens).replace(/"/g,'&quot;')})">Eliminar</button>` : `<button class="btn small danger disabled-btn" disabled>Eliminar</button>`;

    tr.innerHTML = `<td style="vertical-align:middle">${r.label}</td>
      <td style="text-align:center;vertical-align:middle">${r.required}</td>
      <td style="text-align:center;vertical-align:middle">${status}</td>
      <td style="vertical-align:middle">
        ${attachBtn}
        ${previewBtn}
        ${removeBtn}
      </td>`;
    tbody.appendChild(tr);
  });

  // store rows for reference
  window._photoRows = rows;
}

/* Count client-side attached files for tokens */
function countFilesForTokens(tokens){
  let c = 0;
  tokens.forEach(t=>{
    if(state.imagesByToken[t]) c += state.imagesByToken[t].length;
  });
  return c;
}

/* Attach photos: open hidden file input and then store files in state.imagesByToken under token key(s).
   We'll set the filename pattern when appending to FormData (so token included).
   The UI attaches files to the first token in tokens array (common behavior).
*/
function attachPhotosForKey(key, required, tokensJson){
  const tokens = tokensJson;
  // store callback target on hidden input
  const input = document.getElementById('hiddenFileInput');
  input._targetTokens = tokens;
  input._targetKey = key;
  input._requiredCount = required;
  input.value = null;
  input.click();
}

document.getElementById('hiddenFileInput').addEventListener('change', function(ev){
  const files = Array.from(ev.target.files || []);
  const tokens = ev.target._targetTokens || [];
  const key = ev.target._targetKey || (tokens && tokens[0]) || 'misc';
  if(files.length === 0) return;
  // store under first token for simplicity
  const token = tokens[0] || key;
  if(!state.imagesByToken[token]) state.imagesByToken[token] = [];
  // append files (File objects) to state
  files.forEach(f=>{
    state.imagesByToken[token].push(f);
  });
  // Give user feedback and rebuild table
  buildPhotoTable();
});

/* Preview photos for a key (search by tokens) */
function previewPhotosForKey(key, tokensJson){
  const tokens = tokensJson;
  const foundFiles = [];
  tokens.forEach(t=>{
    const arr = state.imagesByToken[t];
    if(arr && arr.length) foundFiles.push(...arr);
  });
  const previewModal = document.getElementById('photoPreviewModal');
  const grid = document.getElementById('previewGrid');
  grid.innerHTML = '';
  if(foundFiles.length === 0){ alert('No hay fotos asociadas a este subt√≠tulo (en el cliente).'); return; }
  foundFiles.forEach(f=>{
    const card = document.createElement('div');
    card.className = 'preview-card';
    const url = URL.createObjectURL(f);
    card.innerHTML = `<img src="${url}" alt="${f.name}"><div style="padding:8px"><strong>${f.name}</strong></div>`;
    grid.appendChild(card);
  });
  previewModal.style.display = 'flex';
}
function closePhotoPreview(){ document.getElementById('photoPreviewModal').style.display = 'none'; }

/* remove photos for key -> clears all tokens provided */
function removePhotosForKey(key, tokensJson){
  const tokens = tokensJson;
  tokens.forEach(t=>{
    if(state.imagesByToken[t]) delete state.imagesByToken[t];
  });
  buildPhotoTable();
}

/* -------------------------
   BUILD PAYLOAD and SUBMIT (multipart/form-data)
   ------------------------- */

function buildPayload(){
  // ensure general saved
  if(!saveGeneral(false)) return null;
  // build tanques array (backend expects keys serie, capacidad, anio, tipo, fabricante, porcentaje)
  const tanques = state.tanques.map(t => ({
    serie: t.serie || '',
    capacidad: t.capacidad || '',
    anio: t.anio || '',
    tipo: t.tipo || '',
    fabricante: t.fabricante || '',
    porcentaje: t.porcentaje || ''
  }));

  // accesoriosTanque: backend expects object keyed by tank index (1-based): { "1": { "V√°lvula de llenado": {Marca, C√≥digo, Serie, Mes/A√±o de fabricaci√≥n}, ... }, ... }
  const accesoriosTanque = {};
  Object.keys(state.accesoriosTanque).forEach(k=>{
    accesoriosTanque[k] = state.accesoriosTanque[k];
  });

  // accesoriosRed is an array accepted as-is
  const accesoriosRed = state.accesoriosRed.map(r => ({ Tipo: r.Tipo, Marca: r.Marca, Serie: r.Serie, C√≥digo: r.C√≥digo, "Mes/A√±o de fabricaci√≥n": r['Mes/A√±o de fabricaci√≥n'] }));

  // equipos: keep as-is but ensure keys friendly; backend expects fields like "Tipo de equipo" or "Equipo" names
  const equipos = state.equipos.map(e => {
    if(!e['Tipo de equipo']) e['Tipo de equipo'] = e['Tipo'] || '';
    return e;
  });

  // observaciones map
  const obs = {
    "7.1": document.getElementById('obs_71').value.trim(),
    "7.2": document.getElementById('obs_72').value.trim(),
    "7.3": document.getElementById('obs_73').value.trim(),
    "7.4": document.getElementById('obs_74').value.trim(),
    "7.5": document.getElementById('obs_75').value.trim()
  };

  // actividades: already have id, contexto, titulo, tiempo, estado ‚Äî ensure format
  const actividades = state.actividades.map(a=>({
    id: a.id,
    contexto: a.contexto,
    titulo: a.titulo,
    tiempo: a.tiempo,
    estado: a.estado
  }));

  const payload = {
    general: state.general,
    tanques: tanques,
    accesoriosTanque: accesoriosTanque,
    accesoriosRed: accesoriosRed,
    equipos: equipos,
    observaciones: obs,
    actividades: actividades
  };

  return payload;
}

/* Final send: create FormData, append 'json' field (stringified payload) and append images.
   For each token in state.imagesByToken, we'll append each File to formData with a filename that includes the token
   Eg: formData.append('images', file, `${token}_${file.name}`)
   The backend save_uploaded_files_tmp doesn't rely on field name but on filenames (it saves every file and later matches by filename).
*/
async function handleGenerate(){
  const payload = buildPayload();
  if(!payload) return;
  // ask for confirmation
  if(!confirm('Generar documento y subir im√°genes (se enviar√° al servidor)?')) return;

  // Build FormData
  const fd = new FormData();
  fd.append('json', JSON.stringify(payload));

  // append files: iterate state.imagesByToken, use token as prefix for filenames
  let appended = 0;
  Object.entries(state.imagesByToken).forEach(([token, files])=>{
    files.forEach((file, idx)=>{
      // choose safe ext from file.name
      const ext = (file.name.split('.').pop() || 'jpg');
      const fname = `${token}_${idx+1}.${ext}`;
      fd.append('images', file, fname); // field name 'images' repeated
      appended++;
    });
  });

  try {
    // show loading UI
    document.getElementById('finalGenerateWithPhotos').innerText = 'Generando...';
    document.getElementById('finalGenerateWithPhotos').disabled = true;

    const res = await fetch('/generar', {
      method: 'POST',
      body: fd
    });

    if(!res.ok){
      const txt = await res.text();
      alert('Error del servidor: ' + res.status + ' ‚Äî ' + txt);
      document.getElementById('finalGenerateWithPhotos').innerText = 'Generar Documento Final ‚Üí';
      document.getElementById('finalGenerateWithPhotos').disabled = false;
      return;
    }

    // receive file blob and download
    const blob = await res.blob();
    const disposition = res.headers.get('Content-Disposition') || '';
    let filename = 'Informe_Mantenimiento.docx';
    const m = /filename="?([^"]+)"?/.exec(disposition);
    if(m) filename = m[1];

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    document.getElementById('finalGenerateWithPhotos').innerText = 'Generar Documento Final ‚Üí';
    document.getElementById('finalGenerateWithPhotos').disabled = false;
    alert('Documento generado y descargado.');
  } catch (err){
    console.error(err);
    alert('Error al generar: ' + err.message);
    document.getElementById('finalGenerateWithPhotos').innerText = 'Generar Documento Final ‚Üí';
    document.getElementById('finalGenerateWithPhotos').disabled = false;
  }
}

/* helper invoked by sidebar generate button */
function handleGenerateSidebar(){
  showStep(6);
  // ensure general saved
  if(!saveGeneral(false)) return;
  showStep(8);
}

/* small helpers */
function updateStatuses(){
  document.getElementById('status-2').innerText = `${state.tanques.length} tanques`;
  document.getElementById('status-3').innerText = Object.keys(state.accesoriosTanque).length ? 'OK' : '‚Äî';
  document.getElementById('status-4').innerText = state.accesoriosRed.length ? state.accesoriosRed.length+' items' : '‚Äî';
  document.getElementById('status-5').innerText = state.equipos.length ? state.equipos.length+' equipos' : '‚Äî';
  document.getElementById('status-6').innerText = state.actividades.length ? state.actividades.length+' actividades' : '‚Äî';
}

/* reset all */
function resetApp(){
  if(!confirm('Reiniciar todo?')) return;
  state = { general:{}, tanques:[], accesoriosTanque:{}, accesoriosRed:[], equipos:[], observaciones:{}, actividades:[], imagesByToken:{} };
  actividadIdCounter = 1;
  document.querySelectorAll('input[type=text], input[type=email], input[type=number], textarea').forEach(i=>i.value='');
  renderTanks(); renderAccList(); renderRedList(); renderEquiposList(); renderActividadesTable(); buildPhotoTable();
  updateStatuses();
  showStep(1);
}

/* attach to some buttons */
document.getElementById('btnGenerate').addEventListener('click', ()=>showStep(6));
document.getElementById('downloadTemplateBtn').addEventListener('click', ()=>{ alert('Descarga de plantilla no implementada en cliente.'); });

/* wire generate final */
document.getElementById('finalGenerateWithPhotos').addEventListener('click', ()=>handleGenerate());

/* initial render */
rebuildTankSelects();
renderTanks();
renderRedList();
renderEquiposList();
renderActividadesTable();
buildPhotoTable();
updateStatuses();

</script>
</body>
</html>









