<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solgas ¬∑ Inspecci√≥n GLP</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#030419; --bg-2:#042133; --accent:#00d2ff; --gold:#f6b73c;
  --card:#071827; --input-bg:#ffffff; --muted:#9fdcff; --input-text-dark:#041018;
  --danger:#ff6b6b; --radius:12px; --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#e6f7ff}
html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased}
.container{max-width:1200px;margin:24px auto;padding:18px;border-radius:14px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:800}
.title{font-size:20px;margin:0}
.lead{color:var(--muted);font-size:13px;margin:0}
#topProgressWrap{position:fixed;left:0;right:0;top:0;height:8px;background:rgba(255,255,255,0.06);z-index:120;border-bottom:1px solid rgba(255,255,255,0.02)}
#topProgress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--gold));transition:width .3s ease}
.app{display:grid;grid-template-columns:320px 1fr;gap:18px;padding-top:12px}
.sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03)}
.userbox{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.user-company{font-weight:700;color:#eafcff}
.navlist{margin-top:8px}
.nav-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .12s}
.nav-item.active{background:linear-gradient(90deg, rgba(0,194,255,0.06), rgba(246,183,60,0.03)); border:1px solid rgba(0,194,255,0.08)}
.status{font-size:13px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted)}
.main{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.02)}
.step{display:none}
.step.active{display:block; animation:fadeIn .26s ease both}
@keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}
.card-title{font-weight:700; color:var(--accent)}
.hint{font-size:13px;color:var(--muted);opacity:.95}
.row{display:grid;gap:10px}
.row.cols-2{grid-template-columns:1fr 1fr}
.field{background:var(--input-bg); border-radius:10px; padding:8px; display:flex; align-items:center; gap:8px; border:1px solid rgba(0,0,0,0.06)}
.field input, .field textarea, .field select{border:none;background:transparent;width:100%;outline:none;color:var(--input-text-dark);font-size:14px}
.label{font-size:12px;color:var(--accent);margin-bottom:6px;font-weight:700}
.small{font-size:12px;color:var(--muted)}
.controls{display:flex;gap:10px;margin-top:12px;align-items:center}
.btn{padding:10px 14px;border-radius:999px;border:none;font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--accent), #6efcff); color:#041018}
.btn.ghost{background:#ffffff;border:1px solid rgba(0,0,0,0.06); color:#041018}
.btn.small{padding:6px 10px;border-radius:8px;font-weight:600}
.list{margin-top:8px}
.tank-card{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.18)); border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,0.02); margin-bottom:10px; display:flex;justify-content:space-between;align-items:center}
.photo-table { width:100%; border-collapse:collapse; margin-top:8px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border-radius:8px; overflow:hidden; }
.photo-table th, .photo-table td { padding:10px 12px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.03); font-size:13px; color: #e6f7ff; }
.photo-table thead th { background: linear-gradient(90deg,var(--accent),var(--gold)); color:#041018; font-weight:700; }
.file-input-hidden { display:none; }
.photo-preview-inline { width:150px; height:100px; object-fit:cover; border:1px solid #cfeef8; border-radius:6px; display:block }
.badge-state { padding:6px 10px; border-radius:999px; font-weight:700; display:inline-block; min-width:64px; text-align:center; }
.badge-red { background: var(--danger); color:#041018; }
.badge-yellow { background: var(--gold); color:#041018; }
.badge-green { background: linear-gradient(90deg,var(--accent), #6efcff); color:#041018; }
.modal-back{position:fixed;inset:0;background:rgba(2,6,10,0.6);display:none;align-items:center;justify-content:center;z-index:60;padding:20px}
.modal-back.active{display:flex}
.modal{background:#ffffff;border-radius:12px;width:980px;max-width:98%;padding:16px;color:#041018;box-shadow:0 18px 50px rgba(2,6,20,0)}
.acc-table{width:100%;border-collapse:collapse;margin-top:8px}
.acc-table th,.acc-table td{border:1px solid #ddd;padding:6px;text-align:center}
.errlist{color:#ff9aa2; margin-top:8px; font-weight:700}
@media (max-width:980px){ .app{grid-template-columns:1fr} .photo-preview-inline{width:120px;height:80px} }
</style>
</head>
<body>
  <div id="topProgressWrap"><div id="topProgress"></div></div>
  <div id="loginOverlay" role="dialog" aria-modal="true">
    <div id="loginCard">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:800">SG</div>
        <div>
          <div class="login-title">Acceso - SOLGAS</div>
          <div class="login-sub">Ingresa con tu correo corporativo y el nombre de empresa.</div>
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="label">Correo corporativo</div>
        <div class="login-field field"><input id="loginEmail" type="email" placeholder="usuario@solgas.com.pe"></div>
        <div class="label" style="margin-top:8px">Empresa</div>
        <div class="login-field field"><input id="loginCompany" type="text" placeholder="Solgas"></div>
        <div class="login-err" id="loginErr" style="display:none"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn ghost" onclick="loginCancel()">Salir</button>
          <button class="btn primary" id="loginBtn" onclick="doLogin()">Ingresar</button>
        </div>
      </div>
    </div>
  </div>

<div class="container" id="mainContainer" style="display:block;margin-top:18px">
  <div class="header">
    <div class="logo">SOLGAS</div>
    <div>
      <div class="title">Solgas ¬∑ Inspecci√≥n GLP</div>
      <div class="lead">Formulario interactivo ‚Äî completa paso a paso y genera el informe Word</div>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
      <button class="btn ghost" id="downloadTemplateBtn">Plantilla</button>
      <button class="btn primary" id="btnGenerate">Generar Word</button>
    </div>
  </div>

  <div id="app" class="app" style="display:block; margin-top:10px">
    <aside class="sidebar">
      <div class="userbox">
        <div id="userInitials" style="width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;color:#041218;font-weight:700">SG</div>
        <div>
          <div id="sidebarCompany" class="user-company">Empresa</div>
          <div id="sidebarEmail" class="small">correo@dominio.com</div>
        </div>
      </div>

      <div style="font-weight:700;color:var(--muted);margin-bottom:8px">Secciones</div>
      <div id="navlist" class="navlist">
        <div class="nav-item active" data-step="1" onclick="navTo(1)"><div>1 ¬∑ Informaci√≥n general</div><div class="status" id="status-1">Obligatorio</div></div>
        <div class="nav-item" data-step="2" onclick="navTo(2)"><div>2 ¬∑ Tanques</div><div class="status" id="status-2">0 tanques</div></div>
        <div class="nav-item" data-step="3" onclick="navTo(3)"><div>3 ¬∑ Accesorios por tanque</div><div class="status" id="status-3">‚Äî</div></div>
        <div class="nav-item" data-step="4" onclick="navTo(4)"><div>4 ¬∑ Accesorios en redes</div><div class="status" id="status-4">‚Äî</div></div>
        <div class="nav-item" data-step="5" onclick="navTo(5)"><div>5 ¬∑ Equipos</div><div class="status" id="status-5">‚Äî</div></div>
        <div class="nav-item" data-step="6" onclick="navTo(6)"><div>6 ¬∑ Observaciones & Actividades</div><div class="status" id="status-6">‚Äî</div></div>
        <div class="nav-item" data-step="7" onclick="navTo(7)"><div>7 ¬∑ Carga de fotos</div><div class="status" id="status-7">‚Äî</div></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn primary" onclick="showStep(7)">üì§ Ir a Fotos</button>
        <button class="btn ghost" onclick="resetApp()">Reiniciar</button>
      </div>

      <div style="margin-top:12px;font-size:13px;color:var(--muted)">Progreso: <span id="progressLabel">0 / 7</span></div>
    </aside>

    <main class="main">
      <!-- STEP 1 -->
      <section id="step-1" class="step active">
        <div class="card-header">
          <div><div class="card-title">1 ¬∑ Informaci√≥n general por instalaci√≥n</div><div class="hint">Completa los 11 campos obligatorios para continuar.</div></div>
          <div><span class="hint">Paso 1 / 7</span></div>
        </div>
        <div class="row cols-3">
          <div><div class="label">Nombre o raz√≥n social del cliente *</div><div class="field"><input id="g_nombre" type="text"></div></div>
          <div><div class="label">Fecha de inspecci√≥n *</div><div class="field"><input id="g_fecha" type="date"></div></div>
          <div><div class="label">Direcci√≥n *</div><div class="field"><input id="g_direccion" type="text"></div></div>
          <div><div class="label">RUC o DNI *</div><div class="field"><input id="g_ruc" type="text"></div></div>
          <div><div class="label">N√∫mero de instalaci√≥n *</div><div class="field"><input id="g_numinst" type="text"></div></div>
          <div><div class="label">Distrito *</div><div class="field"><input id="g_distrito" type="text"></div></div>
          <div><div class="label">Departamento *</div><div class="field"><input id="g_departamento" type="text"></div></div>
          <div><div class="label">Coordenadas *</div><div class="field"><input id="g_coordenadas" type="text" placeholder="lat, lon"></div></div>
          <div><div class="label">Nombre del contacto *</div><div class="field"><input id="g_contacto" type="text"></div></div>
          <div><div class="label">N√∫mero del contacto *</div><div class="field"><input id="g_telefono" type="text"></div></div>
          <div style="grid-column:1/-1"><div class="label">Correo de contacto *</div><div class="field"><input id="g_correo" type="email"></div></div>
        </div>
        <div id="err-step-1" class="errlist"></div>
        <div class="controls" style="margin-top:16px">
          <button class="btn ghost" onclick="saveGeneral(true)">Guardar</button>
          <div style="flex:1"></div>
          <button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button>
        </div>
      </section>

      <!-- STEP 2 -->
      <section id="step-2" class="step">
        <div class="card-header"><div><div class="card-title">2 ¬∑ Tanques inspeccionados</div><div class="hint">Agrega los tanques en el formulario ‚Äî el n√∫mero se asigna autom√°ticamente.</div></div><div><span class="hint">Paso 2 / 7</span></div></div>
        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div style="min-width:160px;"><div class="label">N¬∞ de serie *</div><div class="field"><input id="tank_serie" type="text" placeholder="Serie del tanque"></div></div>
            <div style="min-width:120px;"><div class="label">Capacidad (gal)</div><div class="field"><input id="tank_capacidad" type="text" placeholder="p. ej. 120"></div></div>
            <div style="min-width:120px;"><div class="label">A√±o de fabricaci√≥n</div><div class="field"><input id="tank_anio" type="number" min="1900" max="2099"></div></div>
            <div style="min-width:160px;"><div class="label">Tipo (A√©reo / Soterrado / M√≥vil) *</div><div class="field"><select id="tank_tipo" class="custom-select"><option value="">-- seleccionar --</option><option value="A√©reo">A√©reo</option><option value="Soterrado">Soterrado</option><option value="M√≥vil">M√≥vil</option></select></div></div>
            <div style="min-width:160px;"><div class="label">Fabricante</div><div class="field"><input id="tank_fabricante" type="text"></div></div>
            <div style="min-width:120px;"><div class="label">% Actual</div><div class="field"><input id="tank_porcentaje" type="text"></div></div>
            <div style="margin-left:auto; display:flex; gap:8px"><button id="saveTankBtn" class="btn primary" onclick="saveTank()">Agregar / Guardar</button><button class="btn ghost" onclick="clearTankForm()">Limpiar</button></div>
          </div>
          <div id="err-tank" class="errlist" style="margin-top:8px"></div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px"><button class="btn ghost" onclick="clearTanks()">Limpiar todos los tanques</button><div class="small" style="margin-left:auto">Despu√©s de guardar un tanque puedes editar sus accesorios.</div></div>
        <div id="tanksList" class="list"></div>
        <div id="err-step-2" class="errlist"></div>
        <div class="controls" style="margin-top:16px"><button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button><div style="flex:1"></div><button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button></div>
      </section>

      <!-- STEP 3 -->
      <section id="step-3" class="step">
        <div class="card-header"><div><div class="card-title">3 ¬∑ Accesorios por tanque</div><div class="hint">Selecciona un tanque y llena sus accesorios.</div></div><div><span class="hint">Paso 3 / 7</span></div></div>
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px">
          <div style="min-width:260px"><div class="label">Seleccionar tanque *</div><div class="field"><select id="select_tanque" class="custom-select"><option value="">-- seleccionar tanque --</option></select></div></div>
          <div style="margin-left:auto; display:flex;gap:8px"><button class="btn small ghost" onclick="openAccModalFromStep3()">Editar accesorios</button></div>
        </div>
        <div id="accTankArea">
          <div class="acc-header" id="acc-titulo">Accesorio del tanque ‚Äî</div>
          <div class="small" style="margin-bottom:10px">Rellena Marca / C√≥digo / Serie / Mes/A√±o.</div>
          <div id="acc-list"></div>
          <div style="margin-top:10px"><label style="font-weight:700;color:var(--muted)">Opcionales (activa para a√±adir)</label><div style="display:flex;gap:12px;margin-top:6px">
            <label><input type="checkbox" id="opt_exceso_retorno"> V√°lvula exceso de flujo (Retorno)</label>
            <label><input type="checkbox" id="opt_exceso_bypass"> V√°lvula exceso de flujo (Bypass)</label>
            <label><input type="checkbox" id="opt_val3"> Val 3</label>
          </div></div>
        </div>
        <div id="err-step-3" class="errlist"></div>
        <div class="controls" style="margin-top:16px"><button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button><div style="flex:1"></div><button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button></div>
      </section>

      <!-- STEP 4 -->
      <section id="step-4" class="step">
        <div class="card-header"><div><div class="card-title">4 ¬∑ Accesorios en redes</div><div class="hint">Agrega accesorios en redes.</div></div><div><span class="hint">Paso 4 / 7</span></div></div>
        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div style="min-width:260px;"><div class="label">Tipo de accesorio *</div><div class="field"><select id="red_tipo" class="custom-select"><option value="">-- seleccionar --</option>
              <option value="llenado_toma_desplazada">V√°lvula de llenado de toma desplazada</option>
              <option value="retorno_toma_desplazada">V√°lvula de retorno de toma desplazada</option>
              <option value="alivio_hidrostatico">V√°lvula de alivio hidrost√°tico</option>
              <option value="regulador_primera_etapa">Regulador de primera etapa</option>
              <option value="alivio">V√°lvula de alivio</option>
              <option value="regulador_2da">Regulador de segunda etapa</option>
              <option value="pull_away">V√°lvula Pull Away</option>
              <option value="zona_medidores">Zona de medidores (Tiene / No)</option>
            </select></div></div>
            <div style="min-width:160px;"><div class="label">Marca</div><div class="field"><input id="red_marca" type="text"></div></div>
            <div style="min-width:160px;"><div class="label">Serie</div><div class="field"><input id="red_serie" type="text"></div></div>
            <div style="min-width:160px;"><div class="label">C√≥digo</div><div class="field"><input id="red_codigo" type="text"></div></div>
            <div style="min-width:200px;"><div class="label">Mes/A√±o de fabricaci√≥n</div><div class="field"><input id="red_mesano" type="text" placeholder="MM/YYYY"></div></div>
            <div style="margin-left:auto; display:flex; gap:8px"><button class="btn primary" onclick="addRed()">Agregar</button><button class="btn ghost" onclick="clearRedForm()">Limpiar</button></div>
          </div>
          <div id="zonaMedidoresControls" style="display:none;margin-top:8px">
            <div class="label">Zona de medidores</div>
            <div style="display:flex;gap:12px;align-items:center">
              <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="zona_med" value="true"> Tiene</label>
              <label style="display:flex;align-items:center;gap:6px"><input type="radio" name="zona_med" value="false"> No tiene</label>
            </div>
          </div>
        </div>
        <div><div class="label" style="margin-bottom:6px">Lista de accesorios en redes</div><div id="redList"></div></div>
        <div class="controls" style="margin-top:16px"><button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button><div style="flex:1"></div><button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button></div>
      </section>

      <!-- STEP 5 -->
      <section id="step-5" class="step">
        <div class="card-header"><div><div class="card-title">5 ¬∑ Equipos de la instalaci√≥n</div><div class="hint">Agrega equipos ‚Äî el nombre se genera autom√°ticamente.</div></div><div><span class="hint">Paso 5 / 7</span></div></div>
        <div style="background:var(--light-card-bg); padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(0,0,0,0.04)">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <div style="min-width:220px"><div class="label">Tipo de equipo *</div><div class="field"><select id="eq_tipo" class="custom-select"><option value="">-- seleccionar --</option><option value="vaporizador">Vaporizador</option><option value="quemador">Quemador</option><option value="decantador">Decantador</option><option value="dispensador_de_gas">Dispensador de gas</option><option value="bomba">Bomba</option><option value="tablero">Tablero</option><option value="estabilizador">Estabilizador</option><option value="detector">Detector</option><option value="extintor">Extintor</option></select></div></div>
            <div style="min-width:220px"><div class="label">Equipo (generado)</div><div class="field"><input id="eq_name" type="text" disabled></div></div>
            <div id="dynamicFields" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div>
            <div style="margin-left:auto;display:flex;gap:8px"><button class="btn primary" onclick="addEquipo()">Agregar Equipo</button><button class="btn ghost" onclick="clearEquipoForm()">Limpiar</button></div>
          </div>
        </div>
        <div><div class="label">Lista de equipos</div><div id="equiposList"></div></div>
        <div class="controls" style="margin-top:16px"><button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button><div style="flex:1"></div><button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button></div>
      </section>

      <!-- STEP 6: Observaciones & Actividades -->
      <section id="step-6" class="step">
        <div class="card-header"><div><div class="card-title">6 ¬∑ Observaciones & Actividades</div><div class="hint">Revisa todo y gestiona actividades del punto 10 (antes/despu√©s).</div></div><div><span class="hint">Paso 6 / 7</span></div></div>
        <div>
          <div class="label">7.1 Observaciones al cliente</div><div class="field"><textarea id="obs_71" rows="2" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>
          <div class="label" style="margin-top:8px">7.2 Observaciones en red de llenado y retorno</div><div class="field"><textarea id="obs_72" rows="2" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>
          <div class="label" style="margin-top:8px">7.3 Observaciones en zona de tanque</div><div class="field"><textarea id="obs_73" rows="2" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>
          <div class="label" style="margin-top:8px">7.4 Observaciones en red de consumo</div><div class="field"><textarea id="obs_74" rows="2" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>
          <div class="label" style="margin-top:8px">7.5 Observaciones en equipos varios (separar por punto)</div><div class="field"><textarea id="obs_75" rows="3" style="width:100%;resize:vertical;color:var(--input-text-dark)"></textarea></div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
          <button class="btn primary" onclick="openActivitiesModal()">Gestionar Actividades (Punto 10)</button>
          <div class="small" style="margin-left:12px">Agrega actividades por tanque o por redes; cada actividad tendr√° fotos ANTES/DESPU√âS en el paso 7.</div>
        </div>

        <div id="err-step-6" class="errlist"></div>
        <div class="controls" style="margin-top:16px"><button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button><div style="flex:1"></div><button class="btn primary" onclick="nextStep()">Siguiente ‚Üí</button></div>
      </section>

      <!-- STEP 7: Fotos (tabla din√°mica, integra previews y antes/despu√©s) -->
      <section id="step-7" class="step">
        <div class="card-header"><div><div class="card-title">7 ¬∑ Carga de fotos</div><div class="hint">Sube las fotos solicitadas desde la tabla. Los subt√≠tulos y claves son generados por el servidor.</div></div><div><span class="hint">Paso 7 / 7</span></div></div>
        <div>
          <div class="label" style="margin-top:10px">Lista de fotograf√≠as requeridas</div>
          <div id="photoContainer" style="margin-top:8px"></div>
          <div style="margin-top:12px" class="small-muted">Si no subes una foto para una clave, el informe dejar√° el recuadro vac√≠o / con nota. Para recuadros ‚Äúantes/despu√©s‚Äù sube ambos archivos con las claves indicadas.</div>
        </div>
        <div style="margin-top:14px" id="err-step-7" class="errlist"></div>
        <div class="controls" style="margin-top:16px"><button class="btn ghost" onclick="prevStep()">‚Üê Anterior</button><div style="flex:1"></div><button class="btn primary" id="finalGenerate">Generar Word ‚Üí</button></div>
      </section>
    </main>
  </div>
</div>

<!-- Modales -->
<div id="modalAcc" class="modal-back"><div class="modal" role="dialog" aria-modal="true"><h3 id="modalTitle">Editar accesorios</h3><div id="modalContent"><table class="acc-table" id="modalAccTable"><thead><tr><th>Accesorio</th><th>Marca</th><th>C√≥digo</th><th>Serie</th><th>Mes/A√±o</th></tr></thead><tbody></tbody></table></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button class="btn ghost" onclick="closeAccModal()">Cancelar</button><button class="btn primary" onclick="saveAccModal()">Guardar</button></div></div></div>

<div id="modalActivities" class="modal-back"><div class="modal" role="dialog" aria-modal="true"><h3 id="activitiesTitle">Gestionar Actividades - Punto 10</h3>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
    <div style="min-width:260px"><div class="label">Destino</div><div class="field"><select id="act_dest" class="custom-select"><option value="">-- seleccionar --</option></select></div></div>
    <div style="min-width:360px"><div class="label">Descripci√≥n de la actividad</div><div class="field"><input id="act_desc" type="text" placeholder="Ej: Cambio de v√°lvula, revisi√≥n, soldadura..."></div></div>
    <div style="display:flex;align-items:flex-end;"><button class="btn primary" onclick="addActivity()">Agregar actividad</button></div>
  </div>
  <div><div class="label">Actividades actuales</div><div id="activitiesList" style="max-height:300px;overflow:auto"></div></div>
  <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button class="btn ghost" onclick="closeActivitiesModal()">Cerrar</button></div>
</div></div>

<script>
/* -------------------------
   Allowed emails (client-side)
   ------------------------- */
const allowedEmails = [
  "alexander.buleje@solgas.com.pe","renzo.delgado@solgas.com.pe","ingenieriaeye@hotmail.com",
  "jarmas@inginor.com.pe","Jaime.valdeiglesias16@totalgassac.com","area.mantenimiento@gsgasperu.com",
  "mantenimiento@cmagol.com.pe","aherrera@gypingenieros.com","iserrepe@openersac.com",
  "operacionesglp@northcompany.com.pe","ingenieria1@semmaq.com","administracion@citecservices.com"
];

/* Application state */
let currentStep = 1; const TOTAL_STEPS = 7;
let generalInfo = {}; let tanks = []; let accessoriesByTank = {}; let redes = []; let zona_medidores_val = null;
let equipos = []; let actividades = {}; // dynamic activities structure: { "tank1":[{descripcion}], "red_llenado_retorno":[{descripcion}], ... }
let uploadedPhotos = {}; // clave -> [File,...]
let bloquesFotosCache = [];

const estructuraEquipos = {
  "vaporizador": ["Equipo", "Marca", "Tipo", "Serie", "A√±o de fabricaci√≥n", "Capacidad"],
  "quemador": ["Equipo", "Marca", "Modelo", "Tipo", "Serie", "A√±o de fabricaci√≥n", "Capacidad (kW)"],
  "decantador": ["Equipo", "Fabricante", "Modelo", "Tipo", "Serie", "A√±o de fabricaci√≥n", "Capacidad (gal)"],
  "dispensador_de_gas": ["Equipo", "Marca", "Modelo", "Serie"],
  "bomba": ["Equipo", "Marca", "Modelo", "Serie"],
  "tablero": ["Equipo", "TAG"],
  "estabilizador": ["Equipo", "Marca", "Modelo", "Serie"],
  "detector": ["Equipo", "Marca", "Modelo", "Serie"],
  "extintor": ["Equipo", "Marca", "Serie", "A√±o de fabricaci√≥n", "Pr√≥xima PH", "Fecha de pr√≥xima recarga"]
};
const accesoriosFijos = ["V√°lvula de llenado", "Medidor de porcentaje", "V√°lvula de seguridad", "V√°lvula de drenaje", "Multiv√°lvula"];
const accesoriosOpcionales = ["V√°lvula exceso de flujo (Retorno)","V√°lvula exceso de flujo (Bypass)","Val 3"];

/* Progress UI */
function updateProgressUI(){
  document.getElementById('progressLabel').innerText = `${currentStep} / ${TOTAL_STEPS}`;
  const percent = Math.round(((currentStep-1)/(TOTAL_STEPS-1))*100);
  document.getElementById('topProgress').style.width = percent + '%';
  document.getElementById('status-2').innerText = `${tanks.length} tanques`;
  document.getElementById('status-7').innerText = 'Carga de fotos';
}

/* Navigation */
function showStep(n){
  currentStep = n;
  for(let i=1;i<=TOTAL_STEPS;i++){ const stepEl = document.getElementById(`step-${i}`); if(stepEl) stepEl.classList.remove('active'); const nav = document.querySelector(`.nav-item[data-step="${i}"]`); if(nav) nav.classList.remove('active'); }
  const target = document.getElementById(`step-${n}`);
  if(target){
    target.classList.add('active');
    if(n===7) fetchBloquesFotos();
  }
  const navActive = document.querySelector(`.nav-item[data-step="${n}"]`); if(navActive) navActive.classList.add('active');
  updateProgressUI();
}
function nextStep(){ if(!validateStep(currentStep)) return; if(currentStep < TOTAL_STEPS) showStep(currentStep+1); }
function prevStep(){ if(currentStep>1) showStep(currentStep-1); }
function navTo(n){
  if(n>currentStep){ if(!validateStep(currentStep)) return; for(let i=1;i<n;i++){ if(!validateStep(i)){ alert('Complete pasos previos antes de avanzar.'); return; } } }
  showStep(n);
}

/* Login */
function doLogin(){
  const email = (document.getElementById('loginEmail').value||'').trim().toLowerCase();
  const company = (document.getElementById('loginCompany').value||'').trim();
  const err = document.getElementById('loginErr');
  if(!email || !company){ err.style.display='block'; err.innerText='Correo y Empresa son obligatorios.'; return; }
  if(!allowedEmails.includes(email)){ err.style.display='block'; err.innerText='Correo no autorizado.'; return; }
  document.getElementById('loginOverlay').remove();
  document.getElementById('sidebarCompany').innerText = company;
  document.getElementById('sidebarEmail').innerText = email;
  document.getElementById('userInitials').innerText = company.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
  updateProgressUI();
}
function loginCancel(){ alert('Salida de la aplicaci√≥n.'); document.getElementById('loginOverlay').style.display='none'; document.body.innerHTML = '<div style="padding:40px;font-family:Arial;">Acceso cancelado.</div>'; }

/* STEP 1 */
function saveGeneral(showMsg=false){
  const required = ["g_nombre","g_fecha","g_direccion","g_ruc","g_numinst","g_distrito","g_departamento","g_coordenadas","g_contacto","g_telefono","g_correo"];
  const missing = required.filter(id=>{ const el = document.getElementById(id); return !el || !String(el.value||'').trim(); });
  if(missing.length){ document.getElementById('err-step-1').innerText = 'Faltan campos obligatorios en Informaci√≥n general.'; return false; }
  document.getElementById('err-step-1').innerText = '';
  generalInfo = {
    "Nombre o raz√≥n social del cliente": document.getElementById('g_nombre').value.trim(),
    "Fecha de inspecci√≥n": document.getElementById('g_fecha').value,
    "Direcci√≥n": document.getElementById('g_direccion').value.trim(),
    "RUC o DNI": document.getElementById('g_ruc').value.trim(),
    "N√∫mero de instalaci√≥n": document.getElementById('g_numinst').value.trim(),
    "Distrito": document.getElementById('g_distrito').value.trim(),
    "Departamento": document.getElementById('g_departamento').value.trim(),
    "Coordenadas": document.getElementById('g_coordenadas').value.trim(),
    "Nombre del contacto": document.getElementById('g_contacto').value.trim(),
    "N√∫mero del contacto": document.getElementById('g_telefono').value.trim(),
    "Correo de contacto": document.getElementById('g_correo').value.trim()
  };
  if(showMsg) alert('Informaci√≥n general guardada.');
  return true;
}

/* Validation for steps */
function validateStep(step){
  if(step===1) return saveGeneral(false);
  if(step===2){ if(tanks.length===0){ document.getElementById('err-step-2').innerText='Debes agregar al menos un tanque.'; return false; } document.getElementById('err-step-2').innerText=''; return true; }
  if(step===3){ for(const [tk,obj] of Object.entries(accessoriesByTank)){ for(const [accName,fields] of Object.entries(obj)){ const anyFilled = (fields["Marca"]||'').trim()||(fields["C√≥digo"]||'').trim()||(fields["Serie"]||'').trim()||(fields["Mes/A√±o de fabricaci√≥n"]||'').trim(); if(anyFilled){ const missing = ["Marca","C√≥digo","Serie","Mes/A√±o de fabricaci√≥n"].filter(k=>!String(fields[k]||'').trim()); if(missing.length){ document.getElementById('err-step-3').innerText = `En el tanque ${tk} el accesorio "${accName}" no est√° completo: faltan ${missing.join(', ')}`; return false; } } } } document.getElementById('err-step-3').innerText=''; return true; }
  if(step===5){ /* equipos validation handled on add */ return true; }
  return true;
}

/* STEP 2 Tanks */
function clearTankForm(){ ['tank_serie','tank_capacidad','tank_anio','tank_tipo','tank_fabricante','tank_porcentaje'].forEach(id=>document.getElementById(id).value=''); document.getElementById('err-tank').innerText=''; }
function saveTank(){
  const serie = (document.getElementById('tank_serie').value||'').trim();
  const tipo = document.getElementById('tank_tipo').value;
  if(!serie || !tipo){ document.getElementById('err-tank').innerText='N¬∞ de serie y Tipo son obligatorios.'; return; }
  const tank = { serie, capacidad: document.getElementById('tank_capacidad').value.trim(), anio: document.getElementById('tank_anio').value.trim(), tipo, fabricante: document.getElementById('tank_fabricante').value.trim(), porcentaje: document.getElementById('tank_porcentaje').value.trim() };
  tanks.push(tank);
  const idx = String(tanks.length);
  if(!accessoriesByTank[idx]){ accessoriesByTank[idx]={}; accesoriosFijos.forEach(name=>{ accessoriesByTank[idx][name] = {"Marca":"","C√≥digo":"","Serie":"","Mes/A√±o de fabricaci√≥n":""}; }); }
  renderTanks(); clearTankForm(); updateTankSelectOptions(); updateProgressUI();
}
function renderTanks(){ const container = document.getElementById('tanksList'); container.innerHTML=''; tanks.forEach((t,i)=>{ const idx=i+1; const card=document.createElement('div'); card.className='tank-card'; const info=document.createElement('div'); info.className='tank-info'; info.style.display='grid'; info.style.gridTemplateColumns='repeat(5,1fr)'; info.innerHTML = `<div><strong style="color:#fff">#${idx}</strong></div><div><div class="small">Serie</div><div style="color:#fff">${t.serie||'-'}</div></div><div><div class="small">Capacidad</div><div style="color:#fff">${t.capacidad||'-'}</div></div><div><div class="small">Tipo</div><div style="color:#fff">${t.tipo||'-'}</div></div><div><div class="small">% Actual</div><div style="color:#fff">${t.porcentaje||'-'}</div></div>`; const actions=document.createElement('div'); actions.className='tank-actions'; actions.innerHTML = `<div class="inline-actions"><button class="btn small ghost" onclick="editTank(${i})">Editar</button><button class="btn small warn" onclick="openAccForTank(${i})">Accesorios</button><button class="btn small danger" onclick="deleteTank(${i})">Borrar</button></div>`; card.appendChild(info); card.appendChild(actions); container.appendChild(card); }); }
function editTank(index){ const t=tanks[index]; if(!t) return; document.getElementById('tank_serie').value=t.serie; document.getElementById('tank_capacidad').value=t.capacidad; document.getElementById('tank_anio').value=t.anio; document.getElementById('tank_tipo').value=t.tipo; document.getElementById('tank_fabricante').value=t.fabricante; document.getElementById('tank_porcentaje').value=t.porcentaje; tanks.splice(index,1); rebuildAccessoriesAfterTankDeletion(); renderTanks(); updateTankSelectOptions(); }
function deleteTank(index){ if(!confirm('¬øEliminar este tanque?')) return; tanks.splice(index,1); rebuildAccessoriesAfterTankDeletion(); renderTanks(); updateTankSelectOptions(); updateProgressUI(); }
function rebuildAccessoriesAfterTankDeletion(){ const newMap={}; tanks.forEach((t,i)=>{ const key=String(i+1); newMap[key]=accessoriesByTank[key]||{}; accesoriosFijos.forEach(name=>{ if(!newMap[key][name]) newMap[key][name] = {"Marca":"","C√≥digo":"","Serie":"","Mes/A√±o de fabricaci√≥n":""}; }); }); accessoriesByTank=newMap; }

/* Tank select */
function updateTankSelectOptions(){ const sel=document.getElementById('select_tanque'); sel.innerHTML='<option value="">-- seleccionar tanque --</option>'; tanks.forEach((t,i)=>{ const opt=document.createElement('option'); opt.value=String(i+1); opt.textContent = `${i+1} ¬∑ Serie: ${t.serie||'-'}`; sel.appendChild(opt); }); document.getElementById('status-2').innerText = `${tanks.length} tanques`; }

/* STEP 3 Accessories (modal) */
document.getElementById('select_tanque').addEventListener('change', function(){ updateAccArea(this.value); });
function updateAccArea(tankIndex){ const titulo=document.getElementById('acc-titulo'); if(!tankIndex){ titulo.innerText='Accesorio del tanque ‚Äî'; document.getElementById('acc-list').innerHTML='<div class="small">Selecciona un tanque para ver/editar sus accesorios.</div>'; return; } const t=tanks[Number(tankIndex)-1]; titulo.textContent = `Accesorio del tanque ${tankIndex} de serie : ${t? t.serie: '-'}`; document.getElementById('acc-titulo').style.background='#f3f3f3'; document.getElementById('acc-titulo').style.color='#041018'; if(!accessoriesByTank[tankIndex]){ accessoriesByTank[tankIndex]={}; accesoriosFijos.forEach(name=>{ accessoriesByTank[tankIndex][name] = {"Marca":"","C√≥digo":"","Serie":"","Mes/A√±o de fabricaci√≥n":""}; }); } renderAccList(tankIndex); accesoriosOpcionales.forEach((name,i)=>{ const elId = (i===0?'opt_exceso_retorno': i===1? 'opt_exceso_bypass':'opt_val3'); const exists = !!accessoriesByTank[tankIndex][name]; document.getElementById(elId).checked = !!exists; }); }
function renderAccList(tankIndex){ const cont=document.getElementById('acc-list'); cont.innerHTML=''; const accMap=accessoriesByTank[tankIndex] || {}; const table=document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse'; table.innerHTML=`<thead style="background:#f3f3f3;color:#041018"><tr><th style="padding:8px;text-align:left">Accesorio</th><th style="padding:8px">Marca</th><th style="padding:8px">C√≥digo</th><th style="padding:8px">Serie</th><th style="padding:8px">Mes/A√±o</th></tr></thead>`; const tbody=document.createElement('tbody'); for(const accName of Object.keys(accMap)){ const fields=accMap[accName]; const tr=document.createElement('tr'); tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #eee">${accName}</td><td style="padding:8px;border-bottom:1px solid #eee"><input data-acc="${accName}" data-tank="${tankIndex}" data-field="Marca" value="${fields["Marca"]||''}" style="width:100%"></td><td style="padding:8px;border-bottom:1px solid #eee"><input data-acc="${accName}" data-tank="${tankIndex}" data-field="C√≥digo" value="${fields["C√≥digo"]||''}" style="width:100%"></td><td style="padding:8px;border-bottom:1px solid #eee"><input data-acc="${accName}" data-tank="${tankIndex}" data-field="Serie" value="${fields["Serie"]||''}" style="width:100%"></td><td style="padding:8px;border-bottom:1px solid #eee"><input data-acc="${accName}" data-tank="${tankIndex}" data-field="Mes/A√±o de fabricaci√≥n" value="${fields["Mes/A√±o de fabricaci√≥n"]||''}" style="width:100%"></td>`; tbody.appendChild(tr); } table.appendChild(tbody); cont.appendChild(table); cont.querySelectorAll('input[data-acc]').forEach(inp=>{ inp.addEventListener('input', function(){ const t=this.getAttribute('data-tank'); const acc=this.getAttribute('data-acc'); const field=this.getAttribute('data-field'); if(!accessoriesByTank[t]) accessoriesByTank[t]={}; if(!accessoriesByTank[t][acc]) accessoriesByTank[t][acc]={"Marca":"","C√≥digo":"","Serie":"","Mes/A√±o de fabricaci√≥n":""}; accessoriesByTank[t][acc][field]=this.value; }); }); }
document.getElementById('opt_exceso_retorno').addEventListener('change', function(){ toggleOptionalAccessory(this.checked, "V√°lvula exceso de flujo (Retorno)"); });
document.getElementById('opt_exceso_bypass').addEventListener('change', function(){ toggleOptionalAccessory(this.checked, "V√°lvula exceso de flujo (Bypass)"); });
document.getElementById('opt_val3').addEventListener('change', function(){ toggleOptionalAccessory(this.checked, "Val 3"); });
function toggleOptionalAccessory(enabled,name){ const sel=document.getElementById('select_tanque'); const tankIndex=sel.value; if(!tankIndex){ alert('Seleccione primero un tanque.'); if(name.includes('Retorno')) document.getElementById('opt_exceso_retorno').checked=false; if(name.includes('Bypass')) document.getElementById('opt_exceso_bypass').checked=false; if(name.includes('Val 3')) document.getElementById('opt_val3').checked=false; return; } if(!accessoriesByTank[tankIndex]) accessoriesByTank[tankIndex]={}; if(enabled){ accessoriesByTank[tankIndex][name]={"Marca":"","C√≥digo":"","Serie":"","Mes/A√±o de fabricaci√≥n":""}; } else { delete accessoriesByTank[tankIndex][name]; } renderAccList(tankIndex); }
function openAccModalFromStep3(){ const sel=document.getElementById('select_tanque'); const t=sel.value||''; if(!t){ alert('Seleccione un tanque para editar sus accesorios.'); return; } openModalForTank(t); }
function openAccForTank(index){ const idx = index+1; const sel=document.getElementById('select_tanque'); sel.value=String(idx); updateAccArea(String(idx)); openModalForTank(String(idx)); }
function openModalForTank(tankIndex){ const modal=document.getElementById('modalAcc'); const t=tanks[Number(tankIndex)-1]; modal.classList.add('active'); document.getElementById('modalTitle').innerText = `Editar accesorios de tanque ${tankIndex} de serie : ${t? t.serie:'-'}`; const tbody=document.querySelector('#modalAccTable tbody'); tbody.innerHTML=''; const accMap=accessoriesByTank[tankIndex]||{}; const keys=[...Object.keys(accMap)]; keys.forEach(name=>{ const fields=accMap[name]; const tr=document.createElement('tr'); tr.innerHTML = `<td class="accesorio" style="padding:6px">${name}</td><td style="padding:6px"><input data-modal-acc="${name}" style="color:var(--accent)" data-modal-field="Marca" value="${fields["Marca"]||''}"></td><td style="padding:6px"><input data-modal-acc="${name}" style="color:var(--accent)" data-modal-field="C√≥digo" value="${fields["C√≥digo"]||''}"></td><td style="padding:6px"><input data-modal-acc="${name}" style="color:var(--accent)" data-modal-field="Serie" value="${fields["Serie"]||''}"></td><td style="padding:6px"><input data-modal-acc="${name}" style="color:var(--accent)" data-modal-field="Mes/A√±o de fabricaci√≥n" value="${fields["Mes/A√±o de fabricaci√≥n"]||''}"></td>`; tbody.appendChild(tr); }); }
function closeAccModal(){ document.getElementById('modalAcc').classList.remove('active'); }
function saveAccModal(){ const sel=document.getElementById('select_tanque'); const t=sel.value||''; if(!t){ closeAccModal(); return; } const inputs=document.querySelectorAll('#modalAccTable input[data-modal-acc]'); inputs.forEach(inp=>{ const acc=inp.getAttribute('data-modal-acc'); const field=inp.getAttribute('data-modal-field'); if(!accessoriesByTank[t]) accessoriesByTank[t]={}; if(!accessoriesByTank[t][acc]) accessoriesByTank[t][acc]={"Marca":"","C√≥digo":"","Serie":"","Mes/A√±o de fabricaci√≥n":""}; accessoriesByTank[t][acc][field]=inp.value; }); renderAccList(t); closeAccModal(); }

/* STEP 4 redes */
function clearRedForm(){ ['red_tipo','red_marca','red_serie','red_codigo','red_mesano'].forEach(id=>document.getElementById(id).value=''); document.querySelectorAll('input[name="zona_med"]').forEach(r=>r.checked=false); document.getElementById('zonaMedidoresControls').style.display='none'; }
document.getElementById('red_tipo').addEventListener('change', function(){ const v=this.value; if(v==='zona_medidores') document.getElementById('zonaMedidoresControls').style.display='block'; else document.getElementById('zonaMedidoresControls').style.display='none'; });
function addRed(){ const tipo=document.getElementById('red_tipo').value; if(!tipo){ alert('Selecciona tipo de accesorio'); return; } if(tipo==='zona_medidores'){ const sel=document.querySelector('input[name="zona_med"]:checked'); if(!sel){ alert('Selecciona Tiene / No tiene para zona de medidores'); return; } zona_medidores_val = sel.value === 'true'; redes = redes.filter(r=> r.Tipo !== 'zona_medidores'); redes.push({"Tipo":"zona_medidores","Marca":"","Serie":"","C√≥digo": zona_medidores_val ? "True" : "False","Mes/A√±o de fabricaci√≥n":""}); renderRedList(); clearRedForm(); return; } const obj={"Tipo":tipo,"Marca":document.getElementById('red_marca').value.trim()||"","Serie":document.getElementById('red_serie').value.trim()||"","C√≥digo":document.getElementById('red_codigo').value.trim()||"","Mes/A√±o de fabricaci√≥n":document.getElementById('red_mesano').value.trim()||""}; redes.push(obj); renderRedList(); clearRedForm(); }
function renderRedList(){ const c=document.getElementById('redList'); c.innerHTML=''; if(redes.length===0){ c.innerHTML='<div class="small">No hay accesorios en redes agregados.</div>'; return; } redes.forEach((r,i)=>{ const div=document.createElement('div'); div.className='tank-card'; div.style.display='flex'; div.style.justifyContent='space-between'; const left=document.createElement('div'); left.innerHTML = `<div style="font-weight:700;color:#fff">${i+1}. ${humanReadableTipo(r.Tipo)}</div><div style="color:#dff9ff;margin-top:6px">${(r.Marca||'-')} ‚Äî ${(r.Serie||'-')} ‚Äî ${(r.C√≥digo||'-')}</div>`; const right=document.createElement('div'); right.innerHTML = `<div style="display:flex;gap:8px"><button class="btn small ghost" onclick="editRed(${i})">Editar</button><button class="btn small danger" onclick="deleteRed(${i})">Borrar</button></div>`; div.appendChild(left); div.appendChild(right); c.appendChild(div); }); }
function humanReadableTipo(tipo){ const map = {"llenado_toma_desplazada":"V√°lvula de llenado de toma desplazada","retorno_toma_desplazada":"V√°lvula de retorno toma desplazada","alivio_hidrostatico":"V√°lvula de alivio hidrost√°tico","regulador_primera_etapa":"Regulador primera etapa","alivio":"V√°lvula de alivio","regulador_2da":"Regulador segunda etapa","pull_away":"V√°lvula Pull Away","zona_medidores":"Zona de medidores"}; return map[tipo]||tipo; }
function editRed(i){ const r=redes[i]; if(!r) return; document.getElementById('red_tipo').value=r.Tipo; document.getElementById('red_marca').value=r.Marca||''; document.getElementById('red_serie').value=r.Serie||''; document.getElementById('red_codigo').value=r.C√≥digo||''; document.getElementById('red_mesano').value=r["Mes/A√±o de fabricaci√≥n"]||''; redes.splice(i,1); renderRedList(); }
function deleteRed(i){ if(!confirm('Eliminar accesorio en red?')) return; redes.splice(i,1); renderRedList(); }

/* STEP 5 equipos */
document.getElementById('eq_tipo').addEventListener('change', function(){ const tipo=this.value; const nameInput=document.getElementById('eq_name'); const countForType = equipos.filter(e=>e["Tipo de equipo"]===tipo).length; const nextIdx=countForType+1; if(tipo){ const pretty=tipo.replace(/_/g,' '); const capital = pretty.charAt(0).toUpperCase()+pretty.slice(1); nameInput.value = `${capital}${nextIdx}`; } else nameInput.value=''; renderDynamicFields(tipo); });
function renderDynamicFields(tipo){ const container=document.getElementById('dynamicFields'); container.innerHTML=''; if(!tipo) return; const cols = estructuraEquipos[tipo]||[]; cols.forEach(col=>{ if(col==='Equipo') return; const wrap=document.createElement('div'); wrap.style.minWidth='160px'; const safeId='dyn_'+col.replace(/\s/g,'_').replace(/[()]/g,''); wrap.innerHTML = `<div class="label" style="font-size:12px">${col}</div><div class="field"><input id="${safeId}" type="text"></div>`; container.appendChild(wrap); }); }
function addEquipo(){ const tipo=document.getElementById('eq_tipo').value; if(!tipo){ alert('Selecciona tipo de equipo'); return; } const cols=estructuraEquipos[tipo]; if(!cols){ alert('Tipo de equipo inv√°lido'); return; } const eq={"Tipo de equipo": tipo}; const nombre=document.getElementById('eq_name').value||''; eq["Equipo"]=nombre; cols.forEach(col=>{ if(col==='Equipo') return; const id='dyn_'+col.replace(/\s/g,'_').replace(/[()]/g,''); const el=document.getElementById(id); eq[col] = el? el.value.trim():''; }); const missing = cols.filter(c=>!String(eq[c]||'').trim()); if(missing.length){ alert(`Faltan campos en equipo: ${missing.join(', ')}`); return; } equipos.push(eq); document.getElementById('eq_tipo').value=''; document.getElementById('eq_name').value=''; document.getElementById('dynamicFields').innerHTML=''; renderEquiposList(); }
function renderEquiposList(){ const c=document.getElementById('equiposList'); c.innerHTML=''; if(equipos.length===0){ c.innerHTML='<div class="small">No hay equipos agregados.</div>'; return; } equipos.forEach((eq,i)=>{ const div=document.createElement('div'); div.className='tank-card'; div.style.display='flex'; div.style.justifyContent='space-between'; const left=document.createElement('div'); left.innerHTML = `<div style="font-weight:700;color:#fff">${i+1}. ${eq["Equipo"]||'-'}</div><div style="color:#dff9ff;margin-top:6px">Tipo: ${eq["Tipo de equipo"]}</div>`; const keys = Object.keys(eq).filter(k=>k!=='Equipo'&&k!=='Tipo de equipo'); if(keys.length){ left.innerHTML += `<div style="color:#dff9ff;margin-top:6px">${keys.map(k=>`${k}: ${(eq[k]||'-')}`).join(' ‚Äî ')}</div>`; } const right=document.createElement('div'); right.innerHTML = `<div style="display:flex;gap:8px"><button class="btn small ghost" onclick="editEquipo(${i})">Editar</button><button class="btn small danger" onclick="deleteEquipo(${i})">Borrar</button></div>`; div.appendChild(left); div.appendChild(right); c.appendChild(div); }); }
function editEquipo(i){ const eq=equipos[i]; if(!eq) return; document.getElementById('eq_tipo').value = eq["Tipo de equipo"]; document.getElementById('eq_name').value = eq["Equipo"]; renderDynamicFields(eq["Tipo de equipo"]); const cols = estructuraEquipos[eq["Tipo de equipo"]]; cols.forEach(col=>{ if(col==='Equipo') return; const id='dyn_'+col.replace(/\s/g,'_').replace(/[()]/g,''); const el=document.getElementById(id); if(el) el.value = eq[col]||''; }); equipos.splice(i,1); renderEquiposList(); }
function deleteEquipo(i){ if(!confirm('Eliminar equipo?')) return; equipos.splice(i,1); renderEquiposList(); }

/* Actividades modal */
function openActivitiesModal(){ const modal=document.getElementById('modalActivities'); modal.classList.add('active'); populateActivitiesDestinations(); renderActivitiesList(); }
function closeActivitiesModal(){ document.getElementById('modalActivities').classList.remove('active'); }
function populateActivitiesDestinations(){ const sel=document.getElementById('act_dest'); sel.innerHTML=''; const defaultOpt=document.createElement('option'); defaultOpt.value=''; defaultOpt.textContent='-- seleccionar --'; sel.appendChild(defaultOpt); tanks.forEach((t,i)=>{ const opt=document.createElement('option'); opt.value=`tank${i+1}`; opt.textContent=`Tanque ${i+1} ¬∑ Serie: ${t.serie||'-'}`; sel.appendChild(opt); }); const opt1=document.createElement('option'); opt1.value='red_llenado_retorno'; opt1.textContent='Redes - Llenado/Retorno'; sel.appendChild(opt1); const opt2=document.createElement('option'); opt2.value='red_consumo'; opt2.textContent='Redes - Consumo'; sel.appendChild(opt2); }
function addActivity(){ const dest=document.getElementById('act_dest').value; const desc=(document.getElementById('act_desc').value||'').trim(); if(!dest||!desc){ alert('Selecciona destino y describe la actividad'); return; } actividades[dest]=actividades[dest]||[]; actividades[dest].push({descripcion:desc}); document.getElementById('act_desc').value=''; renderActivitiesList(); }
function renderActivitiesList(){ const c=document.getElementById('activitiesList'); c.innerHTML=''; const keys=Object.keys(actividades); if(keys.length===0){ c.innerHTML='<div class="small">No hay actividades registradas.</div>'; return; } keys.forEach(k=>{ const div=document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid #eee'; const title=document.createElement('div'); title.style.fontWeight='700'; title.style.color='#041018'; title.textContent = k; div.appendChild(title); actividades[k].forEach((a,i)=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.marginTop='6px'; row.innerHTML = `<div>${i+1}. ${a.descripcion}</div><div><button class="btn small ghost" onclick="removeActivity('${k}',${i})">Borrar</button></div>`; div.appendChild(row); }); c.appendChild(div); }); }
function removeActivity(dest,index){ if(!confirm('Eliminar actividad?')) return; actividades[dest].splice(index,1); if(actividades[dest].length===0) delete actividades[dest]; renderActivitiesList(); }

/* BUILD PAYLOAD */
function buildPayload(){
  if(!saveGeneral(false)){ showStep(1); throw 'General incomplete'; }
  if(tanks.length===0){ showStep(2); throw 'Se requiere al menos un tanque'; }
  const tanquesArr = tanks.map(t=>({ serie: t.serie||'', capacidad: t.capacidad||'', anio: t.anio||'', tipo: t.tipo||'', fabricante: t.fabricante||'', porcentaje: t.porcentaje||'' }));
  const accByTankPayload = {}; Object.keys(accessoriesByTank).forEach(k=>{ const accs = accessoriesByTank[k]; const out={}; Object.keys(accs).forEach(name=>{ const fields = accs[name]; const any = Object.values(fields).some(v=>String(v||'').trim() !== ''); if(any){ out[name] = {"Marca": fields["Marca"]||'',"C√≥digo": fields["C√≥digo"]||'',"Serie": fields["Serie"]||'',"Mes/A√±o de fabricaci√≥n": fields["Mes/A√±o de fabricaci√≥n"]||''}; } }); if(Object.keys(out).length) accByTankPayload[k]=out; });
  const redPayload = redes.map(r=>({ "Tipo": r.Tipo||'',"Marca": r.Marca||'',"Serie": r.Serie||'',"C√≥digo": r.C√≥digo||'',"Mes/A√±o de fabricaci√≥n": r["Mes/A√±o de fabricaci√≥n"]||'' }));
  const equiposPayload = equipos.map(eq=>Object.assign({}, eq));
  const observaciones = { "7.1": document.getElementById('obs_71').value.trim(), "7.2": document.getElementById('obs_72').value.trim(), "7.3": document.getElementById('obs_73').value.trim(), "7.4": document.getElementById('obs_74').value.trim(), "7.5": document.getElementById('obs_75').value.trim() };
  const payload = { general: generalInfo, tanques: tanquesArr, accesoriosTanque: accByTankPayload, accesoriosRed: redPayload, equipos: equiposPayload, observaciones: observaciones, actividades: actividades };
  return payload;
}

/* -------------------------
   STEP 7: Fetch bloques from server and build table
   ------------------------- */
async function fetchBloquesFotos(){
  document.getElementById('err-step-7').innerText = '';
  try {
    const payload = { general: generalInfo, tanques: tanks, accesoriosTanque: accessoriesByTank, redes: redes, equipos: equipos, actividades: actividades };
    const res = await fetch('/bloques_fotos', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error('Error al solicitar bloques de fotos');
    const data = await res.json();
    bloquesFotosCache = (data||[]).sort((a,b)=> (a.order||0)-(b.order||0));
    buildPhotoTable();
  } catch(err){ console.error(err); document.getElementById('err-step-7').innerText = 'No fue posible obtener la lista de fotos desde el servidor.'; buildPhotoFieldsFallback(); }
}

/* Fallback: local generation if server fails (still keep same keys) */
function buildPhotoFieldsFallback(){
  const container = document.getElementById('photoContainer'); container.innerHTML = '<div class="small-muted">No se pudo conectar al servidor; se generaron subt√≠tulos localmente.</div>';
  // we still want to show user something; but server is preferred.
}

/* Build photo table UI */
function buildPhotoTable(){
  const container = document.getElementById('photoContainer'); container.innerHTML = '';
  if(!bloquesFotosCache || !bloquesFotosCache.length){ container.innerHTML = '<div class="small-muted">No hay bloques fotogr√°ficos definidos.</div>'; return; }
  const table = document.createElement('table'); table.className='photo-table';
  const thead = document.createElement('thead'); thead.innerHTML = `<tr><th>Subt√≠tulo</th><th style="width:120px">N¬∞ Fotos</th><th style="width:150px">Estado</th><th style="width:320px">Acci√≥n</th></tr>`; table.appendChild(thead);
  const tbody = document.createElement('tbody');
  bloquesFotosCache.forEach(block=>{
    const tr=document.createElement('tr'); if(!block.aplica) tr.classList.add('disabled');
    const tdTitle=document.createElement('td'); const titleDiv=document.createElement('div'); titleDiv.className='photo-row-title'; titleDiv.innerText = block.titulo; tdTitle.appendChild(titleDiv);
    const tdCount=document.createElement('td'); tdCount.innerHTML = `<div class="photo-count">${block.fotos} foto(s)</div>`;
    const tdStatus=document.createElement('td'); const badge=document.createElement('span'); badge.className='badge-state badge-red'; badge.innerText='Sin subir'; tdStatus.appendChild(badge);
    const tdAction=document.createElement('td'); tdAction.className='photo-action';
    // file input hidden
    const input=document.createElement('input'); input.type='file'; input.accept='image/*'; if(block.fotos && block.fotos>1) input.multiple=true; input.className='file-input-hidden'; input.dataset.clave = block.clave;
    // preview container
    const previewWrap = document.createElement('div'); previewWrap.style.display='flex'; previewWrap.style.gap='8px'; previewWrap.style.alignItems='center';
    // visible upload button
    const btn = document.createElement('button'); btn.className='btn small primary'; btn.type='button'; btn.innerText = block.aplica ? (block.fotos > 1 ? 'Subir fotos' : 'Subir foto') : 'No aplica'; btn.disabled = !block.aplica;
    btn.addEventListener('click', ()=>{ if(!block.aplica) return; input.click(); });
    // view button
    const btnView=document.createElement('button'); btnView.className='btn small ghost'; btnView.type='button'; btnView.innerText='Ver'; btnView.disabled=true; btnView.addEventListener('click', ()=>{ const files = uploadedPhotos[block.clave]||[]; if(!files.length){ alert('No hay im√°genes para ver.'); return; } files.forEach(f=>{ const url=URL.createObjectURL(f); window.open(url); }); });
    // append elements
    tdAction.appendChild(input); tdAction.appendChild(btn); tdAction.appendChild(btnView); tdAction.appendChild(previewWrap);
    tr.appendChild(tdTitle); tr.appendChild(tdCount); tr.appendChild(tdStatus); tr.appendChild(tdAction);
    tr.dataset.clave = block.clave;
    tbody.appendChild(tr);

    // handle input change to store files and create previews
    input.addEventListener('change', (ev)=>{
      const files = Array.from(ev.target.files||[]);
      if(files.length===0) return;
      if(block.fotos && files.length > block.fotos){ alert(`Se permiten m√°ximo ${block.fotos} fotos para este subt√≠tulo.`); return; }
      uploadedPhotos[block.clave] = files;
      // show small previews in previewWrap (scaled to 150x100 px to approximate 15x10 cm at doc)
      previewWrap.innerHTML = '';
      files.forEach(f=>{
        const img = document.createElement('img'); img.className='photo-preview-inline'; img.src = URL.createObjectURL(f); img.onload = ()=>{ URL.revokeObjectURL(img.src); };
        previewWrap.appendChild(img);
      });
      updatePhotoRowStatus(block.clave, tr, badge, block.fotos, btnView);
    });

    updatePhotoRowStatus(block.clave, tr, badge, block.fotos, btnView);
  });
  table.appendChild(tbody); container.appendChild(table);
}

/* Update badge & view button */
function updatePhotoRowStatus(clave, trElem, badgeElem, fotosNecesarias, btnViewElem){
  const files = uploadedPhotos[clave]||[]; const n = files.length; const badge = badgeElem; const btnView = btnViewElem || trElem.querySelector('button.ghost');
  if(n===0){ badge.className='badge-state badge-red'; badge.innerText='Sin subir'; if(btnView) btnView.disabled=true; }
  else if(fotosNecesarias && n < fotosNecesarias){ badge.className='badge-state badge-yellow'; badge.innerText=`${n}/${fotosNecesarias}`; if(btnView) btnView.disabled=false; }
  else { badge.className='badge-state badge-green'; badge.innerText = fotosNecesarias? `${n}/${fotosNecesarias}` : `${n}`; if(btnView) btnView.disabled=false; }
}

/* Final generation: send payload + files to /generate_docx */
async function generateWordWithPhotos(e){
  e && e.preventDefault();
  document.getElementById('err-step-7').innerText='';
  try{
    for(let i=1;i<=6;i++){ if(!validateStep(i)){ showStep(i); throw 'Validation failed'; } }
    const payload = buildPayload();
    const form = new FormData(); form.append('payload', JSON.stringify(payload));
    // append uploadedPhotos using claves; handle multiple using clave__1, clave__2
    for(const clave in uploadedPhotos){
      const files = uploadedPhotos[clave];
      if(Array.isArray(files)){
        if(files.length>1){
          for(let i=0;i<files.length;i++){
            const key = `${clave}__${i+1}`;
            form.append(key, files[i], files[i].name);
          }
        } else {
          form.append(clave, files[0], files[0].name);
        }
      }
    }
    const btn = document.getElementById('finalGenerate');
    btn.disabled=true; btn.innerText='Generando...';
    const res = await fetch('/generate_docx', { method:'POST', body: form });
    if(!res.ok){ const txt = await res.text(); throw new Error('Error servidor: '+txt); }
    const blob = await res.blob(); const filename = (res.headers.get('Content-Disposition') || '').split('filename=')[1] || 'informe_generado.docx';
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename.replace(/"/g,''); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    btn.disabled=false; btn.innerText='Generar Word ‚Üí'; alert('Informe generado y descargado.');
  } catch(err){ console.error(err); document.getElementById('err-step-7').innerText = 'Error generando el Word: ' + (err.message||err); const btn=document.getElementById('finalGenerate'); if(btn){ btn.disabled=false; btn.innerText='Generar Word ‚Üí'; } }
}

/* Bind top generate/button */
document.getElementById('btnGenerate').addEventListener('click', ()=>{ showStep(7); });
document.getElementById('downloadTemplateBtn').addEventListener('click', ()=>{ alert('La plantilla ahora no se descarga; usa el formulario para generar el informe.'); });

/* Reset */
function resetApp(){ if(!confirm('Reiniciar todos los datos?')) return; generalInfo={}; tanks=[]; accessoriesByTank={}; redes=[]; equipos=[]; actividades={}; uploadedPhotos={}; bloquesFotosCache=[]; document.querySelectorAll('input[type=text], input[type=email], input[type=number], textarea').forEach(i=>i.value=''); document.querySelectorAll('select').forEach(s=>s.value=''); renderTanks(); renderAccList(''); renderRedList(); renderEquiposList(); updateTankSelectOptions(); showStep(1); }

/* Init */
function init(){ updateProgressUI(); renderTanks(); renderRedList(); renderEquiposList(); updateTankSelectOptions(); document.getElementById('finalGenerate').addEventListener('click', generateWordWithPhotos); }
init();
</script>
</body>
</html>
